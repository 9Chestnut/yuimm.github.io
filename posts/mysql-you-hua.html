<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL优化, Yuimm">
    <meta name="description" content="MySQL。---------------------------------------------">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MySQL优化 | Yuimm</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/images/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Yuimm</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/images/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Yuimm</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Yuimm" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Yuimm" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/java.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQL优化</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL/">
                                <span class="chip bg-color">MySQL</span>
                            </a>
                        
                            <a href="/tags/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                <span class="chip bg-color">关系型数据库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/MySQL/" class="post-category">
                                MySQL
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-30
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-04-23
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    46.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    191 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="第-1-章-MySQL-的架构介绍"><a href="#第-1-章-MySQL-的架构介绍" class="headerlink" title="第 1 章 MySQL 的架构介绍"></a>第 1 章 MySQL 的架构介绍</h2><blockquote>
<p><strong>MySQL 高手是怎样练成的？</strong></p>
</blockquote>
<ol>
<li>mysql内核</li>
<li>sql优化工程师</li>
<li>mysql服务器的优化</li>
<li>查询语句优化</li>
<li>主重复制</li>
<li>软硬件升级</li>
<li>容灾备份</li>
<li>sql编程</li>
</ol>
<h3 id="1、Linux-安装-MySQL"><a href="#1、Linux-安装-MySQL" class="headerlink" title="1、Linux 安装 MySQL"></a>1、Linux 安装 MySQL</h3><h4 id="1-1、安装-MySQL"><a href="#1-1、安装-MySQL" class="headerlink" title="1.1、安装 MySQL"></a>1.1、安装 MySQL</h4><p><strong>检查当前系统是否安装过 mysql</strong></p>
<ul>
<li>检查系统是否安装其他版本的 MySQL 数据库</li>
</ul>
<pre><code>yum list installed | grep mysql
mysql-libs.x86_64      5.1.73-5.el6_6   @anaconda-CentOS-201508042137.x86_64/6.7</code></pre><ul>
<li>有的话干掉老版本数据库</li>
</ul>
<pre class=" language-bash"><code class="language-bash">yum -y remove mysql-libs.x86_64</code></pre>
<p><strong>安装及配置</strong></p>
<ul>
<li>拉取 rpm 包</li>
</ul>
<pre><code>wget http://repo.mysql.com/mysql-community-release-el6-5.noarch.rpm</code></pre><ul>
<li>通过 rpm 安装 mysql</li>
</ul>
<pre class=" language-bash"><code class="language-bash">rpm -ivh mysql-community-release-el6-5.noarch.rpm</code></pre>
<ul>
<li>列举可用的 mysql 版本</li>
</ul>
<pre class=" language-bash"><code class="language-bash">yum repolist all <span class="token operator">|</span> <span class="token function">grep</span> mysql</code></pre>
<ul>
<li>安装 mysql-community-server 版本（好像默认自带 mysql-community-client）</li>
</ul>
<pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> mysql-community-server -y</code></pre>
<blockquote>
<p><strong>mysql 服务的启动与停止</strong></p>
</blockquote>
<ul>
<li>mysql 服务的启动</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysqld start</code></pre>
<ul>
<li>mysql 服务的停止</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysqld stop</code></pre>
<ul>
<li>查看 mysql 服务的状态</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysql status</code></pre>
<p><strong>备注：正在启动 mysqld: [失败] 问题</strong></p>
<ul>
<li>打下面这一套组合拳</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -fr /var/lib/mysql/*
<span class="token function">rm</span> /var/lock/subsys/mysqld
<span class="token function">killall</span> mysqld</code></pre>
<ul>
<li>然后启动 mysql 的服务</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysqld start</code></pre>
<h4 id="1-2、配置-MySQL"><a href="#1-2、配置-MySQL" class="headerlink" title="1.2、配置 MySQL"></a>1.2、配置 MySQL</h4><blockquote>
<p><strong>查看安装时创建的 mysql 用户和 mysql 组</strong></p>
</blockquote>
<ul>
<li>查看 mysql 用户</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> /etc/passwd<span class="token operator">|</span><span class="token function">grep</span> mysql</code></pre>
<ul>
<li>查看 mysql 用户组</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> /etc/group<span class="token operator">|</span><span class="token function">grep</span> mysql</code></pre>
<blockquote>
<p><strong>设置远程 root</strong></p>
</blockquote>
<ul>
<li>启动 mysql 服务</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysqld start</code></pre>
<ul>
<li>设置 root 用户密码：这里面会有比较多的选项，按照提示操作即可</li>
</ul>
<pre class=" language-bash"><code class="language-bash">mysql_secure_installation
1</code></pre>
<ul>
<li>登录至 mysql root 账号</li>
</ul>
<pre class=" language-bash"><code class="language-bash">mysql -uroot -p </code></pre>
<blockquote>
<p><strong>设置 mysql 开机启动</strong></p>
</blockquote>
<ul>
<li>设置 mysql 为开机自启动</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">chkconfig</span> mysqld on</code></pre>
<ul>
<li>查看是否设置成功：2、3、4都是on代表开机自动启动</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">chkconfig</span> --list <span class="token operator">|</span> <span class="token function">grep</span> mysqld</code></pre>
<ul>
<li>如果想要关闭 mysql 的开机自启动，输入如下命令，找到 mysqld ，单击空格取消 mysql 的开机自启动，Tab 键选中确定，敲击 Enter 键确定即可</li>
</ul>
<pre class=" language-bash"><code class="language-bash">ntsysv</code></pre>
<blockquote>
<p><strong>修改 mysql 配置文件位置</strong></p>
</blockquote>
<ul>
<li>进入 /usr/share/mysql/ 目录，找到 my-default.cnf 配置文件</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/share/mysql/</code></pre>
<ul>
<li>将其拷贝至 /etc 目录下，重命名为 my.cnf ，覆盖原有的配置文件</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cp</span> /usr/share/mysql/my-default.cnf /etc/my.cnf</code></pre>
<blockquote>
<p><strong>修改 mysql 字符集</strong></p>
</blockquote>
<p><strong>查看 mysql 编码字符集</strong></p>
<ul>
<li>如果在建库建表的时候， 没有明确指定字符集， 则采用默认客户端和服务器端的字符集都用了 latin1 ，其中是不包含中文字符的。</li>
<li>如何查看默认的编码字符集：</li>
</ul>
<pre><code>show variables like '%char%';
# 或者
show variables like '%character%';</code></pre><p><strong>修改配置文件</strong></p>
<ul>
<li>打开 /etc/my.cnf 配置文件，修改字符编码</li>
</ul>
<pre class=" language-bash"><code class="language-bash">vim /etc/my.cnf</code></pre>
<ul>
<li>修改或添加如下内容</li>
</ul>
<pre><code>[client]
default-character-set=utf8

[mysqld]
character_set_server=utf8
character_set_client=utf8
collation-server=utf8_general_ci

[mysql]
default-character-set=utf8</code></pre><p><strong>测试配置文件是否生效</strong></p>
<ul>
<li>建表测试：中文无乱码</li>
</ul>
<pre><code>create database db01;
create table user(id int not null, name varchar(20));
insert into user values(1,'张三1');
select * from user;</code></pre><ul>
<li>查看 mysql 全局变量</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show variables like '%char%';</code></pre>
<blockquote>
<p><strong>mysql 的安装位置</strong></p>
</blockquote>
<ul>
<li>执行命令</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mysql</code></pre>
<ul>
<li>目录含义列举如下</li>
</ul>
<table>
<thead>
<tr>
<th>路径</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td>/var/lib/mysql/</td>
<td align="left">mysql 数据库文件的存放路径</td>
</tr>
<tr>
<td>/usr/share/mysql</td>
<td align="left">配置文件目录</td>
</tr>
<tr>
<td>/usr/bin</td>
<td align="left">相关命令目录</td>
</tr>
<tr>
<td>/etc/init.d/mysql</td>
<td align="left">服务启停相关</td>
</tr>
</tbody></table>
<h3 id="2、MySQL-用户组管理"><a href="#2、MySQL-用户组管理" class="headerlink" title="2、MySQL 用户组管理"></a>2、MySQL 用户组管理</h3><h4 id="2-1、用户管理相关命令"><a href="#2-1、用户管理相关命令" class="headerlink" title="2.1、用户管理相关命令"></a>2.1、用户管理相关命令</h4><blockquote>
<p><strong>创建用户</strong></p>
</blockquote>
<ul>
<li>创建名称为 zhang3 的用户， 密码设为 123123；</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">create user zhang3 identified by '123123';</code></pre>
<blockquote>
<p><strong>查看用和权限的相关信息</strong></p>
</blockquote>
<ul>
<li>查看用和权限的相关信息的 SQL 指令</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">select host, user, password, select_priv, insert_priv,drop_priv from mysql.user;</code></pre>
<p><strong>host :表示连接类型</strong></p>
<ul>
<li><p>% 表示所有远程通过 TCP 方式的连接</p>
</li>
<li><p>IP 地址 如 (192.168.1.2,127.0.0.1) 通过制定 ip 地址进行的 TCP 方式的连接</p>
</li>
<li><p>机器名 通过制定 i 网络中的机器名进行的 TCP 方式的连接</p>
</li>
<li><p>::1 IPv6 的本地 ip 地址 等同于 IPv4 的 127.0.0.1</p>
</li>
<li><p>localhost 本地方式通过命令行方式的连接 ， 比如 <code>mysql -u xxx -p 123xxx</code> 方式的连接。</p>
</li>
</ul>
<p><strong>user:表示用户名</strong></p>
<ul>
<li>同一用户通过不同方式链接的权限是不一样的。</li>
</ul>
<p><strong>password:密码</strong></p>
<ul>
<li>所有密码串通过 password(明文字符串) 生成的密文字符串。 加密算法为 MYSQLSHA1 ， 不可逆 。</li>
<li>mysql 5.7 的密码保存到 authentication_string 字段中不再使用 password 字段。</li>
</ul>
<p><strong>select_priv , insert_priv 等</strong></p>
<ul>
<li>为该用户所拥有的权限。</li>
</ul>
<blockquote>
<p><strong>修改当前用户的密码</strong></p>
</blockquote>
<pre class=" language-mysql"><code class="language-mysql">set password =password('123456');</code></pre>
<blockquote>
<p><strong>修改其他用户的密码</strong></p>
</blockquote>
<ul>
<li>修改李四用户的密码</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">update mysql.user set password=password('123456') where user='li4';</code></pre>
<ul>
<li>注意：所有通过 user 表的修改， 必须 用 <code>flush privileges;</code> 命令才能生 效</li>
</ul>
<blockquote>
<p><strong>修改用户名</strong></p>
</blockquote>
<ul>
<li>将王五的用户名修改为李四</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">update mysql.user set user='li4' where user='wang5';</code></pre>
<ul>
<li>注意：所有通过 user 表的修改， 必须 用 <code>flush privileges;</code> 命令才能生 效</li>
</ul>
<blockquote>
<p><strong>删除用户</strong></p>
</blockquote>
<ul>
<li>删除李四用户</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">drop user li4</code></pre>
<ul>
<li>注意：不要通过 <code>delete from user u where user='li4'</code> 进行删除， 系 统会有残留信息保留。</li>
</ul>
<h4 id="2-2、MySQL-的权限管理"><a href="#2-2、MySQL-的权限管理" class="headerlink" title="2.2、MySQL 的权限管理"></a>2.2、MySQL 的权限管理</h4><blockquote>
<p><strong>授予权限</strong></p>
</blockquote>
<ul>
<li>该权限如果发现没有该用户， 则会直接新建一个用户。</li>
</ul>
<pre><code>grant 权限 1,权限 2,…权限 n on 数据库名称.表名称 to 用户名@用户地址 identified by '连接口令'</code></pre><ul>
<li>示例：给 li4 用户用本地命令行方式下， 授予 atguigudb 这个库下的所有 表的插删改查的权限。</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">grant select,insert,delete,drop on atguigudb.* to li4@localhost ;</code></pre>
<ul>
<li>授予通过网络方式登录的的 joe 用户，对所有库所有表的全部权 限， 密码设为 123</li>
</ul>
<pre><code>grant all privileges on *.* to joe@'%' identified by '123';</code></pre><blockquote>
<p><strong>收回权限</strong></p>
</blockquote>
<ul>
<li>查看当前用户权限：</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show grants;</code></pre>
<ul>
<li>收回权限命令</li>
</ul>
<pre><code>revoke [权限 1,权限 2,…权限 n] on 库名.表名 from 用户名@用户地址;</code></pre><ul>
<li>收回全库全表的所有权限</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">REVOKE ALL PRIVILEGES ON mysql.* FROM joe@localhost;</code></pre>
<ul>
<li>收回 mysql 库下的所有表的插删改查 权限</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">REVOKE select,insert,update,delete ON mysql.* FROM joe@localhost;</code></pre>
<ul>
<li>注意：权限收回后， 必须用户重新登录后， 才能生效。</li>
</ul>
<blockquote>
<p><strong>查看权限</strong></p>
</blockquote>
<ol>
<li>查看当前用户权限：<code>show grants;</code></li>
<li>查看所有用户权限：<code>select * from user ;</code></li>
</ol>
<h3 id="3、MySQL-配置文件"><a href="#3、MySQL-配置文件" class="headerlink" title="3、MySQL 配置文件"></a>3、MySQL 配置文件</h3><blockquote>
<p><strong>二进制日志文件 log-bin</strong></p>
</blockquote>
<p>二进制日志文件 log-bin ：用于主重复制</p>
<blockquote>
<p><strong>错误日志 log-error</strong></p>
</blockquote>
<p>默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等</p>
<blockquote>
<p><strong>查询日志 log</strong></p>
</blockquote>
<p>默认关闭，记录查询的sql语句，如果开启会减低mysql的整体性能，因为记录日志也是需要消耗系统资源的</p>
<blockquote>
<p><strong>数据文件</strong></p>
</blockquote>
<ol>
<li>数据库文件：默认路径：/var/lib/mysql</li>
<li>frm文件：存放表结构</li>
<li>myd文件：存放表数据</li>
<li>myi文件：存放表索引</li>
</ol>
<blockquote>
<p><strong>如何配置</strong></p>
</blockquote>
<ol>
<li>Windows 系统下：my.ini文件</li>
<li>Linux 系统下：etc/my.cnf</li>
</ol>
<h3 id="4、MySQL-逻辑架构介绍"><a href="#4、MySQL-逻辑架构介绍" class="headerlink" title="4、MySQL 逻辑架构介绍"></a>4、MySQL 逻辑架构介绍</h3><blockquote>
<p><strong>mysql 的分层思想</strong></p>
</blockquote>
<ol>
<li>和其它数据库相比，MySQL有点与众不同，它的架构可以在多种不同场景中应用并发挥良好作用。主要体现在存储引擎的架构上。</li>
<li>插件式的存储引擎架构将查询处理和其它的系统任务以及数据的存储提取相分离。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3c67c3e003b7f881f83c88ec20340a84.png" alt="image-20200803205411622"></p>
<blockquote>
<p><strong>mysql 四层架构</strong></p>
</blockquote>
<ol>
<li><p><strong>连接层：</strong>最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p>
</li>
<li><p><strong>服务层：</strong>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。如果是select语句，服务器还会查询内部的缓存。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</p>
<table>
<thead>
<tr>
<th>Management Serveices &amp; Utilities</th>
<th>系统管理和控制工具</th>
</tr>
</thead>
<tbody><tr>
<td>SQL Interface</td>
<td>SQL 接口。 接受用户的 SQL 命令， 并且返回用户需要查询的结果。 比如 select from 就是调用 SQL Interface</td>
</tr>
<tr>
<td>Parser</td>
<td>解析器。 SQL 命令传递到解析器的时候会被解析器验证和解析</td>
</tr>
<tr>
<td>Optimizer</td>
<td>查询优化器。 SQL 语句在查询之前会使用查询优化器对查询进行优化， 比如有 where 条件时， 优化器来决定先投影还是先过滤。</td>
</tr>
<tr>
<td>Cache 和 Buffer</td>
<td>查询缓存。 如果查询缓存有命中的查询结果， 查询语句就可以直接去查询缓存中取 数据。 这个缓存机制是由一系列小缓存组成的。 比如表缓存， 记录缓存， key 缓存， 权限缓存等</td>
</tr>
</tbody></table>
</li>
<li><p><strong>引擎层</strong>：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过APl与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。后面介绍MyISAM和InnoDB</p>
</li>
<li><p><strong>存储层</strong>：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</p>
</li>
</ol>
<blockquote>
<p><strong>MySQL 部件</strong></p>
</blockquote>
<ol>
<li>Connectors：指的是不同语言中与SQL的交互</li>
<li>Management Serveices &amp; Utilities： 系统管理和控制工具</li>
<li>Connection Pool：连接池<ul>
<li>管理缓冲用户连接，线程处理等需要缓存的需求。负责监听对 MySQL Server 的各种请求，接收连接请求，转发所有连接请求到线程管理模块。</li>
<li>每一个连接上 MySQL Server 的客户端请求都会被分配（或创建）一个连接线程为其单独服务。而连接线程的主要工作就是负责 MySQL Server 与客户端的通信。接受客户端的命令请求，传递 Server 端的结果信息等。线程管理模块则负责管理维护这些连接线程。包括线程的创建，线程的 cache 等。</li>
</ul>
</li>
<li>SQL Interface：SQL接口。接受用户的SQL命令，并且返回用户需要查询的结果。比如select from就是调用SQL Interface</li>
<li>Parser：解析器<ul>
<li>SQL命令传递到解析器的时候会被解析器验证和解析。解析器是由Lex和YACC实现的，是一个很长的脚本。</li>
<li>在 MySQL中我们习惯将所有 Client 端发送给 Server 端的命令都称为 Query，在 MySQL Server 里面，连接线程接收到客户端的一个 Query 后，会直接将该 Query 传递给专门负责将各种 Query 进行分类然后转发给各个对应的处理模块。</li>
<li>解析器的主要功能：<ul>
<li>将SQL语句进行语义和语法的分析，分解成数据结构，然后按照不同的操作类型进行分类，然后做出针对性的转发到后续步骤，以后SQL语句的传递和处理就是基于这个结构的。</li>
<li>如果在分解构成中遇到错误，那么就说明这个sql语句是不合理的</li>
</ul>
</li>
</ul>
</li>
<li>Optimizer：查询优化器<ul>
<li>SQL语句在查询之前会使用查询优化器对查询进行优化。就是优化客户端发送过来的 sql 语句 ，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果</li>
<li>他使用的是“选取-投影-联接”策略进行查询。<ul>
<li>用一个例子就可以理解： select uid,name from user where gender = 1;</li>
<li>这个select 查询先根据where 语句进行选取，而不是先将表全部查询出来以后再进行gender过滤</li>
<li>这个select查询先根据uid和name进行属性投影，而不是将属性全部取出以后再进行过滤</li>
<li>将这两个查询条件联接起来生成最终查询结果</li>
</ul>
</li>
</ul>
</li>
<li>Cache和Buffer：查询缓存<ul>
<li>他的主要功能是将客户端提交 给MySQL 的 Select 类 query 请求的返回结果集 cache 到内存中，与该 query 的一个 hash 值 做一个对应。该 Query 所取数据的基表发生任何数据的变化之后， MySQL 会自动使该 query 的Cache 失效。在读写比例非常高的应用系统中， Query Cache 对性能的提高是非常显著的。当然它对内存的消耗也是非常大的。</li>
<li>如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等</li>
</ul>
</li>
<li>存储引擎接口<ul>
<li>存储引擎接口模块可以说是 MySQL 数据库中最有特色的一点了。目前各种数据库产品中，基本上只有 MySQL 可以实现其底层数据存储引擎的插件式管理。这个模块实际上只是 一个抽象类，但正是因为它成功地将各种数据处理高度抽象化，才成就了今天 MySQL 可插拔存储引擎的特色。</li>
<li>从上图还可以看出，MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎。MySQL插件式的存储引擎架构提供了一系列标准的管理和服务支持，这些标准与存储引擎本身无关，可能是每个数据库系统本身都必需的，如SQL分析器和优化器等，而存储引擎是底层物理结构的实现，每个存储引擎开发者都可以按照自己的意愿来进行开发。</li>
<li>注意：存储引擎是基于表的，而不是数据库。</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>SQL 大致的查询流程</strong></p>
</blockquote>
<p><strong>mysql 的查询流程大致是：</strong></p>
<ol>
<li>mysql 客户端通过协议与 mysql 服务器建连接， 发送查询语句， 先检查查询缓存， 如果命中， 直接返回结果，否则进行语句解析,也就是说， 在解析查询之前， 服务器会先访问查询缓存(query cache)——它存储 SELECT 语句以及相应的查询结果集。 如果某个查询结果已经位于缓存中， 服务器就不会再对查询进行解析、 优化、 以及执行。 它仅仅将缓存中的结果返回给用户即可， 这将大大提高系统的性能。</li>
<li>语法解析器和预处理： 首先 mysql 通过关键字将 SQL 语句进行解析， 并生成一颗对应的“解析树”。 mysql 解析器将使用 mysql 语法规则验证和解析查询； 预处理器则根据一些 mysql 规则进一步检查解析数是否合法。</li>
<li>查询优化器当解析树被认为是合法的了， 并且由优化器将其转化成执行计划。 一条查询可以有很多种执行方式，最后都返回相同的结果。 优化器的作用就是找到这其中最好的执行计划。</li>
<li>然后， mysql 默认使用的 BTREE 索引， 并且一个大致方向是：无论怎么折腾 sql， 至少在目前来说， mysql 最多只用到表中的一个索引。</li>
</ol>
<h3 id="5、MySQL-存储引擎"><a href="#5、MySQL-存储引擎" class="headerlink" title="5、MySQL 存储引擎"></a>5、MySQL 存储引擎</h3><blockquote>
<p><strong>查看 mysql 存储引擎</strong></p>
</blockquote>
<ul>
<li>查看 mysql 支持的存储引擎</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show engines;</code></pre>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ad4a7ed2cd88fb7661a35ab3dea81ede.png" alt="image-20200803211155030"></p>
<ul>
<li>查看 mysql 默认的存储引擎</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show variables like '%storage_engine%';</code></pre>
<p><img src="https://img-blog.csdnimg.cn/img_convert/97ce605423dd317fb5a25ca57e346e58.png" alt="image-20200803211257403"></p>
<blockquote>
<p><strong>MyISAM 引擎和 InnoDb 引擎的对比</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fed0966a37ec7ebcec65bb0a9837204c.png" alt="image-20200803211313682"></p>
<blockquote>
<p><strong>阿里巴巴用的是啥数据库？</strong></p>
</blockquote>
<ol>
<li>Percona为MySQL数据库服务器进行了改进，在功能和性能上较MySQL有着很显著的提升。该版本提升了在高负载情况下的InnoDB的性能、为DBA提供一些非常有用的性能诊断工具；另外有更多的参数和命令来控制服务器行为。</li>
<li>该公司新建了一款存储引擎叫xtradb完全可以替代innodb，并且在性能和并发上做得更好，阿里巴巴大部分mysql数据库其实使用的percona的原型加以修改。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/da04cfac6493cec6f502acd817b968f6.png" alt="image-20200803211429418"></p>
<h2 id="第-2-章-SQL语句的执行过程"><a href="#第-2-章-SQL语句的执行过程" class="headerlink" title="第 2 章 SQL语句的执行过程"></a>第 2 章 SQL语句的执行过程</h2><h3 id="2-1、客户端的MySQL驱动："><a href="#2-1、客户端的MySQL驱动：" class="headerlink" title="2.1、客户端的MySQL驱动："></a>2.1、客户端的MySQL驱动：</h3><p>系统在和 MySQL 数据库进行通信前，需要先和数据库建立连接，而这个功能就是由MySQL驱动底层帮我们完成的，建立完连接之后，我们只需要发送 SQL 语句就可以执行 CRUD 了。如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/68dce6f6c9d9e998fe3b10751d278f83.png" alt="img"></p>
<p>一次 SQL 请求就会建立一个连接，多个请求就会建立多个连接。假设我们的系统是部署在 tomcat 容器中的， tomcat 是可以并发处理多个请求的，这就会导致多个请求会去建立多个连接，然后使用完再都去关闭，这样会有什么问题呢？Java系统在通过 MySQL 驱动 和 MySQL 数据库连接的时候是基于 TCP/IP 协议的，所以如果每个请求都是新建连接和销毁连接，这样频繁的创建和销毁连接势必会大大降低我们系统的性能。</p>
<p>为了解决上面的问题，采用了“池化”的思想，通过连接池维护一定数量的连接线程，当需要使用连接时，就直接从线程池中获取，使用完毕之后，再归还给线程池。通过线程池大大减少了不断创建与销毁线程的开销，也不需要我们去关心连接的创建与销毁，以及线程池是怎么去维护这些连接的。常见的数据库连接池有 Druid、C3P0、DBCP。<br><img src="https://img-blog.csdnimg.cn/img_convert/53f7a5fedffa3ebcea78188aeb3d926b.png" alt="img"></p>
<h3 id="2-2、MySql架构的Server层："><a href="#2-2、MySql架构的Server层：" class="headerlink" title="2.2、MySql架构的Server层："></a>2.2、MySql架构的Server层：</h3><p>在介绍MySQL数据库中SQL语句在Server的执行步骤前，我们先了解下MySQL的整体架构：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5b2c927e341c730c33a3ed41eb353691.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3ca1c9259d8a63cc1b8563e8207b1cef.png" alt="img"></p>
<p>通过上面的架构图可以得知，Server层中主要由 连接器、查询缓存、解析器/分析器、优化器、执行器 几部分组成的，下面将主要描述下这几部分。</p>
<h4 id="2-2-1、连接器："><a href="#2-2-1、连接器：" class="headerlink" title="2.2.1、连接器："></a>2.2.<strong>1、连接器：</strong></h4><p>客户端想要对数据库进行操作时，前提是与数据库建立好连接；而连接器就是用来负责跟客户端建立连接、获取权限、维持和管理连接的。</p>
<p>（1）连接方式：</p>
<p>MySQL既支持短连接，也支持长连接。短连接就是操作完毕后，马上close关掉。长连接可以保持打开，减少服务端创建和释放连接的消耗，后续程序访问的时候还可以使用这个连接。</p>
<p>（2）连接池：</p>
<p>与客户端的连接池一样，为了减少频繁创建和销毁连接造成的不必要的性能损失，这里也采用了“池化”的思想，通过数据库连接池去管理连接。<strong>一般我们会在连接池中使用长连接，</strong>例如：druid、c3p0、dbcp等</p>
<h4 id="2-2-2、查询缓存："><a href="#2-2-2、查询缓存：" class="headerlink" title="2.2.2、查询缓存："></a><strong>2.2.2、查询缓存：</strong></h4><p>MySQL缓存是默认关闭的，也就是说不推荐使用缓存，并且在 <strong>MySQL 8.0</strong> 版本直接将查询缓存的整块功能删掉了</p>
<p><strong>（1）MySql为什么默认不开启缓存呢？</strong></p>
<p>主要是由于它的使用场景限制的：</p>
<p>① 先说下缓存中数据存储格式：key（sql语句）- value（数据值），所以如果SQL语句（key）只要存在一点不同之处就会直接进行数据库查询了；</p>
<p>② 由于表中的数据不是一成不变的，大多数是经常变化的，而当数据库中的数据变化了，那么相应的与此表相关的缓存数据就需要移除掉；</p>
<h4 id="2-2-3、分析-解析器："><a href="#2-2-3、分析-解析器：" class="headerlink" title="2.2.3、分析/解析器："></a><strong>2.2.3、分析/解析器：</strong></h4><p>分析器的工作主要是对要执行的SQL语句进行解析，最终得到抽象语法树，然后再使用预处理器判断抽象语法树中的表是否存在，如果存在的话，在接着判断select投影列字段是否在表中存在等。</p>
<p>（1）词法分析：</p>
<p>词法分析用于将SQL拆解为不可再分的原子符号，称为Token。并根据不同数据库方言所提供的字典，将其归类为关键字，表达式，字面量和操作符。</p>
<p>（2）语法分析：</p>
<p>语法分析就是根据词法分析拆解出来的Token（原子符号）将SQL语句转换为抽象语法树。</p>
<p>下面就直接举例说明，看一个SQL它的抽象语法书到底长什么样：</p>
<p><code>SELECT id, name FROM t_user WHERE status = 'ACTIVE' AND age &gt; 18</code></p>
<p>然后上面的SQL语句经过词法分析、语法分析后得到的抽象语法书如下：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/9d18025532f81b98a2096e22c85f8592.png" alt="img"></p>
<blockquote>
<p>注意，为了便于理解，抽象语法树中的关键字的Token用绿色表示，变量的Token用红色表示，灰色表示需要进一步拆分&gt;</p>
</blockquote>
<p>（3）预处理器：</p>
<p>预处理是用来对生成的 <strong>抽象语法树</strong> 进行语义校验，语义校验就是对查询的表、select投影列字段进行校验，判断表、字段是否存在等；</p>
<h4 id="2-2-4、优化器："><a href="#2-2-4、优化器：" class="headerlink" title="2.2.4、优化器："></a>2.2.<strong>4、优化器：</strong></h4><p>优化器的作用主要是将SQL经过词法解析/语法解析后得到的语法树，通过MySQL的数据字典和统计信息的内容，经过<strong>一系列运算</strong> ，最终得出一个<strong>执行计划</strong>，包括选择使用哪个索引。</p>
<p>在优化过程中，经过的一系列运算是什么呢？</p>
<p>（1）逻辑变换：例如SQL的where条件中存在 8&gt;9，那逻辑转换就是将语法树中存在的这种常量表达式直接进行化简，化简为 false；除了化简还有常量表达式计算等。</p>
<p>（2）代价优化：就是通过付出一些数据统计分析的代价，来得到这个SQL执行是否可以走索引，以及走哪些索引；除此之外，在多表关联查询中，确定最终表join的顺序等；</p>
<blockquote>
<p>在分析是否走索引查询时，是通过进行<strong>动态数据采样统计分析</strong>出来；只要是统计分析出来的，那就可能会存在分析错误的情况，所以在SQL执行不走索引时，也要考虑到这方面的因素</p>
</blockquote>
<h4 id="2-2-5、执行器："><a href="#2-2-5、执行器：" class="headerlink" title="2.2.5、执行器："></a>2.2.<strong>5、执行器：</strong></h4><p><code>MySQL 通过分析器知道了你要做什么，通过优化器知道了该怎么做</code>，于是就进入了执行器阶段，开始执行语句。执行器最终就是根据一系列的执行计划去调用存储引擎提供的API接口去调用操作数据，完成SQL的执行。</p>
<blockquote>
<p>开始执行的时候，要先判断一下建立连接的对象对这个表有没有执行操作的权限，如果没有，就会返回没有权限的错误；如果有，就按照生成的执行计划进行执行。</p>
</blockquote>
<h3 id="3、InnoDB存储引擎："><a href="#3、InnoDB存储引擎：" class="headerlink" title="3、InnoDB存储引擎："></a>3、InnoDB存储引擎：</h3><p>存储引擎是对底层物理数据执行实际操作的组件，为Server服务器层提供各种操作数据的 API，数据是被存放在内存或者是磁盘中的。MySQL 支持插件式的存储引擎，包括 InnoDB 、MyISAM、Memory 等。一般情况下，MySQL默认使用的存储引擎是 InnoDB。如下图所示，InnoDB存储引擎整体分为内存架构（Memory Structures）和磁盘架构（Disk Structures）<br><img src="https://img-blog.csdnimg.cn/img_convert/aaeb5d2832328ca62846c8b60fc5518c.png" alt="img"></p>
<h4 id="3-1、Buffer-Pool："><a href="#3-1、Buffer-Pool：" class="headerlink" title="3.1、Buffer Pool："></a>3.1、Buffer Pool：</h4><p>Buffer Pool （缓冲池）是 InnoDB 存储引擎中非常重要的内存结构，类似 Redis 一样的作用，起到一个缓存的作用。MySQL 的数据最终是存储在磁盘中的，如果没有 Buffer Pool，那么每次的数据库请求都会磁盘中查找，这样必然会存在 IO 操作。但是有了 Buffer Pool，只有第一次在查询的时候会将查询的结果存到 Buffer Pool 中，这样后面再有请求的时候就会先从缓冲池中去查询，如果没有再去磁盘中查找，然后在放到 Buffer Pool 中，如下图</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/0459d3fa2f68b760bbea6bba052dabc9.png" alt="image-20210105101150038"></p>
<p><code>UPDATE students SET stuName = '小强' WHERE id = 1</code></p>
<p>比如这条SQL，按照上面的那幅图，SQL 语句的执行步骤大致是这样子的：</p>
<ul>
<li>（1）innodb 存储引擎先在缓冲池中查找 id=1 的这条数据是否存在</li>
<li>（2）如果缓存不存在，那么就去磁盘中加载，并将其存放在缓冲池中</li>
<li>（3）该条记录会被加上一个独占锁</li>
</ul>
<blockquote>
<p><strong>buffer pool 和 查询缓存的区别：</strong></p>
</blockquote>
<p>（1）查询缓存：查询缓存位于Server层，MySQL Server首选会从查询缓存中查看是否曾经执行过这个SQL，如果曾经执行过的话，之前执行的查询结果会以Key-Value的形式保存在查询缓存中。key是SQL语句，value是查询结果。我们将这个过程称为查询缓存！</p>
<p>（2）Buffer Pool位于存储引擎层。Buffer Pool就是MySQL存储引擎为了加速数据的读取速度而设计的缓冲机制</p>
<h4 id="3-2、undo日志文件：记录数据被修改前的样子"><a href="#3-2、undo日志文件：记录数据被修改前的样子" class="headerlink" title="3.2、undo日志文件：记录数据被修改前的样子"></a>3.2、undo日志文件：记录数据被修改前的样子</h4><p>Innodb 存储引擎的最大特点就是支持事务，如果事务提交失败，那么该事务中所有的操作都必须回滚到执行前的样子，而这个回滚的操作，就是利用undo log文件完成的。</p>
<p>undo 顾名思义，就是没有做，没发生的意思。undo log 就是没有发生事情（原本事情是什么）的一些日志</p>
<p>刚才我们介绍过了，在准备更新一条SQL语句的时候，该条语句对应的数据已经被加载到 Buffer pool 中了，实际上这里还有这样的操作，就是在将该条语句加载到 Buffer Pool 中的时候同时会往 undo 日志文件中插入一条日志，也就是将 id=1 的这条记录的原来的值记录下来，便于事务失败后进行回滚<br><img src="https://img-blog.csdnimg.cn/img_convert/e088e86d843c6da12e8fee301dadbfba.png" alt="img"></p>
<p>到这一步，我们执行的 SQL 语句对应的数据已经被加载到 Buffer Pool 中了，然后开始更新这条语句，更新的操作实际是在Buffer Pool中执行的。那问题来了，更新完数据之后，Buffer Pool缓冲池中的中的数据就会和数据库中的数据库不一致，那就是说Buffer Pool 中的数据成了脏数据？没错，目前这条数据就是脏数据，Buffer Pool 中的记录是“小强”数据库中的记录是“旺财” ，这种情况 MySQL是怎么处理的呢？我们接着往下看</p>
<h4 id="3-3、redo日志文件：记录数据被修改后的样子"><a href="#3-3、redo日志文件：记录数据被修改后的样子" class="headerlink" title="3.3、redo日志文件：记录数据被修改后的样子"></a>3.3、redo日志文件：记录数据被修改后的样子</h4><blockquote>
<p>前言：redo 日志文件是 InnoDB 特有的，他是存储引擎级别的，不是 MySQL 级别的</p>
</blockquote>
<p>除了从磁盘中加载文件和将操作前的记录保存到 undo 日志文件中之外，其他的操作是在内存中完成的，内存中的数据的特点就是：断电丢失。如果此时 MySQL 所在的服务器宕机了，那么 Buffer Pool 中的数据会全部丢失的。这个时候 redo 日志文件就需要来大显神通了</p>
<p>redo 就是准备去做、将要去做的意思，redo log 记录的是将要做的一些操作。例如，此时将要做的是update students set stuName=’小强’ where id=1; 那么这条操作就会被记录到 redo log buffer 中，redo log buffer是MySQL 为了提高效率，所以将这些操作都先放在内存中去完成</p>
<blockquote>
<p>这时候假设服务器宕机了，那么缓存中的数据还是丢失了。那能不能不要放在内存中，直接保存到磁盘呢？很显然不行，因为在上面也已经介绍了，在内存中的操作目的是为了提高效率。此时，如果 MySQL 真的宕机了，那么没关系的，因为 MySQL 会认为本次事务是失败的，所以数据依旧是更新前的样子，并不会有任何的影响。</p>
</blockquote>
<p>到了这里，SQL语句也更新好了，那么需要将更新的值提交了，也就是需要提交本次的事务，只要事务成功提交了，才会将最后的变更保存到数据库，在提交事务前会将 redo Log Buffer 中的数据持久化到磁盘中，就是将 redo log buffer 中的数据写入到 redo log 磁盘文件中。</p>
<blockquote>
<p>如果 redo log Buffer 刷入磁盘后，数据库服务器宕机了，那我们更新的数据怎么办？此时数据是在内存中，数据岂不是丢失了？不，这次数据就不会丢失了，因为 redo log buffer 中的数据已经被写入到磁盘了，已经被持久化了，就算数据库宕机了，在下次重启的时候 MySQL 也会将 redo 日志文件内容恢复到 Buffer Pool 中</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/838d99b56623e9c42bf928c3392fa687.png" alt="img"></p>
<p>（1）准备更新一条 SQL 语句</p>
<p>（2）MySQL（innodb）会先去缓冲池（Buffer Pool）中去查找这条数据，没找到就会去磁盘中查找，如果查找到就会将这条数据加载 到缓冲池（Buffer Pool）中</p>
<p>（3）在加载到 Buffer Pool 的同时，会将这条数据的原始记录保存到 undo 日志文件中</p>
<p>（4）innodb 会在 Buffer Pool 中执行更新操作</p>
<p>（5）更新后的数据会记录在 redo log buffer 中</p>
<p>（6）MySQL 提交事务的时候，会将 redo log buffer 中的数据写入到 redo 日志文件中，刷磁盘可以通过 innodb_flush_log_at_trx_commit 参数来设置：</p>
<ul>
<li>0：每秒将 redo log buffer 中的数据将以写入到日志文件中，同时flush到磁盘。在机器crash并重启后，会丢失一秒的事务日志数据</li>
<li>1：每次事务提交时，将 redo log buffer 中的数据写入日志文件，并同时flush到磁盘。在机器crash并重启后，不会丢失事务日志</li>
<li>2：每次事务提交时，将 redo log buffer 中的数据写入日志文件，并每秒flush一次到磁盘。在机器crash并重启后，有可能丢失数据</li>
</ul>
<p>（7）myslq 重启的时候会将 redo 日志恢复到缓冲池中</p>
<h4 id="3-4、bin-log日志文件：记录整个操作过程"><a href="#3-4、bin-log日志文件：记录整个操作过程" class="headerlink" title="3.4、bin log日志文件：记录整个操作过程"></a>3.4、bin log日志文件：记录整个操作过程</h4><blockquote>
<p>前言：bin log和 redo log有些相似，两者的主要区别有：</p>
<p>（1）redo log是 InnoDB 存储引擎特有的日志文件，而bin log属于是 MySQL 级别的日志</p>
<p>（2）redo log适用于崩溃恢复，bin log适用于主从复制和数据恢复</p>
</blockquote>
<p>redo log记录的东西是偏向于物理性质的，如：“对什么数据，做了什么修改”。bin log是偏向于逻辑性质的，类似于：“对 students 表中的 id 为 1 的记录租了更新操作” 。</p>
<p>bin log文件是如何刷入磁盘的? bin log的刷盘策略可以通过sync_bin log来修改，默认为0，表示先写入 os cache，也就是说在提交事务的时候，数据不会直接到磁盘中，这样如果宕机bin log数据仍然会丢失。所以建议将sync_bin log设置为 1 表示直接将数据写入到磁盘文件中。<br>既然bin log也是日志文件，那它是在什么记录数据的呢？其实 MySQL 在提交事务的时候，不仅仅会将 redo log buffer 中的数据写入到redo log 文件中，同时也会将本次修改的数据记录到 bin log文件中，同时会将本次修改的bin log文件名和修改的内容在bin log中的位置记录到redo log中，最后还会在redo log最后写入 commit 标记，这样就表示本次事务被成功的提交了。</p>
<blockquote>
<p>如果在数据被写入到bin log文件的时候，刚写完，数据库宕机了，数据会丢失吗？</p>
<p>首先可以确定的是，只要redo log最后没有 commit 标记，说明本次的事务一定是失败的。但是数据是没有丢失了，因为已经被记录到redo log的磁盘文件中了。在 MySQL 重启的时候，就会将 redo log 中的数据恢复（加载）到Buffer Pool中。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b00fed56cdec55b7b4a0070b6feb4aef.png" alt="img"></p>
<p>到目前为止，一个更新操作我们基本介绍得差不多，但是你有没有感觉少了哪件事情还没有做？是不是你也发现这个时候被更新记录仅仅是在内存中执行的，哪怕是宕机又恢复了也仅仅是将更新后的记录加载到Buffer Pool中，这个时候 MySQL 数据库中的这条记录依旧是旧值，也就是说内存中的数据在我们看来依旧是脏数据，那这个时候怎么办呢？</p>
<p>其实 MySQL 会有一个后台线程，它会在某个时机将我们Buffer Pool中的脏数据刷到 MySQL 数据库中，这样就将内存和数据库的数据保持统一了。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/08379beec752e3a8f37e808a7368479e.png" alt="img"></p>
<h3 id="4、小结："><a href="#4、小结：" class="headerlink" title="4、小结："></a>4、小结：</h3><p>（1）首先MySQL执行器根据 执行计划 调用存储引擎的API查询数据<br>（2）存储引擎先从缓存池buffer pool中查询数据，如果没有就会去磁盘中查询，如果查询到了就将其放到缓存池中<br>（3）在数据加载到 Buffer Pool 的同时，会将这条数据的原始记录保存到 undo 日志文件中<br>（4）innodb 会在 Buffer Pool 中执行更新操作<br>（5）更新后的数据会记录在 redo log buffer 中<br>（6）提交事务在提交的同时会做以下三件事<br>（7）（第一件事）将redo log buffer中的数据刷入到redo log文件中<br>（8）（第二件事）将本次操作记录写入到 bin log文件中<br>（9）（第三件事）将bin log文件名字和更新内容在 bin log 中的位置记录到redo log中，同时在 redo log 最后添加 commit 标记<br>（10）使用一个后台线程，它会在某个时机将我们Buffer Pool中的更新后的数据刷到 MySQL 数据库中，这样就将内存和数据库的数据保</p>
<h2 id="第-3-章-索引优化分析"><a href="#第-3-章-索引优化分析" class="headerlink" title="第 3 章 索引优化分析"></a>第 3 章 索引优化分析</h2><h3 id="1、慢-SQL"><a href="#1、慢-SQL" class="headerlink" title="1、慢 SQL"></a>1、慢 SQL</h3><blockquote>
<p><strong>性能下降、 SQL 慢、执行时间长、等待时间长的原因分析</strong></p>
</blockquote>
<ol>
<li>查询语句写的烂</li>
<li>索引失效：<ul>
<li>单值索引：在user表中给name属性建个索引，create index idx_user_name on user(name)</li>
<li>复合索引：在user表中给name、email属性建个索引，create index idx_user_nameEmail on user(name,email)</li>
</ul>
</li>
<li>关联查询太多join(设计缺陷或不得已的需求)</li>
<li>服务器调优及各个参数设置(缓冲、线程数等)</li>
</ol>
<h3 id="2、join-查询"><a href="#2、join-查询" class="headerlink" title="2、join 查询"></a>2、join 查询</h3><h4 id="2-1、SQL-执行顺序"><a href="#2-1、SQL-执行顺序" class="headerlink" title="2.1、SQL 执行顺序"></a>2.1、SQL 执行顺序</h4><blockquote>
<p><strong>我们手写的 SQL 顺序</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6f63313638288480abfa89c49ecf6ae0.png" alt="image-20200803212731183"></p>
<blockquote>
<p><strong>MySQL 实际执行 SQL 顺序</strong></p>
</blockquote>
<ol>
<li>mysql 执行的顺序：随着 Mysql 版本的更新换代， 其优化器也在不断的升级， 优化器会分析不同执行顺序产生的性能消耗不同而动态调整执行顺序。</li>
<li>下面是经常出现的查询顺序：</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/bf19cf6a81b9d6d46f0bb78cccd35238.png" alt="image-20200803212826429"></p>
<ul>
<li>总结：mysql 从 FROM 开始执行~</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/292e157cd8d0efd2570d8c2c93284da4.png" alt="image-20200803212936111"></p>
<h4 id="2-2、JOIN-连接查询"><a href="#2-2、JOIN-连接查询" class="headerlink" title="2.2、JOIN 连接查询"></a>2.2、JOIN 连接查询</h4><blockquote>
<p><strong>常见的 JOIN 查询图</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/2060feedc52769bca0af01c91711d217.png" alt="image-20200803213106434"></p>
<blockquote>
<p><strong>建表 SQL</strong></p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tbl_dept<span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    deptName <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    locAdd <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tbl_emp <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    deptId <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> fk_dept_Id <span class="token punctuation">(</span>deptId<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#CONSTRAINT 'fk_dept_Id' foreign key ('deptId') references 'tbl_dept'('Id')</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>locAdd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'RD'</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>locAdd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'HR'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>locAdd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'MK'</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>locAdd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'MIS'</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>locAdd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'FD'</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'z3'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'z4'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'z5'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'w5'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'w6'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'s7'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'s8'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>deptId<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'s9'</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>7 种 JOIN 示例</strong></p>
</blockquote>
<p><strong>笛卡尔积</strong></p>
<ol>
<li>tbl_emp 表和 tbl_dept 表的笛卡尔乘积：<code>select * from tbl_emp, tbl_dept;</code></li>
<li>其结果集的个数为：5 * 8 = 40</li>
</ol>
<p><strong>inner join</strong></p>
<ol>
<li>tbl_emp 表和 tbl_dept 的交集部分（公共部分）</li>
<li><code>select * from tbl_emp e inner join tbl_dept d on e.deptId = d.id;</code></li>
</ol>
<pre><code>mysql&gt; select * from tbl_emp e inner join tbl_dept d on e.deptId = d.id;
+----+------+--------+----+----------+--------+
| id | NAME | deptId | id | deptName | locAdd |
+----+------+--------+----+----------+--------+
|  1 | z3   |      1 |  1 | RD       | 11     |
|  2 | z4   |      1 |  1 | RD       | 11     |
|  3 | z5   |      1 |  1 | RD       | 11     |
|  4 | w5   |      2 |  2 | HR       | 12     |
|  5 | w6   |      2 |  2 | HR       | 12     |
|  6 | s7   |      3 |  3 | MK       | 13     |
|  7 | s8   |      4 |  4 | MIS      | 14     |
+----+------+--------+----+----------+--------+
7 rows in set (0.00 sec)</code></pre><p><strong>left join</strong></p>
<ol>
<li><p>tbl_emp 与 tbl_dept 的公共部分 + tbl_emp 表的独有部分</p>
</li>
<li><p>left join：取左表独有部分 + 两表公共部分</p>
</li>
<li><p><code>select * from tbl_emp e left join tbl_dept d on e.deptId = d.id;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e left join tbl_dept d on e.deptId = d.id;
+----+------+--------+------+----------+--------+
| id | NAME | deptId | id   | deptName | locAdd |
+----+------+--------+------+----------+--------+
|  1 | z3   |      1 |    1 | RD       | 11     |
|  2 | z4   |      1 |    1 | RD       | 11     |
|  3 | z5   |      1 |    1 | RD       | 11     |
|  4 | w5   |      2 |    2 | HR       | 12     |
|  5 | w6   |      2 |    2 | HR       | 12     |
|  6 | s7   |      3 |    3 | MK       | 13     |
|  7 | s8   |      4 |    4 | MIS      | 14     |
|  8 | s9   |     51 | NULL | NULL     | NULL   |
+----+------+--------+------+----------+--------+
8 rows in set (0.00 sec)</code></pre><p><strong>right join</strong></p>
<ol>
<li><p>tbl_emp 与 tbl_dept 的公共部分 + tbl_dept表的独有部分</p>
</li>
<li><p>right join：取右表独有部分 + 两表公共部分</p>
</li>
<li><p><code>select * from tbl_emp e right join tbl_dept d on e.deptId = d.id;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e right join tbl_dept d on e.deptId = d.id;
+------+------+--------+----+----------+--------+
| id   | NAME | deptId | id | deptName | locAdd |
+------+------+--------+----+----------+--------+
|    1 | z3   |      1 |  1 | RD       | 11     |
|    2 | z4   |      1 |  1 | RD       | 11     |
|    3 | z5   |      1 |  1 | RD       | 11     |
|    4 | w5   |      2 |  2 | HR       | 12     |
|    5 | w6   |      2 |  2 | HR       | 12     |
|    6 | s7   |      3 |  3 | MK       | 13     |
|    7 | s8   |      4 |  4 | MIS      | 14     |
| NULL | NULL |   NULL |  5 | FD       | 15     |
+------+------+--------+----+----------+--------+
8 rows in set (0.00 sec)</code></pre></li>
</ol>
<p><strong>left join without common part</strong></p>
<ol>
<li><p>tbl_emp 表的独有部分：将 left join 结果集中的两表公共部分去掉即可：where d.id is null</p>
</li>
<li><p><code>select * from tbl_emp e left join tbl_dept d on e.deptId = d.id where d.id is null;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e left join tbl_dept d on e.deptId = d.id where d.id is null;
+----+------+--------+------+----------+--------+
| id | NAME | deptId | id   | deptName | locAdd |
+----+------+--------+------+----------+--------+
|  8 | s9   |     51 | NULL | NULL     | NULL   |
+----+------+--------+------+----------+--------+
1 row in set (0.00 sec)</code></pre></li>
</ol>
<p><strong>right join without common part</strong></p>
<ol>
<li><p>tbl_dept表的独有部分：将 right join 结果集中的两表公共部分去掉即可：<code>where e.id is null</code></p>
</li>
<li><p><code>select * from tbl_emp e right join tbl_dept d on e.deptId = d.id where e.id is null;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e right join tbl_dept d on e.deptId = d.id where e.id is null;
+------+------+--------+----+----------+--------+
| id   | NAME | deptId | id | deptName | locAdd |
+------+------+--------+----+----------+--------+
| NULL | NULL |   NULL |  5 | FD       | 15     |
+------+------+--------+----+----------+--------+
1 row in set (0.00 sec)</code></pre></li>
</ol>
<p><strong>full join</strong></p>
<ol>
<li><p>兄弟，mysql 不支持 full join ，但是我们可以通过骚操作实现 full join ，union 关键字用于连接结果集，并且自动去重</p>
</li>
<li><p>tbl_emp 与 tbl_dept 的公共部分 + tbl_emp 表的独有部分 + tbl_dept表的独有部分：将 left join 的结果集和 right join 的结果集使用 union 合并即可</p>
</li>
<li><p><code>select * from tbl_emp e left join tbl_dept d on e.deptId = d.id union select * from tbl_emp e right join tbl_dept d on e.deptId = d.id;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e left join tbl_dept d on e.deptId = d.id
    -&gt; union
    -&gt; select * from tbl_emp e right join tbl_dept d on e.deptId = d.id;
+------+------+--------+------+----------+--------+
| id   | NAME | deptId | id   | deptName | locAdd |
+------+------+--------+------+----------+--------+
|    1 | z3   |      1 |    1 | RD       | 11     |
|    2 | z4   |      1 |    1 | RD       | 11     |
|    3 | z5   |      1 |    1 | RD       | 11     |
|    4 | w5   |      2 |    2 | HR       | 12     |
|    5 | w6   |      2 |    2 | HR       | 12     |
|    6 | s7   |      3 |    3 | MK       | 13     |
|    7 | s8   |      4 |    4 | MIS      | 14     |
|    8 | s9   |     51 | NULL | NULL     | NULL   |
| NULL | NULL |   NULL |    5 | FD       | 15     |
+------+------+--------+------+----------+--------+
9 rows in set (0.00 sec)</code></pre></li>
</ol>
<p><strong>full join without common part</strong></p>
<ol>
<li><p>tbl_emp 表的独有部分 + tbl_dept表的独有部分</p>
</li>
<li><p><code>select * from tbl_emp e left join tbl_dept d on e.deptId = d.id where d.id is null union select * from tbl_emp e right join tbl_dept d on e.deptId = d.id where e.id is null;</code></p>
<pre><code>mysql&gt; select * from tbl_emp e left join tbl_dept d on e.deptId = d.id where d.id is null
    -&gt; union
    -&gt; select * from tbl_emp e right join tbl_dept d on e.deptId = d.id where e.id is null;
+------+------+--------+------+----------+--------+
| id   | NAME | deptId | id   | deptName | locAdd |
+------+------+--------+------+----------+--------+
|    8 | s9   |     51 | NULL | NULL     | NULL   |
| NULL | NULL |   NULL |    5 | FD       | 15     |
+------+------+--------+------+----------+--------+
2 rows in set (0.00 sec)</code></pre></li>
</ol>
</li>
</ol>
<h3 id="3、索引简介"><a href="#3、索引简介" class="headerlink" title="3、索引简介"></a>3、索引简介</h3><h4 id="3-1、索引是什么"><a href="#3-1、索引是什么" class="headerlink" title="3.1、索引是什么"></a>3.1、索引是什么</h4><blockquote>
<p><strong>索引是个什么东东？</strong></p>
</blockquote>
<ol>
<li>MySQL官方对索引的定义为：索引(Index)是帮助MySQL高效获取数据的数据结构。可以得到索引的本质：<strong>索引是数据结构</strong></li>
<li>你可以简单理解为”<strong>排好序的快速查找数据结构</strong>“，即<strong>索引 = 排序 + 查找</strong></li>
<li>一般来说索引本身占用内存空间也很大，不可能全部存储在内存中，因此<strong>索引往往以文件形式存储在硬盘上</strong></li>
<li>我们平时所说的索引，如果没有特别指明，都是指B树(多路搜索树，并不一定是二叉树)结构组织的索引。</li>
<li>聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈希索引(hash index)等。</li>
</ol>
<h4 id="3-2、索引原理"><a href="#3-2、索引原理" class="headerlink" title="3.2、索引原理"></a>3.2、索引原理</h4><blockquote>
<p><strong>将索引理解为”排好序的快速查找数据结构”</strong></p>
</blockquote>
<ol>
<li>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构<strong>以某种方式引用（指向）数据</strong>，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。 </li>
<li>下图就是一种可能的索引方式示例：<ul>
<li>左边是数据表，一共有两列七条记录，最左边的十六进制数字是数据记录的物理地址</li>
<li>为了加快col2的查找，可以维护一个右边所示的二叉查找树，<strong>每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针</strong>，这样就可以运用二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录。</li>
</ul>
</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b258fbc51e43460fc2bfaaa1d31fe426.png" alt="image-20200803222848380"></p>
<blockquote>
<p>MyISAM索引的实现：</p>
</blockquote>
<p>（1）主键索引：MyISAM引擎使用B+Tree作为索引结构，叶子节点的data域存放的是数据记录的地址。下图是MyISAM索引的原理图：</p>
<p><img src="https://img-blog.csdnimg.cn/20181123230136209.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3NDUyMzM3MDA=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>这里设表一共有三列，假设我们以Col1为主键，则上图是一个MyISAM表的主键索引（Primary key）示意。<code>可以看出MyISAM的索引文件仅仅保存数据记录的地址。</code></p>
<p>（2）辅助索引：</p>
<p>在MyISAM中，主键索引和辅助索引在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。如果我们在Col2上建立一个辅助索引，则此索引的结构如下图所示： </p>
<p><img src="https://img-blog.csdnimg.cn/2018112323034827.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3NDUyMzM3MDA=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>同样也是一棵B+Tree，data域保存数据记录的地址。</p>
<p>因此，MyISAM中索引检索的算法为首先按照B+Tree搜索算法搜索索引，如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录。</p>
<p><code>MyISAM的索引方式也叫做“非聚集”的，之所以这么称呼是为了与InnoDB的聚集索引区分。</code></p>
<blockquote>
<p><strong>InnoDB索引的实现：</strong></p>
</blockquote>
<p>虽然InnoDB也使用B+Tree作为索引结构，但具体实现方式与MyISAM却不相同。</p>
<p>（1）主键索引：</p>
<p>与MyISAM第一个重大区别是InnoDB的数据文件本身就是索引文件。从上文知道，MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而<code>在InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录</code>。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引。</p>
<p><img src="https://img-blog.csdnimg.cn/20181123231121997.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E3NDUyMzM3MDA=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>上图是InnoDB主索引（同时也是数据文件）的示意图，可以看到叶节点包含了完整的数据记录。这种索引叫做聚集索引，<code>因为InnoDB的数据文件本身要按主键聚集，所以InnoDB要求表必须有主键（MyISAM可以没有）</code>，如果没有显式指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整形。）辅助索引：</p>
<p>第二个与MyISAM索引的不同是InnoDB的辅助索引data域存储相应记录主键的值而不是地址。换句话说，InnoDB的所有辅助索引都引用主键作为data域。例如，下图为定义在Col3上的一个辅助索引：</p>
<p>这里以英文字符的ASCII码作为比较准则。聚集索引这种实现方式使得按主键的搜索十分高效，<code>但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录</code>。不过由于辅助索引会包含主键列，所以，如果主键使用过长的字段，将会导致其他辅助索变得更大。所以争取尽量把主键定义得小一些。</p>
<p><code>InnoDB 表是基于聚簇索引建立的。</code></p>
<h4 id="3-3、索引优劣势"><a href="#3-3、索引优劣势" class="headerlink" title="3.3、索引优劣势"></a>3.3、索引优劣势</h4><blockquote>
<p><strong>索引的优势</strong></p>
</blockquote>
<ol>
<li>类似大学图书馆的书目索引，提高数据检索效率，<strong>降低数据库的IO成本</strong></li>
<li>通过索引列对数据进行排序，<strong>降低数据排序成本</strong>，降低了CPU的消耗</li>
</ol>
<blockquote>
<p><strong>索引的劣势</strong></p>
</blockquote>
<ol>
<li>实际上索引也是一张表，该表保存了主键和索引字段，并指向实体表的记录，所以索引列也是要占用空间的</li>
<li>虽然索引大大提高了查询速度，<strong>同时却会降低更新表的速度</strong>，如果对表INSERT，UPDATE和DELETE。因为更新表时，MySQL不仅要不存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</li>
<li>索引只是提高效率的一个因素，如果你的MySQL有大数据量的表，就需要花时间研究建立优秀的索引，或优化查询语句</li>
</ol>
<h4 id="3-4、MySQL-索引分类"><a href="#3-4、MySQL-索引分类" class="headerlink" title="3.4、MySQL 索引分类"></a>3.4、MySQL 索引分类</h4><blockquote>
<p><strong>mysql 索引分类</strong></p>
</blockquote>
<p>参考资料：<a href="https://www.cnblogs.com/luyucheng/p/6289714.html" target="_blank" rel="noopener">https://www.cnblogs.com/luyucheng/p/6289714.html</a></p>
<ol>
<li><p><strong>普通索引：</strong>是最基本的索引，它没有任何限制，即一个索引只包含单个列，一个表可以有多个单列索引；建议一张表索引不要超过5个，优先考虑复合索引</p>
</li>
<li><p><strong>唯一索引：</strong>与前面的普通索引类似，不同的就是：索引列的值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一</p>
</li>
<li><p><strong>主键索引：</strong>是一种特殊的唯一索引，一个表只能有一个主键，不允许有空值。一般是在建表的时候同时创建主键索引：</p>
</li>
<li><p><strong>复合索引：</strong>指多个字段上创建的索引，只有在查询条件中使用了创建索引时的第一个字段，索引才会被使用。<code>使用组合索引时遵循最左前缀集合</code></p>
</li>
<li><p><strong>全文索引：</strong>主要用来查找文本中的关键字，而不是直接与索引中的值相比较。fulltext索引跟其它索引大不相同，它更像是一个搜索引擎，而不是简单的where语句的参数匹配</p>
<p>全文索引仅可用于 MyISAM 表，并只支持从CHAR、VARCHAR或TEXT类型，用于替代效率较低的like 模糊匹配操作，而且可以通过多字段组合的全文索引一次性全模糊匹配多个字段。对于大容量的数据表，生成全文索引是一个非常消耗时间和硬盘空间的做法。对于较大的数据集，将你的数据输入一个没有FULLTEXT索引的表中，然后创建索引，其速度比把数据输入现有FULLTEXT索引的速度更为快。</p>
<blockquote>
<p>聚簇索引与非聚簇索引</p>
</blockquote>
<p>如果按照表中 数据存储的物理顺序与索引值的顺序分类，可以将索引分为聚簇索引与非聚簇索引两类。</p>
<p><strong>1、聚簇索引（cluster）：</strong></p>
<p>聚簇索引要求表中数据存储的物理顺序与索引值的顺序一致，一个基本表最多只能有一个聚簇索引，更新聚簇索引列上的数据时，往往导致表中记录的物理顺序的变更，代价较大，因此对于经常更新的列不宜建立聚簇索引</p>
<pre><code>聚簇索引一般在下面场景使用：

（1）主键列，InnoDB存储引擎中，默认为表的主键建立一个聚簇索引。

（2）按范围存取的列或者在group by或order by中使用的列。在聚簇索引下，因为表中数据存储的物理顺序与索引的逻辑顺序一致，所以在包含范围检查(between、&lt;、&lt;=、&gt;、&gt;=)或使用group by或order by的查询时，一旦找到具有范围中第一个键值的行，具有后续索引值的行保证物理上毗连在一起而不必进一步搜索，避免了大范围扫描，可以大大提高查询速度。

（3）在连接操作中使用的列。

（4）不经常修改的列。因为码值修改后，数据行必须移动到新的位置。</code></pre><p><strong>2、非聚簇索引：</strong></p>
<p>表中记录的物理顺序与索引值的顺序不一致的索引组织，一个基本表可以有多个聚簇索引。</p>
</li>
</ol>
<h4 id="3-5、MySQL-索引语法"><a href="#3-5、MySQL-索引语法" class="headerlink" title="3.5、MySQL 索引语法"></a>3.5、MySQL 索引语法</h4><blockquote>
<p><strong>建立索引的 SQL 语句</strong></p>
</blockquote>
<p>创建索引：</p>
<ul>
<li>如果是CHAR和VARCHAR类型，length可以小于字段实际长度；</li>
<li>如果是BLOB和TEXT类型，必须指定length。</li>
</ul>
<pre><code>CREATE [UNIQUE] INDEX  indexName ON mytable(columnname(length));
' or '
ALTER mytable ADD [UNIQUE]  INDEX [indexName] ON(columnname(length));</code></pre><p>删除索引</p>
<pre class=" language-mysql"><code class="language-mysql">DROP INDEX [indexName] ON mytable;</code></pre>
<p>查看索引（<code>\G</code>表示将查询到的横向表格纵向输出，方便阅读）</p>
<pre class=" language-mysql"><code class="language-mysql">SHOW INDEX FROM table_name\G</code></pre>
<p><strong>使用 ALTER 命令，有四种方式来添加数据表的索引：</strong></p>
<ol>
<li><code>ALTER TABLE tbl_name ADD PRIMA RY KEY(column_list)</code>：该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL。</li>
<li><code>ALTER TABLE tbl_name ADD UNIQUE index_name(column_list)</code>：这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）。</li>
<li><code>ALTER TABLE tbl_name ADD INDEX index_name(column_list)</code>：.添加普通索引，索引值可出现多次。</li>
<li><code>ALTER TABLE tbl_name ADD FULLTEXT index_name(column_list)</code>：该语句指定了索引为FULLTEXT，用于全文索引。</li>
</ol>
<p><strong>带你看看 mysql 索引：Index_type 为 BTREE</strong></p>
<pre><code>mysql&gt; show index from tbl_emp;
+---------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name   | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| tbl_emp |          0 | PRIMARY    |            1 | id          | A         |           8 |     NULL | NULL   |      | BTREE      |         |               |
| tbl_emp |          1 | fk_dept_Id |            1 | deptId      | A         |           8 |     NULL | NULL   | YES  | BTREE      |         |               |
+---------+------------+------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
2 rows in set (0.00 sec)</code></pre><h4 id="3-6、MySQL-索引结构"><a href="#3-6、MySQL-索引结构" class="headerlink" title="3.6、MySQL 索引结构"></a>3.6、MySQL 索引结构</h4><p>般来说，索引本身也很大，不可能全部存储在内存中，<strong>因此索引往往以索引文件的形式存储在磁盘上</strong>。这样的话，索引查找过程中就要产生磁盘I/O消耗，相对于内存存取，I/O存取的消耗要高几个数量级，所以评价一个数据结构作为索引的优劣最重要的指标就是在查找过程中磁盘I/O操作次数的渐进复杂度。换句话说，索引的数据结构要尽量减少查找过程中磁盘I/O的存取次数。</p>
<p><strong>局部性原理与磁盘预读：</strong></p>
<p>由于存储介质的特性，磁盘本身存取就比主存慢很多，再加上机械运动耗费，磁盘的存取速度往往是主存的几百分之一，因此为了提高效率，要尽量减少磁盘I/O。为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。这样做的理论依据是计算机科学中著名的局部性原理：当一个数据被用到时，其附近的数据也通常会马上被使用。程序运行期间所需要的数据通常比较集中。</p>
<p>由于磁盘顺序读取的效率很高（不需要寻道时间，只需很少的旋转时间），因此对于具有局部性的程序来说，预读可以提高I/O效率。预读的长度一般为页的整倍数。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。</p>
<h5 id="3-6-1、Btree-索引"><a href="#3-6-1、Btree-索引" class="headerlink" title="3.6.1、Btree 索引"></a>3.6.1、Btree 索引</h5><blockquote>
<p><strong>Btree 索引搜索过程</strong></p>
</blockquote>
<p>【初始化介绍】</p>
<ol>
<li>一颗 b 树， <strong>浅蓝色的块我们称之为一个磁盘块</strong>， 可以看到每个磁盘块包含几个<strong>数据项（深蓝色所示） 和指针（黄色所示）</strong></li>
<li>如磁盘块 1 包含数据项 17 和 35， 包含指针 P1、 P2、 P3</li>
<li>P1 表示小于 17 的磁盘块， P2 表示在 17 和 35 之间的磁盘块， P3 表示大于 35 的磁盘块</li>
<li><strong>真实的数据存在于叶子节点和非叶子节点中</strong></li>
</ol>
<p>【查找过程】</p>
<ol>
<li>如果要查找数据项 29， 那么首先会把磁盘块 1 由磁盘加载到内存， 此时发生一次 IO， 在内存中用二分查找确定 29在 17 和 35 之间， 锁定磁盘块 1 的 P2 指针， 内存时间因为非常短（相比磁盘的 IO） 可以忽略不计</li>
<li>通过磁盘块 1的 P2 指针的磁盘地址把磁盘块 3 由磁盘加载到内存， 发生第二次 IO， 29 在 26 和 30 之间， 锁定磁盘块 3 的 P2 指针</li>
<li>通过指针加载磁盘块 8 到内存， 发生第三次 IO， 同时内存中做二分查找找到 29， 结束查询， 总计三次 IO。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e4942aa1472d9d720bd14b12c1561965.png" alt="image-20200804093236612"></p>
<h5 id="3-6-2、B-tree-索引"><a href="#3-6-2、B-tree-索引" class="headerlink" title="3.6.2、B+tree 索引"></a>3.6.2、B+tree 索引</h5><blockquote>
<p><strong>B+tree 索引搜索过程</strong></p>
</blockquote>
<p><strong>【B+Tree 与 BTree 的区别】</strong></p>
<p>B-树的关键字（数据项）和记录是放在一起的； B+树的非叶子节点中只有关键字和指向下一个节点的索引， 记录只放在叶子节点中。</p>
<p><strong>【B+Tree 与 BTree 的查找过程】</strong></p>
<ol>
<li>在 B 树中， 越靠近根节点的记录查找时间越快， 只要找到关键字即可确定记录的存在； 而 B+ 树中每个记录的查找时间基本是一样的， 都需要从根节点走到叶子节点， 而且在叶子节点中还要再比较关键字。</li>
<li>从这个角度看 B 树的性能好像要比 B+ 树好， 而在实际应用中却是 B+ 树的性能要好些。 因为 B+ 树的非叶子节点不存放实际的数据，这样每个节点可容纳的元素个数比 B 树多， 树高比 B 树小， 这样带来的好处是减少磁盘访问次数。</li>
<li>尽管 B+ 树找到一个记录所需的比较次数要比 B 树多， 但是一次磁盘访问的时间相当于成百上千次内存比较的时间， 因此实际中B+ 树的性能可能还会好些， 而且 B+树的叶子节点使用指针连接在一起， 方便顺序遍历（范围搜索）， 这也是很多数据库和文件系统使用 B+树的缘故。</li>
</ol>
<p><strong>【性能提升】</strong></p>
<p>真实的情况是， 3 层的 B+ 树可以表示上百万的数据， 如果上百万的数据查找只需要三次 IO， 性能提高将是巨大的，如果没有索引， 每个数据项都要发生一次 IO， 那么总共需要百万次的 IO， 显然成本非常非常高。</p>
<p><strong>【思考： 为什么说 B+树比 B-树更适合实际应用中操作系统的文件索引和数据库索引？】</strong></p>
<ol>
<li>B+树的磁盘读写代价更低：B+树的内部结点并没有指向关键字具体信息的指针。 因此其内部结点相对 B 树更小。 如果把所有同一内部结点的关键字存放在同一盘块中， 那么盘块所能容纳的关键字数量也越多。 一次性读入内存中的需要查找的关键字也就越多。 相对来说 IO 读写次数也就降低了。</li>
<li>B+树的查询效率更加稳定：由于非终结点并不是最终指向文件内容的结点， 而只是叶子结点中关键字的索引。 所以任何关键字的查找必须走一条从根结点到叶子结点的路。 所有关键字查询的路径长度相同， 导致每一个数据的查询效率相当。</li>
<li>B+树有利于对数据库的扫描：B树在提高了磁盘IO性能的同时并没有解决元素遍历的效率低下的问题，而B+树只需要遍历叶子节点就可以解决对全部关键字信息的扫描，所以范围查询、排序等操作，B+树有着更高的性能。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7f5ea19eb42404dd4437667bfc29dd84.png" alt="image-20200811145838930"></p>
<h5 id="3-6-3、Hash索引："><a href="#3-6-3、Hash索引：" class="headerlink" title="3.6.3、Hash索引："></a>3.6.3、<strong>Hash索引：</strong></h5><p>MySQL中，只有Memory存储引擎支持hash索引，是Memory表的默认索引类型。hash索引把数据以hash值形式组织起来，因此检索效率非常高，可以一次定位。</p>
<pre><code>hash索引的缺点：

（1）Hash索引仅能满足等值的查询，不能满足范围查询、排序。因为数据在经过Hash算法后，其大小关系就可能发生变化。

（2）当创建组合索引时，不能只适用组合索引的部分列进行查询。因为hash索引是把多个列数据合并后再计算Hash值，所以对单独列数据计算Hash值是没有意义的。

（3）当发生Hash碰撞时，Hash索引不能避免表数据的扫描。因为仅仅比较Hash值是不够的，需要比较实际的值以判定是否符合要求。</code></pre><h4 id="3-7、何时需要建索引"><a href="#3-7、何时需要建索引" class="headerlink" title="3.7、何时需要建索引"></a>3.7、何时需要建索引</h4><blockquote>
<p><strong>哪些情况下适合建立索引</strong></p>
</blockquote>
<ol>
<li><strong>主键自动建立唯一索引</strong></li>
<li><strong>频繁作为查询的条件的字段</strong>应该创建索引</li>
<li><strong>查询中与其他表关联的字段</strong>，外键关系建立索引</li>
<li>频繁更新的字段不适合创建索引</li>
<li>Where 条件里用不到的字段不创建索引</li>
<li>单间/组合索引的选择问题，Who？（在高并发下倾向创建组合索引）</li>
<li><strong>查询中排序的字段</strong>，排序字段若通过索引去访问将大大提高排序的速度</li>
<li><strong>查询中统计或者分组字段</strong></li>
</ol>
<blockquote>
<p><strong>哪些情况不要创建索引</strong></p>
</blockquote>
<ol>
<li>表记录太少</li>
<li><strong>经常增删改的表</strong></li>
<li><strong>数据重复且分布平均的表字段</strong>，因此应该只为经常查询和经常排序的数据列建立索引。注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。</li>
</ol>
<p><strong>案例分析：</strong></p>
<ol>
<li>假如一个表有10万行记录，有一个字段A只有T和F两种值，且每个值的分布概率大约为50%，那么对这种表A字段建索引一般不会提高数据库的查询速度。</li>
<li>索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。</li>
<li>一个索引的选择性越接近于1，这个索引的效率就越高。</li>
</ol>
<h2 id="4、性能分析"><a href="#4、性能分析" class="headerlink" title="4、性能分析"></a>4、性能分析</h2><h3 id="4-1、性能优化概述"><a href="#4-1、性能优化概述" class="headerlink" title="4.1、性能优化概述"></a>4.1、性能优化概述</h3><blockquote>
<p><strong>MySQL Query Optimizer 的作用</strong></p>
</blockquote>
<ol>
<li>MySQL 中有专门负责优化SELECT语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供他认为最优的执行计划（MySQL认为最优的数据检索方式，但不见得是DBA认为是最优的，这部分最耗费时间）</li>
<li>当客户端向MySQL 请求一条Query，命令解析器模块完成请求分类，区别出是SELECT并转发给MySQL Query Optimizer时，MySQL Query Optimizer 首先会对整条Query进行优化，处理掉一些常量表达式的预算，直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析 Query中的Hint信息（如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint 或Hint 信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划。</li>
</ol>
<blockquote>
<p><strong>MySQL 常见瓶颈</strong></p>
</blockquote>
<ol>
<li>CPU 瓶颈：CPU在饱和的时候一般发生在数据装入在内存或从磁盘上读取数据时候</li>
<li>IO 瓶颈：磁盘I/O瓶颈发生在装入数据远大于内存容量时</li>
<li>服务器硬件的性能瓶颈：top、free、iostat和vmstat来查看系统的性能状态</li>
</ol>
<h3 id="4-2、Explain-概述"><a href="#4-2、Explain-概述" class="headerlink" title="4.2、Explain 概述"></a>4.2、Explain 概述</h3><blockquote>
<p><strong>Explain</strong></p>
</blockquote>
<p><strong>是什么？Explain 是查看执行计划</strong></p>
<ol>
<li>使用<strong>EXPLAIN</strong>关键字可以模拟优化器执行SQL语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是结构的性能瓶颈</li>
<li>官网地址：<a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></li>
</ol>
<p><strong>能干嘛？</strong></p>
<ol>
<li>表的读取顺序（id 字段）</li>
<li>数据读取操作的操作类型（select_type 字段）</li>
<li>哪些索引可以使用（possible_keys 字段）</li>
<li>哪些索引被实际使用（keys 字段）</li>
<li>表之间的引用（ref 字段）</li>
<li>每张表有多少行被优化器查询（rows 字段）</li>
</ol>
<p><strong>怎么玩？</strong></p>
<ul>
<li><strong>Explain + SQL语句</strong></li>
</ul>
<pre><code>mysql&gt; explain select * from tbl_emp;
+----+-------------+---------+------+---------------+------+---------+------+------+-------+
| id | select_type | table   | type | possible_keys | key  | key_len | ref  | rows | Extra |
+----+-------------+---------+------+---------------+------+---------+------+------+-------+
|  1 | SIMPLE      | tbl_emp | ALL  | NULL          | NULL | NULL    | NULL |    8 | NULL  |
+----+-------------+---------+------+---------------+------+---------+------+------+-------+
1 row in set (0.00 sec)
</code></pre><h3 id="4-3、Explain-详解"><a href="#4-3、Explain-详解" class="headerlink" title="4.3、Explain 详解"></a>4.3、Explain 详解</h3><blockquote>
<p><strong>id：select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</strong></p>
</blockquote>
<p>id 取值的三种情况： </p>
<ol>
<li><strong>id相同</strong>，执行顺序由上至下</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/da4abcf3fa84454edf244eb89e1be90a.png" alt="image-20200804101016101"></p>
<ol start="2">
<li><strong>id不同</strong>，如果是子查询，id的序号会递增，<strong>id值越大优先级越高，越先被执行</strong></li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/25404ed2cc2d5443ca8e30bf09579d7f.png" alt="image-20200804101005684"></p>
<ol start="3">
<li><strong>id相同不同</strong>，同时存在：id如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id值越大，优先级越高，越先执行；衍生=DERIVED</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e4e29eff2a64a71f6e748deb9baf99cc.png" alt="image-20200804101502048"></p>
<blockquote>
<p><strong>select_type：查询的类型，主要用于区别普通查询、联合查询、子查询等复杂查询</strong></p>
</blockquote>
<ol>
<li><strong>SIMPLE：</strong>简单的select查询，查询中不包含子查询或者UNION</li>
<li><strong>PRIMARY</strong>：查询中若包含任何复杂的子部分，最外层查询则被标记为PRIMARY</li>
<li><strong>SUBQUERY：</strong>在SELECT或者WHERE列表中包含了子查询</li>
<li><strong>DERIVED：</strong>在FROM列表中包含的子查询被标记为DERIVED（衍生）MySQL会递归执行这些子查询，把结果放在临时表里</li>
<li><strong>UNION：</strong>若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中，外层SELECT将被标记为：DERIVED</li>
<li><strong>UNION RESULT：</strong>从UNION表获取结果的SELECT</li>
</ol>
<p><strong>UNION 和 UNION RESULT举例</strong></p>
<pre><code>explain
    -&gt; select * from tbl_emp e left join tbl_dept d on e.deptId = d.id
    -&gt; union
    -&gt; select * from tbl_emp e right join tbl_dept d on e.deptId = d.id;
+----+--------------+------------+------+---------------+------------+---------+-----------+------+----------------------------------------------------+
| id | select_type  | table      | type | possible_keys | key        | key_len | ref       | rows | Extra                                              |
+----+--------------+------------+------+---------------+------------+---------+-----------+------+----------------------------------------------------+
|  1 | PRIMARY      | e          | ALL  | NULL          | NULL       | NULL    | NULL      |    8 | NULL                                               |
|  1 | PRIMARY      | d          | ALL  | PRIMARY       | NULL       | NULL    | NULL      |    5 | Using where; Using join buffer (Block Nested Loop) |
|  2 | UNION        | d          | ALL  | NULL          | NULL       | NULL    | NULL      |    5 | NULL                                               |
|  2 | UNION        | e          | ref  | fk_dept_Id    | fk_dept_Id | 5       | db01.d.id |    1 | NULL                                               |
| NULL | UNION RESULT | &lt;union1,2&gt; | ALL  | NULL          | NULL       | NULL    | NULL      | NULL | Using temporary                                    |
+----+--------------+------------+------+---------------+------------+---------+-----------+------+----------------------------------------------------+
5 rows in set (0.00 sec)
</code></pre><blockquote>
<p>t<strong>able：显示这一行的数据是关于哪张表的</strong></p>
</blockquote>
<blockquote>
<p><strong>type：访问类型排列，显示查询使用了何种类型</strong></p>
</blockquote>
<ol>
<li>type显示的是访问类型，是较为重要的一个指标，结果值从最好到最坏依次是：<code>system &gt; const &gt; eq_ref &gt; ref &gt; fultext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</code></li>
<li>挑重要的来说：<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code>，一般来说，得保证查询至少达到range级别，最好能达到ref。</li>
</ol>
<p><strong>从最好到最差依次是：system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</strong></p>
<ol>
<li><p><strong>system：</strong>表只有一行记录（等于系统表），这是const类型的特例，平时不会出现，这个也可以忽略不计</p>
</li>
<li><p><strong>const：</strong>表示通过索引一次就找到了，const用于比较primary key或者unique索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL就能将该查询转换为一个常量</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/4ab5ad168975b919a0fef79a50ef722a.png" alt="image-20200804103028065"></p>
</li>
<li><p><strong>eq_ref：</strong>唯一性索引，对于每个索引键，表中只有一条记录与之匹配，常见于主键或唯一索引扫描</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f7bd1ea1cb7dde026d9187fef1822e94.png" alt="image-20200804103543783"></p>
</li>
<li><p><strong>ref：</strong>非唯一索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/9f2f98d605f4504a2032a71c9c629d76.png" alt="image-20200804103959011"></p>
</li>
<li><p><strong>range</strong>：只检索给定范围的行，使用一个索引来选择行。key列显示使用了哪个索引一般就是在你的where语句中出现了<code>between</code>、<code>&lt;</code>、<code>&gt;</code>、<code>in</code>等的查询这种范围扫描索引扫描比全表扫描要好，因为他<strong>只需要开始索引的某一点，而结束于另一点，不用扫描全部索引</strong></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/77d5536b196806ce02c676f0a16c79b9.png" alt="image-20200804104130086"></p>
</li>
<li><p><strong>index</strong>：Full Index Scan，index与ALL区别为index类型<strong>只遍历索引树</strong>。这通常比ALL快，因为索引文件通常比数据文件小。（也就是说<strong>虽然all和index都是读全表，但index是从索引中读取的，而all是从硬盘数据库文件中读的</strong>）</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7d4b75a446fdeff53d3ccb96ce7ae9f4.png" alt="image-20200804104254208"></p>
</li>
<li><p><strong>all</strong>：FullTable Scan，<strong>将遍历全表以找到匹配的行（全表扫描）</strong></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/a9cc0f39661fb313c5d2c91f35d627bd.png" alt="image-20200804104358142"></p>
</li>
<li><p>备注：一般来说，得保证查询只是达到range级别，最好达到ref</p>
</li>
</ol>
<blockquote>
<p><strong>possible_keys</strong></p>
</blockquote>
<ol>
<li>显示<strong>可能</strong>应用在这张表中的索引，一个或多个</li>
<li>若查询涉及的字段上存在索引，则该索引将被列出，但不一定被查询实际使用</li>
</ol>
<blockquote>
<p><strong>key</strong></p>
</blockquote>
<ol>
<li><strong>实际</strong>使用的索引，如果为null，则没有使用索引</li>
<li><strong>若查询中使用了覆盖索引，则该索引仅出现在key列表中</strong></li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/740cb69c1c775b87c413768f5dcf1679.png" alt="image-20200804105225100"></p>
<blockquote>
<p><strong>key_len</strong></p>
</blockquote>
<ol>
<li><strong>表示索引中使用的字节数</strong>，可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下，长度越短越好</li>
<li>key_len显示的值为<strong>索引最大可能长度</strong>，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/2ad15fda5cf87d06ad929a9ea9d0a4f1.png" alt="image-20200804105833936"></p>
<blockquote>
<p><strong>ref</strong></p>
</blockquote>
<ol>
<li><strong>显示索引哪一列被使用了</strong>，如果可能的话，最好是一个常数。哪些列或常量被用于查找索引列上的值</li>
<li>由key_len可知t1表的索引idx_col1_col2被充分使用，t1表的col1匹配t2表的col1，t1表的col2匹配了一个常量，即’ac’</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/28aaffa8fcce6c311fc1fdc379d04f3e.png" alt="image-20200804110346982"></p>
<blockquote>
<p><strong>rows</strong></p>
</blockquote>
<p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6f3280416e87d914b8693a5a9f0be0dd.png" alt="image-20200804111249713"></p>
<blockquote>
<p><strong>Extra：包含不适合在其他列中显示但十分重要的额外信息</strong></p>
</blockquote>
<ul>
<li><p><strong>Using filesort（文件排序）：</strong></p>
</li>
<li><p>MySQL中无法利用索引完成排序操作成为“文件排序”</p>
</li>
<li><p>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取</p>
<ul>
<li><strong>出现 Using filesort 不好（九死一生），需要尽快优化 SQL</strong></li>
<li>示例中第一个查询只使用了 col1 和 col3，原有索引派不上用场，所以进行了外部文件排序</li>
<li>示例中第二个查询使用了 col1、col2 和 col3，原有索引派上用场，无需进行文件排序</li>
</ul>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5a8058b72155c2139f787c7ca850a5e7.png" alt="image-20200804111738931"></p>
<ul>
<li><strong>Using temporary（创建临时表）：</strong><ul>
<li>使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by</li>
<li><strong>出现 Using temporary 超级不好（十死无生），需要立即优化 SQL</strong></li>
<li>示例中第一个查询只使用了 col1，原有索引派不上用场，所以创建了临时表进行分组</li>
<li>示例中第二个查询使用了 col1、col2，原有索引派上用场，无需 创建临时表</li>
</ul>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d882d26bfee9d22de19de32f258054bf.png" alt="image-20200804112558915"></p>
<ul>
<li><strong>Using index（覆盖索引）：</strong><ul>
<li>表示相应的select操作中使用了覆盖索引（Coveing Index），避免访问了表的数据行，效率不错！</li>
<li>如果同时出现using where，表明索引被用来执行索引键值的查找</li>
<li>如果没有同时出现using where，表明索引用来读取数据而非执行查找动作</li>
</ul>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/47c3005a7d32a29e79a9136d4c6e0470.png" alt="image-20200804113450147"></p>
<ul>
<li><strong>覆盖索引（Covering Index），也说为索引覆盖</strong><ul>
<li>理解方式一：就是<strong>select的数据列只用从索引中就能够取得，不必读取数据行</strong>，MySQL可以<strong>利用索引返回select列表中的字段，而不必根据索引再次读取数据文件</strong>，换句话说查询列要被所建的索引覆盖。</li>
<li>理解方式二：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。一个索引包含了（或覆盖了）满足查询结果的数据就叫做覆盖索引。</li>
<li>注意：<strong>如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可<code>select *</code></strong> ，因为如果将所有字段一起做索引会导致索引文件过大，查询性能下降。</li>
</ul>
</li>
</ul>
<p><strong>Using where</strong>：表明使用了where过滤</p>
<p><strong>Using join buffer</strong>：表明使用了连接缓存</p>
<p><strong>impossible where：</strong>where子句的值总是false，不能用来获取任何元组</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/87a860501fa146add8f7735bdde108dd.png" alt="image-20200804113946144"></p>
<p><strong>select tables optimized away：</strong>在没有GROUPBY子句的情况下，基于索引优化MIN/MAX操作或者对于MyISAM存储引擎优化<code>COUNT(*)</code>操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</p>
<p><strong>distinct：</strong>优化distinct，在找到第一匹配的元组后即停止找同样值的工作</p>
<blockquote>
<p><strong>Explain 热身 Case</strong></p>
</blockquote>
<ol>
<li>第一行（执行顺序4）：id列为1，表示是union里的第一个select，select_type列的primary表示该查询为外层查询，table列被标记为<derived3>，表示查询结果来自一个衍生表，其中derived3中3代表该查询衍生自第三个select查询，即id为3的select。【<code>select d1.name ...</code>】</derived3></li>
<li>第二行（执行顺序2）：id为3，是整个查询中第三个select的一部分。因查询包含在from中，所以为derived。【<code>select id, name from t1 where other_column= ' '</code>】</li>
<li>第三行（执行顺序3）：select列表中的子查询select_type为subquery，为整个查询中的第二个select。【<code>select id from t3</code>】</li>
<li>第四行（执行顺序1）：select_type为union，说明第四个select是union里的第二个select，最先执行【<code>select name, id from t2</code>】</li>
<li>第五行（执行顺序5）：代表从union的临时表中读取行的阶段，table列的&lt;union1, 4&gt;表示用第一个和第四个select的结果进行union操作。【两个结果进行uinion操作】</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fe64ec372bf9043f92fe91a28176660a.png" alt="image-20200804114203012"></p>
<h2 id="5、索引优化"><a href="#5、索引优化" class="headerlink" title="5、索引优化"></a>5、索引优化</h2><h3 id="5-1、单表索引优化"><a href="#5-1、单表索引优化" class="headerlink" title="5.1、单表索引优化"></a>5.1、单表索引优化</h3><blockquote>
<p><strong>单表索引优化分析</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> article<span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    author_id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    category_id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    views <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    comments <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    content <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> article<span class="token punctuation">(</span>author_id<span class="token punctuation">,</span>category_id<span class="token punctuation">,</span>views<span class="token punctuation">,</span>comments<span class="token punctuation">,</span>title<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>表中的测试数据</li>
</ul>
<pre><code>mysql&gt; SELECT * FROM article;
+----+-----------+-------------+-------+----------+-------+---------+
| id | author_id | category_id | views | comments | title | content |
+----+-----------+-------------+-------+----------+-------+---------+
|  1 |         1 |           1 |     1 |        1 | 1     | 1       |
|  2 |         2 |           2 |     2 |        2 | 2     | 2       |
|  3 |         1 |           1 |     3 |        3 | 3     | 3       |
+----+-----------+-------------+-------+----------+-------+---------+
3 rows in set (0.00 sec)</code></pre><p><strong>查询案例</strong></p>
<ul>
<li>查询category_id为1且comments 大于1的情况下，views最多的article_id。</li>
</ul>
<pre><code>mysql&gt; SELECT id, author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;
+----+-----------+
| id | author_id |
+----+-----------+
|  3 |         1 |
+----+-----------+
1 row in set (0.00 sec)</code></pre><ul>
<li>此时 article 表中只有一个主键索引</li>
</ul>
<pre><code>mysql&gt; SHOW INDEX FROM article;
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| article |          0 | PRIMARY  |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>使用 explain 分析 SQL 语句的执行效率：<code>EXPLAIN SELECT id, author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;</code></li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT id, author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;
+----+-------------+---------+------+---------------+------+---------+------+------+-----------------------------+
| id | select_type | table   | type | possible_keys | key  | key_len | ref  | rows | Extra                       |
+----+-------------+---------+------+---------------+------+---------+------+------+-----------------------------+
|  1 | SIMPLE      | article | ALL  | NULL          | NULL | NULL    | NULL |    3 | Using where; Using filesort |
+----+-------------+---------+------+---------------+------+---------+------+------+-----------------------------+
1 row in set (0.00 sec)
</code></pre><p><strong>结论：</strong></p>
<ul>
<li>很显然，type是ALL，即最坏的情况。</li>
<li>Extra 里还出现了Using filesort，也是最坏的情况。</li>
<li>优化是必须的。</li>
</ul>
<p><strong>开始优化：新建索引</strong></p>
<ul>
<li>创建索引的 SQL 命令</li>
</ul>
<pre><code># ALTER TABLE article ADD INDEX idx_article_ccv('category_id', 'comments', 'views'); 
create index idx_article_ccv on article(category_id, comments, views);</code></pre><ul>
<li>在 category_id 列、comments 列和 views 列上建立联合索引</li>
</ul>
<pre><code>mysql&gt; create index idx_article_ccv on article(category_id, comments, views);
Query OK, 0 rows affected (0.01 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM article;
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name        | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| article |          0 | PRIMARY         |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| article |          1 | idx_article_ccv |            1 | category_id | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| article |          1 | idx_article_ccv |            2 | comments    | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| article |          1 | idx_article_ccv |            3 | views       | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)
</code></pre><ul>
<li>再次执行查询：type变成了range，这是可以忍受的。但是extra里使用Using filesort仍是无法接受的。</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT id, author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;
+----+-------------+---------+-------+-----------------+-----------------+---------+------+------+---------------------------------------+
| id | select_type | table   | type  | possible_keys   | key             | key_len | ref  | rows | Extra                                 |
+----+-------------+---------+-------+-----------------+-----------------+---------+------+------+---------------------------------------+
|  1 | SIMPLE      | article | range | idx_article_ccv | idx_article_ccv | 8       | NULL |    1 | Using index condition; Using filesort |
+----+-------------+---------+-------+-----------------+-----------------+---------+------+------+---------------------------------------+
1 row in set (0.00 sec)
</code></pre><p>分析：</p>
<ul>
<li><p>但是我们已经建立了索引，为啥没用呢？</p>
</li>
<li><p>这是因为按照<strong>B+Tree</strong>索引的工作原理，先排序 category_id，如果遇到相同的 category_id 则再排序comments，如果遇到相同的 comments 则再排序 views。</p>
</li>
<li><p>当comments字段在联合索引里处于中间位置时，<strong>因为<code>comments&gt;1</code>条件是一个范围值</strong>（所谓 range），MySQL 无法利用索引再对后面的views部分进行检索，即 <strong>range 类型查询字段后面的索引无效</strong>。</p>
</li>
</ul>
<p>将查询条件中的 <code>comments &gt; 1</code> 改为 <code>comments = 1</code> ，发现 Use filesort 神奇地消失了，从这点可以验证：范围后的索引会导致索引失效</p>
<pre><code>mysql&gt; EXPLAIN SELECT id, author_id FROM article WHERE category_id = 1 AND comments = 1 ORDER BY views DESC LIMIT 1;
+----+-------------+---------+------+-----------------+-----------------+---------+-------------+------+-------------+
| id | select_type | table   | type | possible_keys   | key             | key_len | ref         | rows | Extra       |
+----+-------------+---------+------+-----------------+-----------------+---------+-------------+------+-------------+
|  1 | SIMPLE      | article | ref  | idx_article_ccv | idx_article_ccv | 8       | const,const |    1 | Using where |
+----+-------------+---------+------+-----------------+-----------------+---------+-------------+------+-------------+
1 row in set (0.00 sec)</code></pre><p><strong>删除索引</strong></p>
<ul>
<li>删除索引的 SQL 指令</li>
</ul>
<pre><code>DROP INDEX idx_article_ccv ON article;</code></pre><ul>
<li>删除刚才创建的 idx_article_ccv 索引</li>
</ul>
<pre><code>mysql&gt; DROP INDEX idx_article_ccv ON article;
Query OK, 0 rows affected (0.00 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM article;
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| article |          0 | PRIMARY  |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
1 row in set (0.00 sec)</code></pre><p><strong>再次创建索引</strong></p>
<ul>
<li>创建索引的 SQL 指令</li>
</ul>
<pre><code># ALTER TABLE article ADD INDEX idx_article_ccv('category_id',  'views'); 
create index idx_article_ccv on article(category_id, views);</code></pre><ul>
<li>由于 range 后（<code>comments &gt; 1</code>）的索引会失效，这次我们建立索引时，直接抛弃 comments 列，先利用 category_id 和 views 的联合索引查询所需要的数据，再从其中取出 <code>comments &gt; 1</code> 的数据（我觉着应该是这样的）</li>
</ul>
<pre><code>mysql&gt; create index idx_article_ccv on article(category_id, views);
Query OK, 0 rows affected (0.30 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM article;
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name        | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| article |          0 | PRIMARY         |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| article |          1 | idx_article_ccv |            1 | category_id | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| article |          1 | idx_article_ccv |            2 | views       | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
3 rows in set (0.00 sec)</code></pre><ul>
<li>再次执行查询：可以看到，type变为了ref，Extra中的Using filesort也消失了，结果非常理想</li>
</ul>
<pre><code>ysql&gt; EXPLAIN SELECT id, author_id FROM article WHERE category_id = 1 AND comments &gt; 1 ORDER BY views DESC LIMIT 1;
+----+-------------+---------+------+-----------------+-----------------+---------+-------+------+-------------+
| id | select_type | table   | type | possible_keys   | key             | key_len | ref   | rows | Extra       |
+----+-------------+---------+------+-----------------+-----------------+---------+-------+------+-------------+
|  1 | SIMPLE      | article | ref  | idx_article_ccv | idx_article_ccv | 4       | const |    2 | Using where |
+----+-------------+---------+------+-----------------+-----------------+---------+-------+------+-------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>为了不影响之后的测试，删除该表的 idx_article_ccv 索引</li>
</ul>
<pre><code>mysql&gt; DROP INDEX idx_article_ccv ON article;
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM article;
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table   | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| article |          0 | PRIMARY  |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
1 row in set (0.01 sec)</code></pre><h3 id="5-2、两表索引优化"><a href="#5-2、两表索引优化" class="headerlink" title="5.2、两表索引优化"></a>5.2、两表索引优化</h3><blockquote>
<p><strong>两表索引优化分析：主外键</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> class<span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> book<span class="token punctuation">(</span>
    bookid <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>bookid<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>class 表中的测试数据</li>
</ul>
<pre><code>mysql&gt; select * from class;
+----+------+
| id | card |
+----+------+
|  1 |   12 |
|  2 |   13 |
|  3 |   12 |
|  4 |   17 |
|  5 |   11 |
|  6 |    3 |
|  7 |    1 |
|  8 |   16 |
|  9 |   17 |
| 10 |   16 |
| 11 |    9 |
| 12 |   17 |
| 13 |   18 |
| 14 |   16 |
| 15 |    7 |
| 16 |    8 |
| 17 |   19 |
| 18 |    9 |
| 19 |    6 |
| 20 |    5 |
| 21 |    6 |
+----+------+
21 rows in set (0.00 sec)</code></pre><ul>
<li>book 表中的测试数据</li>
</ul>
<pre><code>mysql&gt; select * from book;
+--------+------+
| bookid | card |
+--------+------+
|      1 |   16 |
|      2 |    1 |
|      3 |   17 |
|      4 |    3 |
|      5 |   20 |
|      6 |   12 |
|      7 |   18 |
|      8 |   13 |
|      9 |   13 |
|     10 |    4 |
|     11 |    1 |
|     12 |   13 |
|     13 |   20 |
|     14 |   20 |
|     15 |    1 |
|     16 |    2 |
|     17 |    9 |
|     18 |   16 |
|     19 |   14 |
|     20 |    2 |
+--------+------+
20 rows in set (0.00 sec)
</code></pre><p><strong>查询案例</strong></p>
<ul>
<li>实现两表的连接，连接条件是 class.card = book.card</li>
</ul>
<pre><code>mysql&gt; SELECT * FROM class LEFT JOIN book ON class.card = book.card;
+----+------+--------+------+
| id | card | bookid | card |
+----+------+--------+------+
|  1 |   12 |      6 |   12 |
|  2 |   13 |      8 |   13 |
|  2 |   13 |      9 |   13 |
|  2 |   13 |     12 |   13 |
|  3 |   12 |      6 |   12 |
|  4 |   17 |      3 |   17 |
|  5 |   11 |   NULL | NULL |
|  6 |    3 |      4 |    3 |
|  7 |    1 |      2 |    1 |
|  7 |    1 |     11 |    1 |
|  7 |    1 |     15 |    1 |
|  8 |   16 |      1 |   16 |
|  8 |   16 |     18 |   16 |
|  9 |   17 |      3 |   17 |
| 10 |   16 |      1 |   16 |
| 10 |   16 |     18 |   16 |
| 11 |    9 |     17 |    9 |
| 12 |   17 |      3 |   17 |
| 13 |   18 |      7 |   18 |
| 14 |   16 |      1 |   16 |
| 14 |   16 |     18 |   16 |
| 15 |    7 |   NULL | NULL |
| 16 |    8 |   NULL | NULL |
| 17 |   19 |   NULL | NULL |
| 18 |    9 |     17 |    9 |
| 19 |    6 |   NULL | NULL |
| 20 |    5 |   NULL | NULL |
| 21 |    6 |   NULL | NULL |
+----+------+--------+------+
28 rows in set (0.00 sec)</code></pre><ul>
<li>使用 explain 分析 SQL 语句的性能，可以看到：驱动表是左表 class 表</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra                                              |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
|  1 | SIMPLE      | class | ALL  | NULL          | NULL | NULL    | NULL |   21 | NULL                                               |
|  1 | SIMPLE      | book  | ALL  | NULL          | NULL | NULL    | NULL |   20 | Using where; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
2 rows in set (0.00 sec)</code></pre><p>结论：</p>
<ul>
<li><strong>type 有 All ，rows 为表中数据总行数，说明 class 和 book 进行了全表检索</strong></li>
<li>即每次 class 表对 book 表进行左外连接时，都需要在 book 表中进行一次全表检索</li>
</ul>
<p><strong>添加索引：在右表添加索引</strong></p>
<ul>
<li>添加索引的 SQL 指令</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE 'book' ADD INDEX Y ('card');</code></pre>
<ul>
<li>在 book 的 card 字段上添加索引</li>
</ul>
<pre><code>mysql&gt; ALTER TABLE book ADD INDEX Y (card);
Query OK, 0 rows affected (0.30 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM book;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| book  |          0 | PRIMARY  |            1 | bookid      | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
| book  |          1 | Y        |            1 | card        | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>测试结果：可以看到第二行的type变为了ref，rows也变成了优化比较明显。</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref             | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
|  1 | SIMPLE      | class | ALL  | NULL          | NULL | NULL    | NULL            |   21 | NULL        |
|  1 | SIMPLE      | book  | ref  | Y             | Y    | 4       | db01.class.card |    1 | Using index |
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>分析：<ul>
<li>这是由左连接特性决定的。LEFT JOIN条件用于确定如何从右表搜索行，左边一定都有，所以右边是我们的关键点，一定需要建立索引。</li>
<li><strong>左表连接右表，则需要拿着左表的数据去右表里面查，索引需要在右表中建立索引</strong></li>
</ul>
</li>
</ul>
<p><strong>添加索引：在左表添加索引</strong></p>
<ul>
<li>删除之前 book 表中的索引</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">DROP INDEX Y ON book;</code></pre>
<ul>
<li>在 class 表的 card 字段上建立索引</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE class ADD INDEX X(card);</code></pre>
<ul>
<li>再次执行左连接，凉凉<del>~</del></li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
+----+-------------+-------+-------+---------------+------+---------+------+------+----------------------------------------------------+
| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows | Extra                                              |
+----+-------------+-------+-------+---------------+------+---------+------+------+----------------------------------------------------+
|  1 | SIMPLE      | class | index | NULL          | X    | 4       | NULL |   21 | Using index                                        |
|  1 | SIMPLE      | book  | ALL   | NULL          | NULL | NULL    | NULL |   20 | Using where; Using join buffer (Block Nested Loop) |
+----+-------------+-------+-------+---------------+------+---------+------+------+----------------------------------------------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>别怕，我们来执行右连接：可以看到第二行的type变为了ref，rows也变成了优化比较明显。</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class RIGHT JOIN book ON class.card = book.card;
+----+-------------+-------+------+---------------+------+---------+----------------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref            | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+----------------+------+-------------+
|  1 | SIMPLE      | book  | ALL  | NULL          | NULL | NULL    | NULL           |   20 | NULL        |
|  1 | SIMPLE      | class | ref  | X             | X    | 4       | db01.book.card |    1 | Using index |
+----+-------------+-------+------+---------------+------+---------+----------------+------+-------------+
2 rows in set (0.00 sec)
</code></pre><p>分析：</p>
<ul>
<li><p>这是因为RIGHT JOIN条件用于确定如何从左表搜索行，右边一定都有，所以左边是我们的关键点，一定需要建立索引。</p>
</li>
<li><p>class RIGHT JOIN book ：book 里面的数据一定存在于结果集中，我们需要拿着 book 表中的数据，去 class 表中搜索，所以索引需要建立在 class 表中</p>
</li>
<li><p>为了不影响之后的测试，删除该表的索引</p>
</li>
</ul>
<pre><code>mysql&gt; DROP INDEX X ON class;
Query OK, 0 rows affected (0.04 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM class;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| class |          0 | PRIMARY  |            1 | id          | A         |          21 |     NULL | NULL   |      | BTREE      |         |               |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
1 row in set (0.00 sec)</code></pre><h3 id="5-3、三表索引优化"><a href="#5-3、三表索引优化" class="headerlink" title="5.3、三表索引优化"></a>5.3、三表索引优化</h3><blockquote>
<p><strong>三表索引优化分析</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> phone<span class="token punctuation">(</span>
    phoneid <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    card <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>phoneid<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>phone 表中的测试数据</li>
</ul>
<pre><code>mysql&gt; select * from phone;
+---------+------+
| phoneid | card |
+---------+------+
|       1 |    7 |
|       2 |    7 |
|       3 |   13 |
|       4 |    6 |
|       5 |    8 |
|       6 |    4 |
|       7 |   16 |
|       8 |    4 |
|       9 |   15 |
|      10 |    1 |
|      11 |   20 |
|      12 |   18 |
|      13 |    9 |
|      14 |    9 |
|      15 |   20 |
|      16 |   11 |
|      17 |   15 |
|      18 |    3 |
|      19 |    8 |
|      20 |   10 |
+---------+------+
20 rows in set (0.00 sec)</code></pre><p><strong>查询案例</strong></p>
<ul>
<li>实现三表的连接查询：</li>
</ul>
<pre><code>mysql&gt; SELECT * FROM class LEFT JOIN book ON class.card = book.card LEFT JOIN phone ON book.card = phone.card;
+----+------+--------+------+---------+------+
| id | card | bookid | card | phoneid | card |
+----+------+--------+------+---------+------+
|  2 |   13 |      8 |   13 |       3 |   13 |
|  2 |   13 |      9 |   13 |       3 |   13 |
|  2 |   13 |     12 |   13 |       3 |   13 |
|  8 |   16 |      1 |   16 |       7 |   16 |
| 10 |   16 |      1 |   16 |       7 |   16 |
| 14 |   16 |      1 |   16 |       7 |   16 |
|  8 |   16 |     18 |   16 |       7 |   16 |
| 10 |   16 |     18 |   16 |       7 |   16 |
| 14 |   16 |     18 |   16 |       7 |   16 |
|  7 |    1 |      2 |    1 |      10 |    1 |
|  7 |    1 |     11 |    1 |      10 |    1 |
|  7 |    1 |     15 |    1 |      10 |    1 |
| 13 |   18 |      7 |   18 |      12 |   18 |
| 11 |    9 |     17 |    9 |      13 |    9 |
| 18 |    9 |     17 |    9 |      13 |    9 |
| 11 |    9 |     17 |    9 |      14 |    9 |
| 18 |    9 |     17 |    9 |      14 |    9 |
|  6 |    3 |      4 |    3 |      18 |    3 |
|  4 |   17 |      3 |   17 |    NULL | NULL |
|  9 |   17 |      3 |   17 |    NULL | NULL |
| 12 |   17 |      3 |   17 |    NULL | NULL |
|  1 |   12 |      6 |   12 |    NULL | NULL |
|  3 |   12 |      6 |   12 |    NULL | NULL |
|  5 |   11 |   NULL | NULL |    NULL | NULL |
| 15 |    7 |   NULL | NULL |    NULL | NULL |
| 16 |    8 |   NULL | NULL |    NULL | NULL |
| 17 |   19 |   NULL | NULL |    NULL | NULL |
| 19 |    6 |   NULL | NULL |    NULL | NULL |
| 20 |    5 |   NULL | NULL |    NULL | NULL |
| 21 |    6 |   NULL | NULL |    NULL | NULL |
+----+------+--------+------+---------+------+
30 rows in set (0.00 sec)</code></pre><ul>
<li>使用 explain 分析 SQL 指令：</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card LEFT JOIN phone ON book.card = phone.card;
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra                                              |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
|  1 | SIMPLE      | class | ALL  | NULL          | NULL | NULL    | NULL |   21 | NULL                                               |
|  1 | SIMPLE      | book  | ALL  | NULL          | NULL | NULL    | NULL |   20 | Using where; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | phone | ALL  | NULL          | NULL | NULL    | NULL |   20 | Using where; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------------------------------------------+
3 rows in set (0.00 sec)</code></pre><p><strong>结论：</strong></p>
<ul>
<li><strong>type 有All ，rows 为表数据总行数，说明 class、 book 和 phone 表都进行了全表检索</strong></li>
<li>Extra 中 Using join buffer ，表明连接过程中使用了 join 缓冲区</li>
</ul>
<p><strong>创建索引</strong></p>
<ul>
<li>创建索引的 SQL 语句</li>
</ul>
<pre><code>ALTER TABLE book ADD INDEX Y (card);
ALTER TABLE phone ADD INDEX Z (card);</code></pre><ul>
<li><strong>进行 LEFT JOIN ，永远都在右表的字段上建立索引</strong></li>
</ul>
<pre><code>mysql&gt; ALTER TABLE book ADD INDEX Y (card);
Query OK, 0 rows affected (0.06 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM book;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| book  |          0 | PRIMARY  |            1 | bookid      | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
| book  |          1 | Y        |            1 | card        | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
2 rows in set (0.00 sec)

mysql&gt; ALTER TABLE phone ADD INDEX Z (card);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM phone;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| phone |          0 | PRIMARY  |            1 | phoneid     | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
| phone |          1 | Z        |            1 | card        | A         |          20 |     NULL | NULL   |      | BTREE      |         |               |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>执行查询：后2行的type都是ref，且总rows优化很好，效果不错。因此索引最好设置在需要经常查询的字段中。</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card=book.card LEFT JOIN phone ON book.card = phone.card;
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref             | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
|  1 | SIMPLE      | class | ALL  | NULL          | NULL | NULL    | NULL            |   21 | NULL        |
|  1 | SIMPLE      | book  | ref  | Y             | Y    | 4       | db01.class.card |    1 | Using index |
|  1 | SIMPLE      | phone | ref  | Z             | Z    | 4       | db01.book.card  |    1 | Using index |
+----+-------------+-------+------+---------------+------+---------+-----------------+------+-------------+
3 rows in set (0.00 sec)</code></pre><blockquote>
<p><strong>Join 语句优化的结论</strong></p>
</blockquote>
<p><strong>将 left join 看作是两层嵌套 for 循环</strong></p>
<ol>
<li>尽可能减少Join语句中的NestedLoop的循环总次数；</li>
<li><strong>永远用小结果集驱动大的结果集（在大结果集中建立索引，在小结果集中遍历全表）；</strong></li>
<li>优先优化NestedLoop的内层循环；</li>
<li>保证Join语句中被驱动表上Join条件字段已经被索引；</li>
<li>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置；</li>
</ol>
<p><strong>我的理解</strong></p>
<ol>
<li>使用小表驱动大表，这就相当于外层 for 循环的次数少，内层 for 循环的次数多</li>
<li>然后我们在大表中建立了索引，这样内层 for 循环的效率明显提高</li>
<li>综上，使用小表驱动大表，在大表中建立了索引</li>
</ol>
<h2 id="6、索引失效"><a href="#6、索引失效" class="headerlink" title="6、索引失效"></a>6、索引失效</h2><blockquote>
<p><strong>索引失效（应该避免）</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> staffs<span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span><span class="token string">''</span> <span class="token keyword">COMMENT</span><span class="token string">'姓名'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span><span class="token string">'年龄'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span><span class="token string">''</span> <span class="token keyword">COMMENT</span><span class="token string">'职位'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span><span class="token string">'入职时间'</span>
<span class="token punctuation">)</span><span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COMMENT</span><span class="token string">'员工记录表'</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>add_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'z3'</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token string">'manager'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>add_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'July'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'dev'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> staffs<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>add_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'2000'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'dev'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> staffs <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> index_staffs_nameAgePos<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>staffs 表中的测试数据</li>
</ul>
<pre><code>mysql&gt; select * from staffs;
+----+------+-----+---------+---------------------+
| id | name | age | pos     | add_time            |
+----+------+-----+---------+---------------------+
|  1 | z3   |  22 | manager | 2020-08-04 14:42:33 |
|  2 | July |  23 | dev     | 2020-08-04 14:42:33 |
|  3 | 2000 |  23 | dev     | 2020-08-04 14:42:33 |
+----+------+-----+---------+---------------------+
3 rows in set (0.00 sec)</code></pre><ul>
<li>staffs 表中的复合索引：name、age、pos</li>
</ul>
<pre><code>mysql&gt; SHOW INDEX FROM staffs;
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name                | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| staffs |          0 | PRIMARY                 |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            1 | name        | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            2 | age         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            3 | pos         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)</code></pre><h3 id="6-1、索引失效准则"><a href="#6-1、索引失效准则" class="headerlink" title="6.1、索引失效准则"></a>6.1、索引失效准则</h3><blockquote>
<p><strong>索引失效判断准则</strong></p>
</blockquote>
<ol>
<li>全值匹配我最爱</li>
<li>最佳左前缀法则：如果索引了多例，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</li>
<li>不要在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描</li>
<li>存储引擎不能使用索引中范围条件右边的列</li>
<li>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少<code>select *</code></li>
<li>mysql在使用不等于（!=或者&lt;&gt;）的时候无法使用索引会导致全表扫描</li>
<li><code>is null</code>，<code>is not null</code> 也无法使用索引（早期版本不能走索引，后续版本应该优化过，可以走索引）</li>
<li>like以通配符开头（’%abc…’）mysql索引失效会变成全表扫描操作</li>
<li>字符串不加单引号索引失效</li>
<li>少用or，用它连接时会索引失效</li>
</ol>
<blockquote>
<p> <strong>最佳左匹配法则：带头大哥不能死，中间兄弟不能断</strong></p>
</blockquote>
<p>只有带头大哥 name 时</p>
<ul>
<li>key = index_staffs_nameAgePos 表明索引生效</li>
<li>ref = const ：这个常量就是查询时的 ‘July’ 字符串常量</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>带头大哥 name 带上小弟 age</p>
<ul>
<li>key = index_staffs_nameAgePos 表明索引生效</li>
<li>ref = const,const：两个常量分别为 ‘July’ 和 23</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND age = 23;
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref         | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | const,const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>带头大哥 name 带上小弟 age ，小弟 age 带上小小弟 pos</p>
<ul>
<li>key = index_staffs_nameAgePos 表明索引生效</li>
<li>ref = const,const,const ：三个常量分别为 ‘July’、23 和 ‘dev’</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND age = 23 AND pos = 'dev';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref               | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>带头大哥 name 挂了</p>
<ul>
<li>key = NULL 说明索引失效</li>
<li>ref = null 表示 ref 也失效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE age = 23 AND pos = 'dev';
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | NULL          | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><p>带头大哥 name 没挂，小弟 age 跑了</p>
<ul>
<li>key = index_staffs_nameAgePos 说明索引没有失效</li>
<li>ref = const 表明只使用了一个常量，即第二个常量（pos = ‘dev’）没有生效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND pos = 'dev';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>在索引列上进行计算，会导致索引失效，进而转向全表扫描</strong></p>
</blockquote>
<ul>
<li>不对带头大哥 name 进行任何操作：key = index_staffs_nameAgePos 表明索引生效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>对带头大哥 name 进行操作：使用 LEFT 函数截取子串</p>
<ul>
<li>key = NULL 表明索引生效</li>
<li>type = ALL 表明进行了全表扫描</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE LEFT(name,4) = 'July';
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | NULL          | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>范围之后全失效</strong></p>
</blockquote>
<ul>
<li>精确匹配<ul>
<li>type = ref 表示非唯一索引扫描，SQL 语句将返回匹配某个单独值的所有行。</li>
<li>key_len = 140 表明表示索引中使用的字节数</li>
</ul>
</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND age = 23 AND pos = 'dev';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref               | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>将 age 改为范围匹配</p>
<ul>
<li>type = range 表示范围扫描</li>
<li>key = index_staffs_nameAgePos 表示索引并没有失效</li>
<li>key_len = 78 ，ref = NULL 均表明范围搜索使其后面的索引均失效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND age &gt; 23 AND pos = 'dev';
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys           | key                     | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | staffs | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少 <code>select *</code></strong></p>
</blockquote>
<ul>
<li><code>SELECT *</code> 的写法</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name = 'July'AND age &gt; 23 AND pos = 'dev';
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys           | key                     | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | staffs | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>覆盖索引的写法：Extra = Using where; Using index ，Using index 表示使用索引列进行查询，将大大提高查询的效率</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT name, age, pos FROM staffs WHERE name = 'July'AND age = 23 AND pos = 'dev';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+--------------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref               | rows | Extra                    |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+--------------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 | Using where; Using index |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------------------+------+--------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>覆盖索引中包含 range 条件：type = ref 并且 Extra = Using where; Using index ，虽然在查询条件中使用了 范围搜索，但是由于我们只需要查找索引列，所以无需进行全表扫描</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT name, age, pos FROM staffs WHERE name = 'July'AND age &gt; 23 AND pos = 'dev';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref   | rows | Extra                    |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 | Using where; Using index |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>mysql在使用不等于（!=或者&lt;&gt;）的时候无法使用索引会导致全表扫描</strong></p>
</blockquote>
<ul>
<li>在使用 != 会 &lt;&gt; 时会导致索引失效：<ul>
<li>key = null 表示索引失效</li>
<li>rows = 3 表示进行了全表扫描</li>
</ul>
</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name != 'July';
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys           | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name &lt;&gt; 'July';
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys           | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>is null，is not null 也无法使用索引</strong></p>
</blockquote>
<ul>
<li>is null，is not null 会导致索引失效：key = null 表示索引失效</li>
</ul>
<pre><code>ysql&gt; EXPLAIN SELECT * FROM staffs WHERE name is null;
+----+-------------+-------+------+---------------+------+---------+------+------+------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra            |
+----+-------------+-------+------+---------------+------+---------+------+------+------------------+
|  1 | SIMPLE      | NULL  | NULL | NULL          | NULL | NULL    | NULL | NULL | Impossible WHERE |
+----+-------------+-------+------+---------------+------+---------+------+------+------------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name is not null;
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys           | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>like % 写最右原则</strong></p>
</blockquote>
<ul>
<li>staffs 表的索引关系</li>
</ul>
<pre><code>mysql&gt; SHOW INDEX from staffs;
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name                | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| staffs |          0 | PRIMARY                 |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            1 | name        | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            2 | age         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            3 | pos         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)</code></pre><blockquote>
<p> like % 写在左边的情况</p>
</blockquote>
<ul>
<li>type = All ，rows = 3 表示进行了全表扫描</li>
<li>key = null 表示索引失效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name like '%July';
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | NULL          | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name like '%July%';
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | NULL          | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>like % 写在右边的情况：key = index_staffs_nameAgePos 表示索引未失效</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM staffs WHERE name like 'July%';
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys           | key                     | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | staffs | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+-------------------------+-------------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>解决【like ‘%str%’ 】索引失效的问题：覆盖索引</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tbl_user<span class="token punctuation">`</span><span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>email<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_user<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'1aa1'</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token string">'a@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_user<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'2bb2'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'b@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_user<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'3cc3'</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">'c@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tbl_user<span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'4dd4'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token string">'d@163.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>tbl_user 表中的测试数据</li>
</ul>
<pre><code>mysql&gt; select * from tbl_user;
+----+------+------+-----------+
| id | name | age  | email     |
+----+------+------+-----------+
|  1 | 1aa1 |   21 | a@163.com |
|  2 | 2bb2 |   23 | b@163.com |
|  3 | 3cc3 |   24 | c@163.com |
|  4 | 4dd4 |   26 | d@163.com |
+----+------+------+-----------+
4 rows in set (0.00 sec)</code></pre><p>创建索引</p>
<ul>
<li>创建索引的 SQL 指令</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">CREATE INDEX idx_user_nameAge ON tbl_user(name, age);</code></pre>
<ul>
<li>在 tbl_user 表的 name 字段和 age 字段创建联合索引</li>
</ul>
<pre><code>mysql&gt; CREATE INDEX idx_user_nameAge ON tbl_user(name, age);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; SHOW INDEX FROM tbl_user;
+----------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table    | Non_unique | Key_name         | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+----------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| tbl_user |          0 | PRIMARY          |            1 | id          | A         |           4 |     NULL | NULL   |      | BTREE      |         |               |
| tbl_user |          1 | idx_user_nameAge |            1 | name        | A         |           4 |     NULL | NULL   | YES  | BTREE      |         |               |
| tbl_user |          1 | idx_user_nameAge |            2 | age         | A         |           4 |     NULL | NULL   | YES  | BTREE      |         |               |
+----------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
3 rows in set (0.00 sec)</code></pre><p><strong>测试覆盖索引</strong></p>
<ul>
<li>如下 SQL 的索引均不会失效：<ul>
<li>只要查询的字段能和覆盖索引扯得上关系，并且没有多余字段，覆盖索引就不会失效</li>
</ul>
</li>
</ul>
<pre><code>EXPLAIN SELECT name, age FROM tbl_user WHERE NAME LIKE '%aa%';

EXPLAIN SELECT name FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT age FROM tbl_user WHERE NAME LIKE '%aa%';

EXPLAIN SELECT id FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id, name FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id, age FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id, name, age FROM tbl_user WHERE NAME LIKE '%aa%';</code></pre><pre><code>mysql&gt; EXPLAIN SELECT id FROM tbl_user WHERE NAME LIKE '%aa%';
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
| id | select_type | table    | type  | possible_keys | key              | key_len | ref  | rows | Extra                    |
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
|  1 | SIMPLE      | tbl_user | index | NULL          | idx_user_nameAge | 68      | NULL |    4 | Using where; Using index |
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT name, age FROM tbl_user WHERE NAME LIKE '%aa%';
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
| id | select_type | table    | type  | possible_keys | key              | key_len | ref  | rows | Extra                    |
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
|  1 | SIMPLE      | tbl_user | index | NULL          | idx_user_nameAge | 68      | NULL |    4 | Using where; Using index |
+----+-------------+----------+-------+---------------+------------------+---------+------+------+--------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>如下 SQL 的索引均会失效：但凡有多余字段，覆盖索引就会失效</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_user <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> email <span class="token keyword">FROM</span> tbl_user <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%aa%'</span><span class="token punctuation">;</span></code></pre>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tbl_user WHERE NAME LIKE '%aa%';
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | tbl_user | ALL  | NULL          | NULL | NULL    | NULL |    4 | Using where |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT id, name, age, email FROM tbl_user WHERE NAME LIKE '%aa%';
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table    | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | tbl_user | ALL  | NULL          | NULL | NULL    | NULL |    4 | Using where |
+----+-------------+----------+------+---------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>字符串不加单引号索引失效</strong></p>
</blockquote>
<ul>
<li>正常操作，索引没有失效</li>
</ul>
<pre><code>mysql&gt; SHOW INDEX FROM staffs;
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name                | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| staffs |          0 | PRIMARY                 |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            1 | name        | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            2 | age         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            3 | pos         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)

mysql&gt; explain select * from staffs where name='2000';
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys           | key                     | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | staffs | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 | Using index condition |
+----+-------------+--------+------+-------------------------+-------------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>如果字符串忘记写 ‘’ ，那么 mysql 会为我们进行隐式的类型转换，但凡进行了类型转换，索引都会失效</li>
</ul>
<pre><code>mysql&gt; explain select * from staffs where name=2000;
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys           | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>少用or，用它连接时会索引失效</strong></p>
</blockquote>
<ul>
<li>使用 or 连接，会导致索引失效</li>
</ul>
<pre><code>mysql&gt; SHOW INDEX FROM staffs;
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name                | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| staffs |          0 | PRIMARY                 |            1 | id          | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            1 | name        | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            2 | age         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
| staffs |          1 | index_staffs_nameAgePos |            3 | pos         | A         |           3 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)

mysql&gt; explain select * from staffs where name='z3' or name = 'July';
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys           | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | staffs | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 | Using where |
+----+-------------+--------+------+-------------------------+------+---------+------+------+-------------+
1 row in set (0.00 sec)</code></pre><h3 id="6-2、索引优化面试题"><a href="#6-2、索引优化面试题" class="headerlink" title="6.2、索引优化面试题"></a>6.2、索引优化面试题</h3><blockquote>
<p><strong>索引优化面试题</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> test03<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    <span class="token number">c1</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">c2</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">c3</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">c4</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">c5</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">,</span><span class="token number">c5</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'a1'</span><span class="token punctuation">,</span><span class="token string">'a2'</span><span class="token punctuation">,</span><span class="token string">'a3'</span><span class="token punctuation">,</span><span class="token string">'a4'</span><span class="token punctuation">,</span><span class="token string">'a5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">,</span><span class="token number">c5</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'b1'</span><span class="token punctuation">,</span><span class="token string">'b2'</span><span class="token punctuation">,</span><span class="token string">'b3'</span><span class="token punctuation">,</span><span class="token string">'b4'</span><span class="token punctuation">,</span><span class="token string">'b5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">,</span><span class="token number">c5</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'c1'</span><span class="token punctuation">,</span><span class="token string">'c2'</span><span class="token punctuation">,</span><span class="token string">'c3'</span><span class="token punctuation">,</span><span class="token string">'c4'</span><span class="token punctuation">,</span><span class="token string">'c5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">,</span><span class="token number">c5</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'d1'</span><span class="token punctuation">,</span><span class="token string">'d2'</span><span class="token punctuation">,</span><span class="token string">'d3'</span><span class="token punctuation">,</span><span class="token string">'d4'</span><span class="token punctuation">,</span><span class="token string">'d5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">,</span><span class="token number">c5</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'e1'</span><span class="token punctuation">,</span><span class="token string">'e2'</span><span class="token punctuation">,</span><span class="token string">'e3'</span><span class="token punctuation">,</span><span class="token string">'e4'</span><span class="token punctuation">,</span><span class="token string">'e5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_test03_c1234 <span class="token keyword">on</span> test03<span class="token punctuation">(</span><span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span><span class="token punctuation">,</span><span class="token number">c4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>问题：我们创建了复合索引idx_test03_c1234，根据以下SQL分析下索引使用情况？</strong></p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c3='a3' AND c4='a4';</code></li>
<li>即全值匹配</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c3='a3' AND c4='a4';
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref                     | rows | Extra                 |
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 124     | const,const,const,const |    1 | Using index condition |
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c4='a4' AND c3='a3' AND c2='a2' AND c1='a1';</code></li>
<li>mysql 优化器进行了优化，所以我们的索引都生效了</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c4='a4' AND c3='a3' AND c2='a2' AND c1='a1';
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref                     | rows | Extra                 |
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 124     | const,const,const,const |    1 | Using index condition |
+----+-------------+--------+------+------------------+------------------+---------+-------------------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c3&gt;'a3' AND c4='a4';</code></li>
<li>c3 列使用了索引进行排序，并没有进行查找，导致 c4 无法用索引进行查找</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c3&gt;'a3' AND c4='a4'; 
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys    | key              | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | test03 | range | idx_test03_c1234 | idx_test03_c1234 | 93      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c4&gt;'a4' AND c3='a3';</code></li>
<li>mysql 优化器进行了优化，所以我们的索引都生效了，在 c4 时进行了范围搜索</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c4&gt;'a4' AND c3='a3'; 
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys    | key              | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | test03 | range | idx_test03_c1234 | idx_test03_c1234 | 124     | NULL |    1 | Using index condition |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c4='a4' ORDER BY c3;</code></li>
<li>c3 列将索引用于排序，而不是查找，c4 列没有用到索引</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c4='a4' ORDER BY c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c3;</code></li>
<li>c3用到了排序，没用到查找，也算是用到了，但是没有统计进来。c4 列都没有用到索引</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c4;</code></li>
<li>因为索引建立的顺序和使用的顺序不一致，导致 mysql 动用了文件排序</li>
<li>看到 Using filesort 就要知道：此句 SQL 必须优化</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c4; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+----------------------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+----------------------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where; Using filesort |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+----------------------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><p><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c5='a5' ORDER BY c2, c3;</code></p>
</li>
<li><p>只用 c1 一个字段索引，但是c2、c3用于排序，无filesort</p>
</li>
<li><p>难道因为排序的时候，c2 紧跟在 c1 之后，所以就不用 filesort 吗？</p>
</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c5='a5' ORDER BY c2, c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c5='a5' ORDER BY c3, c2;</code></li>
<li>出现了filesort，我们建的索引是1234，它没有按照顺序来，32颠倒了</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c5='a5' ORDER BY c3, c2; 
+----+-------------+--------+------+------------------+------------------+---------+-------+------+----------------------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                                              |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+----------------------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition; Using where; Using filesort |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+----------------------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c2, c3;</code></li>
<li>用c1、c2两个字段索引，但是c2、c3用于排序，无filesort</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' ORDER BY c2, c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c5='a5' ORDER BY c2, c3;</code></li>
<li>和 c5 这个坑爹货没啥关系</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c5='a5' ORDER BY c2, c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c5='a5' ORDER BY c3, c2;</code></li>
<li>注意查询条件 c2=‘a2’ ，我都把 c2 查出来了（c2 为常量），我还给它排序作甚，所以没有产生 filesort</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2='a2' AND c5='a5' ORDER BY c3, c2; 
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref         | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 62      | const,const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c4='a4' GROUP BY c2, c3;</code></li>
<li>顺序为 1 2 3 ，没有产生文件排序</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c4='a4' GROUP BY c2, c3; 
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                              |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition; Using where |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li><code>EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c4='a4' GROUP BY c3, c2;</code></li>
<li>group by 表面上叫分组，分组之前必排序，group by 和 order by 在索引上的问题基本是一样的</li>
<li>Using temporary; Using filesort 两个都有，我只能说是灭绝师太</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c4='a4' GROUP BY c3, c2; 
+----+-------------+--------+------+------------------+------------------+---------+-------+------+---------------------------------------------------------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                                                               |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+---------------------------------------------------------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition; Using where; Using temporary; Using filesort |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+---------------------------------------------------------------------+
1 row in set (0.01 sec)</code></pre><p>结论：</p>
<ul>
<li>group by 基本上都需要进行排序，但凡使用不当，会有临时表产生</li>
<li>定值为常量、范围之后失效，最终看排序的顺序</li>
</ul>
<h3 id="6-3、索引失效总结"><a href="#6-3、索引失效总结" class="headerlink" title="6.3、索引失效总结"></a>6.3、索引失效总结</h3><blockquote>
<p><strong>一般性建议</strong></p>
</blockquote>
<ol>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠左越好。</li>
<li>在选择组合索引的时候，尽量选择可以能包含当前query中的where子句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
</ol>
<blockquote>
<p><strong>索引优化的总结</strong></p>
</blockquote>
<ul>
<li>like 后面以常量开头，比如 like ‘kk%’ 和 like ‘k%kk%’ ，可以理解为就是常量</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b90f429227d6c5d1c504ad147d8f424b.png" alt="image-20200804162716329"></p>
<p><strong>like SQL 实测</strong></p>
<ul>
<li>= ‘kk’ ：key_len = 93 ，请记住此参数的值，后面有用</li>
</ul>
<pre><code>----+-------------+--------+------+------------------+------------------+---------+-------------------+------+-----------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref               | rows | Extra                 |
+----+-------------+--------+------+------------------+------------------+---------+-------------------+------+-----------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 93      | const,const,const |    1 | Using index condition |
+----+-------------+--------+------+------------------+------------------+---------+-------------------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><p>like ‘kk%’：</p>
<ul>
<li>key_len = 93 ，和上面一样，说明 c1 c2 c3 都用到了索引</li>
<li>type = range 表明这是一个范围搜索</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2 like 'kk%' AND c3='a3';
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys    | key              | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | test03 | range | idx_test03_c1234 | idx_test03_c1234 | 93      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>like ‘%kk’ 和 like ‘%kk%’ ：key_len = 31 ，表示只有 c1 用到了索引</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2 like '%kk' AND c3='a3';
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2 like '%kk%' AND c3='a3';
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
| id | select_type | table  | type | possible_keys    | key              | key_len | ref   | rows | Extra                 |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
|  1 | SIMPLE      | test03 | ref  | idx_test03_c1234 | idx_test03_c1234 | 31      | const |    1 | Using index condition |
+----+-------------+--------+------+------------------+------------------+---------+-------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>like ‘k%kk%’ ：key_len = 93 ，表示 c1 c2 c3 都用到了索引</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM test03 WHERE c1='a1' AND c2 like 'k%kk%' AND c3='a3';
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
| id | select_type | table  | type  | possible_keys    | key              | key_len | ref  | rows | Extra                 |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
|  1 | SIMPLE      | test03 | range | idx_test03_c1234 | idx_test03_c1234 | 93      | NULL |    1 | Using index condition |
+----+-------------+--------+-------+------------------+------------------+---------+------+------+-----------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>索引优化的总结</strong></p>
</blockquote>
<p>全值匹配我最爱， 最左前缀要遵守；</p>
<p>带头大哥不能死， 中间兄弟不能断；</p>
<p>索引列上少计算， 范围之后全失效；</p>
<p>LIKE 百分写最右， 覆盖索引不写 *；</p>
<p>不等空值还有 OR， 索引影响要注意；</p>
<p>VAR 引号不可丢， SQL 优化有诀窍。</p>
<h2 id="第-4-章-查询截取分析"><a href="#第-4-章-查询截取分析" class="headerlink" title="第 4 章 查询截取分析"></a>第 4 章 查询截取分析</h2><h3 id="1、查询优化"><a href="#1、查询优化" class="headerlink" title="1、查询优化"></a>1、查询优化</h3><h4 id="1-1、MySQL-优化原则"><a href="#1-1、MySQL-优化原则" class="headerlink" title="1.1、MySQL 优化原则"></a>1.1、MySQL 优化原则</h4><blockquote>
<p><strong>mysql 的调优大纲</strong></p>
</blockquote>
<ol>
<li>慢查询的开启并捕获</li>
<li>explain+慢SQL分析</li>
<li>show profile查询SQL在Mysql服务器里面的执行细节和生命周期情况</li>
<li>SQL数据库服务器的参数调优</li>
</ol>
<blockquote>
<p><strong>永远小表驱动大表，类似嵌套循环 Nested Loop</strong></p>
</blockquote>
<ul>
<li>EXISTS 语法：<ul>
<li><code>SELECT ... FROM table WHERE EXISTS(subquery)</code></li>
<li>该语法可以理解为：将查询的数据，放到子查询中做条件验证，根据验证结果（TRUE或FALSE）来决定主查询的数据结果是否得以保留。</li>
</ul>
</li>
<li>EXISTS(subquery) 只返回TRUE或FALSE，因此子查询中的<code>SELECT *</code>也可以是<code>SELECT 1</code>或其他，官方说法是实际执行时会忽略SELECT清单，因此没有区别</li>
<li>EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</li>
<li>EXISTS子查询往往也可以用条件表达式、其他子查询或者JOIN来替代，何种最优需要具体问题具体分析</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ae1d7b7768c672c484694ff4f284edfe.png" alt="image-20200805101726632"></p>
<p><strong>结论：</strong></p>
<ol>
<li>永远记住小表驱动大表</li>
<li>当 B 表数据集小于 A 表数据集时，使用 in</li>
<li>当 A 表数据集小于 B 表数据集时，使用 exist</li>
</ol>
<p><strong>in 和 exists 的用法</strong></p>
<ul>
<li>in 的写法</li>
</ul>
<pre><code>mysql&gt; select * from tbl_emp e where e.deptId in (select id from tbl_dept);
+----+------+--------+
| id | NAME | deptId |
+----+------+--------+
|  1 | z3   |      1 |
|  2 | z4   |      1 |
|  3 | z5   |      1 |
|  4 | w5   |      2 |
|  5 | w6   |      2 |
|  6 | s7   |      3 |
|  7 | s8   |      4 |
+----+------+--------+
7 rows in set (0.00 sec)</code></pre><ul>
<li>exists 的写法</li>
</ul>
<pre><code>mysql&gt; select * from tbl_emp e where exists (select 1 from tbl_dept d where e.deptId = d.id);
+----+------+--------+
| id | NAME | deptId |
+----+------+--------+
|  1 | z3   |      1 |
|  2 | z4   |      1 |
|  3 | z5   |      1 |
|  4 | w5   |      2 |
|  5 | w6   |      2 |
|  6 | s7   |      3 |
|  7 | s8   |      4 |
+----+------+--------+
7 rows in set (0.00 sec)</code></pre><h4 id="1-2、ORDER-BY-优化"><a href="#1-2、ORDER-BY-优化" class="headerlink" title="1.2、ORDER BY 优化"></a>1.2、ORDER BY 优化</h4><blockquote>
<p><strong>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> tblA<span class="token punctuation">(</span>
    <span class="token comment" spellcheck="true">#id int primary key not null auto_increment,</span>
    age <span class="token keyword">int</span><span class="token punctuation">,</span>
    birth <span class="token keyword">timestamp</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_A_ageBirth <span class="token keyword">on</span> tblA<span class="token punctuation">(</span>age<span class="token punctuation">,</span> birth<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>CASE1：能使用索引进行排序的情况</strong></p>
<ul>
<li>只有带头大哥 age</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA where age&gt;20 order by age;
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
| id | select_type | table | type  | possible_keys  | key            | key_len | ref  | rows | Extra                    |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
|  1 | SIMPLE      | tblA  | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 | Using where; Using index |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
1 row in set (0.01 sec)

mysql&gt; EXPLAIN SELECT * FROM tblA where birth&gt;'2016-01-28 00:00:00' order by age;
+----+-------------+-------+-------+---------------+----------------+---------+------+------+--------------------------+
| id | select_type | table | type  | possible_keys | key            | key_len | ref  | rows | Extra                    |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+--------------------------+
|  1 | SIMPLE      | tblA  | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 | Using where; Using index |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+--------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>带头大哥 age + 小弟 birth</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA where age&gt;20 order by age,birth;
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
| id | select_type | table | type  | possible_keys  | key            | key_len | ref  | rows | Extra                    |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
|  1 | SIMPLE      | tblA  | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 | Using where; Using index |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+--------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>mysql 默认升序排列，全升序或者全降序，都扛得住</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA ORDER BY age ASC, birth ASC;
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
| id | select_type | table | type  | possible_keys | key            | key_len | ref  | rows | Extra       |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
|  1 | SIMPLE      | tblA  | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 | Using index |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
1 row in set (0.00 sec)

mysql&gt; EXPLAIN SELECT * FROM tblA ORDER BY age DESC, birth DESC;
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
| id | select_type | table | type  | possible_keys | key            | key_len | ref  | rows | Extra       |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
|  1 | SIMPLE      | tblA  | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 | Using index |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-------------+
1 row in set (0.01 sec)</code></pre><p><strong>CASE2：不能使用索引进行排序的情况</strong></p>
<ul>
<li>带头大哥 age 挂了</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA where age&gt;20 order by birth;
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
| id | select_type | table | type  | possible_keys  | key            | key_len | ref  | rows | Extra                                    |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
|  1 | SIMPLE      | tblA  | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 | Using where; Using index; Using filesort |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
1 row in set (0.01 sec)</code></pre><ul>
<li>小弟 birth 居然敢在带头大哥 age 前面</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA where age&gt;20 order by birth,age;
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
| id | select_type | table | type  | possible_keys  | key            | key_len | ref  | rows | Extra                                    |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
|  1 | SIMPLE      | tblA  | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 | Using where; Using index; Using filesort |
+----+-------------+-------+-------+----------------+----------------+---------+------+------+------------------------------------------+
1 row in set (0.00 sec)</code></pre><ul>
<li>mysql 默认升序排列，如果全升序或者全降序，都 ok ，但是一升一降 mysql 就扛不住了</li>
</ul>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM tblA ORDER BY age ASC, birth DESC;
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-----------------------------+
| id | select_type | table | type  | possible_keys | key            | key_len | ref  | rows | Extra                       |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-----------------------------+
|  1 | SIMPLE      | tblA  | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 | Using index; Using filesort |
+----+-------------+-------+-------+---------------+----------------+---------+------+------+-----------------------------+
1 row in set (0.00 sec)</code></pre><p><strong>结论</strong></p>
<ol>
<li>MySQL支持二种方式的排序，FileSort和Index，<strong>Index效率高，它指MySQL扫描索引本身完成排序</strong>，FileSort方式效率较低。</li>
<li>ORDER BY满足两情况（最佳左前缀原则），会使用Index方式排序<ol>
<li>ORDER BY语句使用索引最左前列</li>
<li>使用where子句与OrderBy子句条件列组合满足索引最左前列</li>
</ol>
</li>
<li>尽可能在索引列上完成排序操作，遵照索引建的<strong>最佳左前缀</strong></li>
</ol>
<blockquote>
<p><strong>如果未在索引列上完成排序，mysql 会启动 filesort 的两种算法：双路排序和单路排序</strong></p>
</blockquote>
<ul>
<li>双路排序<ul>
<li>MySQL4.1之前是使用双路排序，字面意思是两次扫描磁盘，最终得到数据。读取行指针和将要进行orderby操作的列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据传输</li>
<li>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</li>
</ul>
</li>
<li>单路排序<ul>
<li>取一批数据，要对磁盘进行两次扫描，众所周知，I/O是很耗时的，所以在mysql4.1之后，出现了改进的算法，就是单路排序。</li>
<li>从磁盘读取查询需要的所有列，按照将要进行orderby的列，在sort buffer对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据，并且把随机IO变成顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li>
</ul>
</li>
<li>结论及引申出的问题：<ul>
<li>由于单路是改进的算法，总体而言好过双路</li>
<li>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出，<strong>所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取取sort_buffer容量大小，再排…… 从而会导致多次I/O。</strong></li>
<li>结论：本来想省一次I/O操作，反而导致了大量的/O操作，反而得不偿失。</li>
</ul>
</li>
<li>更深层次的优化策略：<ul>
<li>增大sort_buffer_size参数的设置</li>
<li>增大max_length_for_sort_data参数的设置</li>
</ul>
</li>
</ul>
<p><strong>遵循如下规则，可提高Order By的速度</strong></p>
<ul>
<li>Order by时select *是一个大忌，只Query需要的字段，这点非常重要。在这里的影响是：<ul>
<li><strong>当Query的字段大小总和小于max_length_for_sort_data</strong>，<strong>而且排序字段不是TEXT|BLOB类型时</strong>，会用改进后的算法——单路排序，否则用老算法——多路排序。</li>
<li>两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建tmp文件进行合并排序，导致多次I/O，但是用单路排序算法的风险会更大一些，所以要提高sort_buffer_size。</li>
</ul>
</li>
<li>尝试提高 sort_buffer_size不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的</li>
<li>尝试提高max_length_for_sort_data提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I/O活动和低的处理器使用率。</li>
</ul>
<blockquote>
<p><strong>Order By 排序索引优化的总结</strong></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/0c88f6d981ceaa6d99490c37a92da354.png" alt="image-20200805111725731"></p>
<h4 id="1-3、GROUP-BY-优化"><a href="#1-3、GROUP-BY-优化" class="headerlink" title="1.3、GROUP BY 优化"></a>1.3、GROUP BY 优化</h4><blockquote>
<p><strong>group by关键字优化</strong></p>
</blockquote>
<ol>
<li>group by实质是<strong>先排序后进行分组，遵照索引的最佳左前缀</strong></li>
<li>当无法使用索引列，增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置</li>
<li>where高于having，能写在where限定的条件就不要去having限定了</li>
<li>其余的规则均和 order by 一致</li>
</ol>
<h3 id="2、慢查询日志"><a href="#2、慢查询日志" class="headerlink" title="2、慢查询日志"></a>2、慢查询日志</h3><h4 id="2-1、慢查询日志介绍"><a href="#2-1、慢查询日志介绍" class="headerlink" title="2.1、慢查询日志介绍"></a>2.1、慢查询日志介绍</h4><blockquote>
<p><strong>慢查询日志是什么？</strong></p>
</blockquote>
<ol>
<li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来<strong>记录在MySQL中响应时间超过阀值的语句</strong>，具体指运行时间超过<strong>long_query_time</strong>值的SQL，则会被记录到慢查询日志中。</li>
<li>long_query_time的默认值为10，意思是运行10秒以上的SQL语句会被记录下来</li>
<li>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</li>
</ol>
<h4 id="2-2、慢查询日志开启"><a href="#2-2、慢查询日志开启" class="headerlink" title="2.2、慢查询日志开启"></a>2.2、慢查询日志开启</h4><blockquote>
<p><strong>怎么玩？</strong></p>
</blockquote>
<p><strong>说明：</strong></p>
<ol>
<li>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。</li>
<li>当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件</li>
</ol>
<p><strong>查看是否开启及如何开启</strong></p>
<ul>
<li>查看慢查询日志是否开启：<ul>
<li>默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的</li>
<li>可以通过设置<strong>slow_query_log</strong>的值来开启</li>
<li>通过<code>SHOW VARIABLES LIKE '%slow_query_log%';</code>查看 mysql 的慢查询日志是否开启</li>
</ul>
</li>
</ul>
<pre><code>mysql&gt; SHOW VARIABLES LIKE '%slow_query_log%';
+---------------------+-------------------------------+
| Variable_name       | Value                         |
+---------------------+-------------------------------+
| slow_query_log      | OFF                           |
| slow_query_log_file | /var/lib/mysql/Heygo-slow.log |
+---------------------+-------------------------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>如何开启开启慢查询日志：<ul>
<li><code>set global slow_query_log = 1;</code>开启慢查询日志</li>
<li>使用<code>set global slow_query_log=1</code>开启了慢查询日志只对当前数据库生效，如果MySQL重启后则会失效。</li>
</ul>
</li>
</ul>
<pre><code>mysql&gt; set global slow_query_log = 1;
Query OK, 0 rows affected (0.07 sec)

mysql&gt; SHOW VARIABLES LIKE '%slow_query_log%';
+---------------------+-------------------------------+
| Variable_name       | Value                         |
+---------------------+-------------------------------+
| slow_query_log      | ON                            |
| slow_query_log_file | /var/lib/mysql/Heygo-slow.log |
+---------------------+-------------------------------+
2 rows in set (0.00 sec)</code></pre><ul>
<li>如果要永久生效，就必须修改配置文件my.cnf（其它系统变量也是如此）<ul>
<li>修改my.cnf文件，[mysqld]下增加或修改参数：slow_query_log和slow_query_log_file后，然后重启MySQL服务器。</li>
<li>也即将如下两行配置进my.cnf文件</li>
</ul>
</li>
</ul>
<pre><code>[mysqld]
slow_query_log =1
slow_query_log_file=/var/lib/mysql/Heygo-slow.log</code></pre><ul>
<li>关于慢查询的参数slow_query_log_file，它指定慢查询日志文件的存放路径，系统默认会给一个缺省的文件host_name-slow.log（如果没有指定参数slow_query_log_file的话）</li>
</ul>
<p><strong>那么开启慢查询日志后，什么样的SQL参会记录到慢查询里面？</strong></p>
<ul>
<li>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，命令：<code>SHOW VARIABLES LIKE 'long_query_time%';</code>查看慢 SQL 的阈值</li>
</ul>
<pre><code>mysql&gt; SHOW VARIABLES LIKE 'long_query_time%';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.01 sec)</code></pre><ul>
<li>可以使用命令修改，也可以在my.cnf参数里面修改。</li>
<li>假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</li>
</ul>
<h4 id="2-3、慢查询日志示例"><a href="#2-3、慢查询日志示例" class="headerlink" title="2.3、慢查询日志示例"></a>2.3、慢查询日志示例</h4><blockquote>
<p><strong>案例讲解</strong></p>
</blockquote>
<ul>
<li>查看慢 SQL 的阈值时间，默认阈值时间为 10s</li>
</ul>
<pre><code>mysql&gt; SHOW VARIABLES LIKE 'long_query_time%';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)</code></pre><ul>
<li>设置慢 SQL 的阈值时间，我们将其设置为 3s</li>
</ul>
<pre><code>mysql&gt; set global long_query_time=3;
Query OK, 0 rows affected (0.00 sec)</code></pre><p><strong>为什么设置后阈值时间没变？</strong></p>
<ul>
<li>需要重新连接或者新开一个回话才能看到修改值。</li>
<li>查看全局的 long_query_time 值：<code>show global variables like 'long_query_time';</code>发现已经生效</li>
</ul>
<pre><code>mysql&gt; set global long_query_time=3;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE 'long_query_time%';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)

mysql&gt; show global variables like 'long_query_time';
+-----------------+----------+
| Variable_name   | Value    |
+-----------------+----------+
| long_query_time | 3.000000 |
+-----------------+----------+
1 row in set (0.00 sec)</code></pre><p>记录慢 SQL 以供后续分析</p>
<ul>
<li>怼个 select sleep(4); 超过 3s ，肯定会被记录到日志中</li>
</ul>
<pre><code>mysql&gt; select sleep(4); 
+----------+
| sleep(4) |
+----------+
|        0 |
+----------+
1 row in set (4.00 sec)</code></pre><ul>
<li>慢查询日志文件在 /var/lib/mysql/ 下，后缀为 -slow.log</li>
</ul>
<pre><code>[root@Heygo mysql]# cd /var/lib/mysql/
[root@Heygo mysql]# ls -l
总用量 176156
-rw-rw----. 1 mysql mysql       56 8月   3 19:08 auto.cnf
drwx------. 2 mysql mysql     4096 8月   5 10:36 db01
-rw-rw----. 1 mysql mysql     7289 8月   3 22:38 Heygo.err
-rw-rw----. 1 mysql mysql      371 8月   5 12:58 Heygo-slow.log
-rw-rw----. 1 mysql mysql 79691776 8月   5 10:36 ibdata1
-rw-rw----. 1 mysql mysql 50331648 8月   5 10:36 ib_logfile0
-rw-rw----. 1 mysql mysql 50331648 8月   3 19:08 ib_logfile1
drwx------. 2 mysql mysql     4096 8月   3 19:08 mysql
srwxrwxrwx. 1 mysql mysql        0 8月   3 22:38 mysql.sock
drwx------. 2 mysql mysql     4096 8月   3 19:08 performance_schema</code></pre><ul>
<li>查看慢查询日志中的内容</li>
</ul>
<pre><code>[root@Heygo mysql]# cat Heygo-slow.log 
/usr/sbin/mysqld, Version: 5.6.49 (MySQL Community Server (GPL)). started with:
Tcp port: 3306  Unix socket: /var/lib/mysql/mysql.sock
Time                 Id Command    Argument
# Time: 200805 12:58:01
# User@Host: root[root] @ localhost []  Id:    11
# Query_time: 4.000424  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0
SET timestamp=1596603481;
select sleep(4);</code></pre><p><strong>查询当前系统中有多少条慢查询记录：</strong><code>show global status like '%Slow_queries%';</code></p>
<p><strong>配置版的慢查询日志</strong></p>
<p>在 /etc/my.cnf 文件的 [mysqld] 节点下配置</p>
<pre><code>slow_query_log=1；
slow_query_log_file=/var/lib/mysql/Heygo-slow.log 
long_query_time=3；
log_output=FILE</code></pre><blockquote>
<p><strong>日志分析命令 mysqldumpslow</strong></p>
</blockquote>
<p><strong>mysqldumpslow是什么？</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。</p>
<p><strong>查看 mysqldumpslow的帮助信息</strong></p>
<pre><code> mysqldumpslow --help</code></pre><p><strong>mysqldumpshow 参数解释</strong></p>
<ol>
<li>s：是表示按何种方式排序</li>
<li>c：访问次数</li>
<li>l：锁定时间</li>
<li>r：返回记录</li>
<li>t：查询时间</li>
<li>al：平均锁定时间</li>
<li>ar：平均返回记录数</li>
<li>at：平均查询时间</li>
<li>t：即为返回前面多少条的数据</li>
<li>g：后边搭配一个正则匹配模式，大小写不敏感的</li>
</ol>
<p><strong>常用参数手册</strong></p>
<p>得到返回记录集最多的10个SQL</p>
<pre class=" language-sql"><code class="language-sql">mysqldumpslow <span class="token operator">-</span>s r <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>Heygo<span class="token operator">-</span>slow<span class="token punctuation">.</span>log</code></pre>
<p>得到访问次数最多的10个SQL</p>
<pre><code>mysqldumpslow -s c- t 10/var/lib/mysql/Heygo-slow.log</code></pre><p>得到按照时间排序的前10条里面含有左连接的查询语句</p>
<pre><code>mysqldumpslow -s t -t 10 -g "left join" /var/lib/mysql/Heygo-slow.log</code></pre><p>另外建议在使用这些命令时结合 | 和more使用，否则有可能出现爆屏情况</p>
<pre><code>mysqldumpslow -s r -t 10 /var/lib/mysql/Heygo-slow.log | more</code></pre><h3 id="3、批量数据脚本"><a href="#3、批量数据脚本" class="headerlink" title="3、批量数据脚本"></a>3、批量数据脚本</h3><blockquote>
<p><strong>创建表</strong></p>
</blockquote>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dept
<span class="token punctuation">(</span>
    deptno <span class="token keyword">int</span> unsigned <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    dname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">,</span>
    loc <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">""</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp
<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> unsigned <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    empno <span class="token keyword">mediumint</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ename <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">,</span>
    job <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">,</span>
    mgr <span class="token keyword">mediumint</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    hiredate <span class="token keyword">date</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    sal <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    comm <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    deptno <span class="token keyword">mediumint</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>设置参数</strong></p>
</blockquote>
<ul>
<li><p>创建函数，假如报错：This function has none of DETERMINISTIC………</p>
</li>
<li><p>由于开启过慢查询日志，因为我们开启了bin-log，我们就必须为我们的function指定一个参数。</p>
<ul>
<li><p><code>log_bin_trust_function_creators = OFF</code> ，默认必须为 function 传递一个参数</p>
<pre><code>mysql&gt; show variables like 'log_bin_trust_function_creators'; 
+---------------------------------+-------+
| Variable_name                   | Value |
+---------------------------------+-------+
| log_bin_trust_function_creators | OFF   |
+---------------------------------+-------+
1 row in set (0.00 sec)</code></pre></li>
<li><p>通过 <code>set global log_bin_trust_function_creators=1;</code>我们可以不用为 function 传参</p>
</li>
</ul>
</li>
</ul>
<pre><code>mysql&gt; set global log_bin_trust_function_creators=1; 
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show variables like 'log_bin_trust_function_creators';
+---------------------------------+-------+
| Variable_name                   | Value |
+---------------------------------+-------+
| log_bin_trust_function_creators | ON    |
+---------------------------------+-------+
1 row in set (0.00 sec)</code></pre><ul>
<li>这样添加了参数以后，如果mysqld重启，上述参数又会消失，永久方法在配置文件中修改‘<ul>
<li>windows下：my.ini –&gt; [mysqld] 节点下加上 <code>log_bin_trust_function_creators=1</code></li>
<li>linux下：/etc/my.cnf –&gt; [mysqld] 节点下加上 <code>log_bin_trust_function_creators=1</code></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>创建函数，保证每条数据都不同</strong></p>
</blockquote>
<ul>
<li>随机产生字符串的函数 </li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">delimiter</span> $$  <span class="token comment" spellcheck="true"># 设置为两个 $$ 表示结束</span>
<span class="token keyword">create</span> <span class="token keyword">function</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> chars_str <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">'abcdefghijklmnopqrstuvwxyz'</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> return_str <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> i <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> n <span class="token keyword">do</span>
        <span class="token keyword">set</span> return_str <span class="token operator">=</span> concat<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>substring<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>floor<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">end</span> $$</code></pre>
<ul>
<li>随机产生部门编号的函数</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">delimiter</span> $$
<span class="token keyword">create</span> <span class="token keyword">function</span> rand_num<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> i <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">set</span> i<span class="token operator">=</span>floor<span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token keyword">end</span> $$</code></pre>
<blockquote>
<p><strong>创建存储过程</strong></p>
</blockquote>
<ul>
<li>创建往emp表中插入数据的存储过程</li>
</ul>
<pre><code>delimiter $$
create procedure insert_emp(in start int(10),in max_num int(10))
begin
    declare i int default 0;
    set autocommit = 0;
    repeat
        set i = i+1;
        insert into emp(empno,ename,job,mgr,hiredate,sal,comm,deptno) values((start+i),rand_string(6),'salesman',0001,curdate(),2000,400,rand_num());
        until i=max_num
        end repeat;
    commit;
end $$</code></pre><ul>
<li>创建往dept表中插入数据的存储过程</li>
</ul>
<pre><code>delimiter $$
create procedure insert_dept(in start int(10),in max_num int(10))
begin
    declare i int default 0;
    set autocommit = 0;
    repeat
        set i = i+1;
        insert into dept(deptno,dname,loc) values((start+i),rand_string(10),rand_string(8));
        until i=max_num
        end repeat;
    commit;
end $$</code></pre><blockquote>
<p><strong>调用存储过程</strong></p>
</blockquote>
<ul>
<li>向 dept 表中插入 10 条记录</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">DELIMITER ;
CALL insert_dept(100, 10);</code></pre>
<ul>
<li>向 emp 表中插入 50w 条记录</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">DELIMITER ;
CALL insert_emp(100001, 500000);</code></pre>
<h3 id="4、Show-Profile"><a href="#4、Show-Profile" class="headerlink" title="4、Show Profile"></a>4、Show Profile</h3><blockquote>
<p><strong>Show Profile 是什么？</strong></p>
</blockquote>
<ol>
<li>是mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优测量</li>
<li>官网：<a href="http://dev.mysql.com/doc/refman/5.5/en/show-profile.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.5/en/show-profile.html</a></li>
<li>默认情况下，参数处于关闭状态，并保存最近15次的运行结果</li>
</ol>
<blockquote>
<p><strong>分析步骤</strong></p>
</blockquote>
<p><strong>查看是当前的SQL版本是否支持Show Profile</strong></p>
<ul>
<li>show variables like ‘profiling%’; 查看 Show Profile 是否开启</li>
</ul>
<pre><code>mysql&gt; show variables like 'profiling%';
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| profiling              | OFF   |
| profiling_history_size | 15    |
+------------------------+-------+
2 rows in set (0.01 sec)</code></pre><p><strong>开启功能 Show Profile ，默认是关闭，使用前需要开启</strong></p>
<ul>
<li><code>set profiling=on;</code> 开启 Show Profile</li>
</ul>
<pre><code>mysql&gt; set profiling=on; 
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql&gt; show variables like 'profiling%';
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| profiling              | ON    |
| profiling_history_size | 15    |
+------------------------+-------+
2 rows in set (0.00 sec)</code></pre><p><strong>运行SQL</strong></p>
<ul>
<li>正常 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp <span class="token number">e</span> <span class="token keyword">inner</span> <span class="token keyword">join</span> tbl_dept <span class="token number">d</span> <span class="token keyword">on</span> <span class="token number">e</span><span class="token punctuation">.</span>deptId <span class="token operator">=</span> <span class="token number">d</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_emp <span class="token number">e</span> <span class="token keyword">left</span> <span class="token keyword">join</span> tbl_dept <span class="token number">d</span> <span class="token keyword">on</span> <span class="token number">e</span><span class="token punctuation">.</span>deptId <span class="token operator">=</span> <span class="token number">d</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span></code></pre>
<ul>
<li>慢 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token operator">%</span><span class="token number">10</span> <span class="token keyword">limit</span> <span class="token number">150000</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token operator">%</span><span class="token number">10</span> <span class="token keyword">limit</span> <span class="token number">150000</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token operator">%</span><span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">5</span><span class="token punctuation">;</span></code></pre>
<p><strong>查看结果</strong></p>
<ul>
<li>通过 show profiles; 指令查看结果</li>
</ul>
<pre><code>mysql&gt; show profiles;
+----------+------------+----------------------------------------------------------------------+
| Query_ID | Duration   | Query                                                                |
+----------+------------+----------------------------------------------------------------------+
|        1 | 0.00052700 | show variables like 'profiling%'                                     |
|        2 | 0.00030300 | select * from tbl_emp                                                |
|        3 | 0.00010650 | select * from tbl_emp e inner join tbl_dept d on e.'deptId' = d.'id' |
|        4 | 0.00031625 | select * from tbl_emp e inner join tbl_dept d on e.deptId = d.id     |
|        5 | 0.00042100 | select * from tbl_emp e left join tbl_dept d on e.deptId = d.id      |
|        6 | 0.38621875 | select * from emp group by id%20 limit 150000                        |
|        7 | 0.00014900 | select * from emp group by id%20 order by 150000                     |
|        8 | 0.38649000 | select * from emp group by id%20 order by 5                          |
|        9 | 0.06782700 | select COUNT(*) from emp                                             |
|       10 | 0.35434400 | select * from emp group by id%10 limit 150000                        |
+----------+------------+----------------------------------------------------------------------+
10 rows in set, 1 warning (0.00 sec)</code></pre><p><strong>诊断SQL</strong></p>
<ul>
<li><code>show profile cpu, block io for query SQL编号;</code> 查看 SQL 语句执行的具体流程以及每个步骤花费的时间</li>
</ul>
<pre><code>mysql&gt; show profile cpu, block io for query 2;
+----------------------+----------+----------+------------+--------------+---------------+
| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |
+----------------------+----------+----------+------------+--------------+---------------+
| starting             | 0.000055 | 0.000000 |   0.000000 |            0 |             0 |
| checking permissions | 0.000007 | 0.000000 |   0.000000 |            0 |             0 |
| Opening tables       | 0.000011 | 0.000000 |   0.000000 |            0 |             0 |
| init                 | 0.000024 | 0.000000 |   0.000000 |            0 |             0 |
| System lock          | 0.000046 | 0.000000 |   0.000000 |            0 |             0 |
| optimizing           | 0.000018 | 0.000000 |   0.000000 |            0 |             0 |
| statistics           | 0.000008 | 0.000000 |   0.000000 |            0 |             0 |
| preparing            | 0.000019 | 0.000000 |   0.000000 |            0 |             0 |
| executing            | 0.000003 | 0.000000 |   0.000000 |            0 |             0 |
| Sending data         | 0.000089 | 0.000000 |   0.000000 |            0 |             0 |
| end                  | 0.000004 | 0.000000 |   0.000000 |            0 |             0 |
| query end            | 0.000003 | 0.000000 |   0.000000 |            0 |             0 |
| closing tables       | 0.000005 | 0.000000 |   0.000000 |            0 |             0 |
| freeing items        | 0.000006 | 0.000000 |   0.000000 |            0 |             0 |
| cleaning up          | 0.000006 | 0.000000 |   0.000000 |            0 |             0 |
+----------------------+----------+----------+------------+--------------+---------------+
15 rows in set, 1 warning (0.00 sec)</code></pre><ul>
<li>参数备注：</li>
</ul>
<ol>
<li>ALL：显示所有的开销信息</li>
<li>BLOCK IO：显示块IO相关开销</li>
<li>CONTEXT SWITCHES：上下文切换相关开销</li>
<li>CPU：显示CPU相关开销信息</li>
<li>IPC：显示发送和接收相关开销信息</li>
<li>MEMORY：显示内存相关开销信息</li>
<li>PAGE FAULTS：显示页面错误相关开销信息</li>
<li>SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息</li>
<li>SWAPS：显示交换次数相关开销的信息</li>
</ol>
<p><strong>日常开发需要注意的结论</strong></p>
<ol>
<li><strong>converting HEAP to MyISAM：</strong>查询结果太大，内存都不够用了往磁盘上搬了。</li>
<li><strong>Creating tmp table：</strong>创建临时表，mysql 先将拷贝数据到临时表，然后用完再将临时表删除</li>
<li><strong>Copying to tmp table on disk：</strong>把内存中临时表复制到磁盘，危险！！！</li>
<li><strong>locked：</strong>锁表</li>
</ol>
<p><strong>举例</strong></p>
<p>奇了怪了。。。老师的慢 SQL 复现不了，下面是老师的例子</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d3ab0ee45d1accb580c8f9cc8a9499de.png" alt="image-20200805143307302"></p>
<h3 id="5、全局查询日志"><a href="#5、全局查询日志" class="headerlink" title="5、全局查询日志"></a>5、全局查询日志</h3><p><strong>永远不要在生产环境开启这个功能。</strong></p>
<blockquote>
<p>配置启用全局查询日志</p>
</blockquote>
<ul>
<li>在mysql的my.cnf中，设置如下：</li>
</ul>
<pre><code># 开启
general_log=1

# 记录日志文件的路径
general_log_file=/path/logfile

# 输出格式
log_output=FILE</code></pre><blockquote>
<p><strong>编码启用全局查询日志</strong></p>
</blockquote>
<ul>
<li>执行如下指令开启全局查询日志</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">set global general_log=1;
set global log_output='TABLE';</code></pre>
<ul>
<li>此后，你所执行的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">select * from mysql.general_log;</code></pre>
<pre><code>mysql&gt; select * from mysql.general_log;
+---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+
| event_time          | user_host                 | thread_id | server_id | command_type | argument                                      |
+---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+
| 2020-08-05 14:41:07 | root[root] @ localhost [] |        14 |         0 | Query        | select * from emp group by id%10 limit 150000 |
| 2020-08-05 14:41:12 | root[root] @ localhost [] |        14 |         0 | Query        | select COUNT(*) from emp                      |
| 2020-08-05 14:41:30 | root[root] @ localhost [] |        14 |         0 | Query        | select * from mysql.general_log               |
+---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+
3 rows in set (0.00 sec)</code></pre><h2 id="第-5-章-MySQL-锁机制"><a href="#第-5-章-MySQL-锁机制" class="headerlink" title="第 5 章 MySQL 锁机制"></a>第 5 章 MySQL 锁机制</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><h4 id="1-1、锁的定义"><a href="#1-1、锁的定义" class="headerlink" title="1.1、锁的定义"></a>1.1、锁的定义</h4><blockquote>
<p><strong>锁的定义</strong></p>
</blockquote>
<ol>
<li>锁是计算机协调<strong>多个进程或线程并发访问某一资源的机制</strong>。</li>
<li>在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。</li>
<li>如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。</li>
<li>从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</li>
</ol>
<h4 id="1-2、锁的分类"><a href="#1-2、锁的分类" class="headerlink" title="1.2、锁的分类"></a>1.2、锁的分类</h4><blockquote>
<p><strong>锁的分类</strong></p>
</blockquote>
<ul>
<li>从数据操作的类型（读、写）分<ul>
<li><strong>读锁</strong>（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响</li>
<li><strong>写锁</strong>（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</li>
</ul>
</li>
<li>从对数据操作的颗粒度<ul>
<li>表锁</li>
<li>行锁</li>
</ul>
</li>
</ul>
<h3 id="2、表锁"><a href="#2、表锁" class="headerlink" title="2、表锁"></a>2、表锁</h3><blockquote>
<p><strong>表锁的特点</strong></p>
</blockquote>
<p><strong>偏向MyISAM存储引擎</strong>，开销小，加锁快，无死锁，锁定粒度大，<strong>发生锁冲突的概率最高，并发最低</strong></p>
<h4 id="2-1、表锁案例"><a href="#2-1、表锁案例" class="headerlink" title="2.1、表锁案例"></a>2.1、表锁案例</h4><blockquote>
<p><strong>表锁案例分析</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL：<strong>引擎选择 myisam</strong></li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> mylock <span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> myisam<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> mylock<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mylock<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mylock<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mylock<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mylock<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>手动加锁和释放锁</strong></p>
</blockquote>
<ul>
<li><p>查看当前数据库中表的上锁情况：<code>show open tables;</code>，0 表示未上锁</p>
</li>
<li><p>添加锁</p>
</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">lock table 表名1 read(write), 表名2 read(write), ...;</code></pre>
<ul>
<li>释放表锁 </li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">unlock tables;</code></pre>
<h5 id="2-1-1、读锁示例"><a href="#2-1-1、读锁示例" class="headerlink" title="2.1.1、读锁示例"></a>2.1.1、读锁示例</h5><blockquote>
<p><strong>读锁示例</strong></p>
</blockquote>
<ul>
<li>在 session 1 会话中，给 mylock 表加个读锁</li>
</ul>
<pre><code>mysql&gt; lock table mylock read;
Query OK, 0 rows affected (0.00 sec)</code></pre><ul>
<li>在 session1 会话中能不能读取 mylock 表：可以读</li>
<li>在 session1 会话中能不能读取 其他表：并不行。。。</li>
<li>在 session2 会话中能不能读取 mylock 表：可以读</li>
<li>在 session2 会话中能不能读取 其他  表：可以读</li>
<li>在 session1 会话中能不能修改 mylock 表：并不行。。。</li>
<li>在 session2 会话中能不能修改 mylock 表：阻塞，一旦 mylock 表锁释放，则会执行修改操作</li>
</ul>
<p><strong>结论</strong></p>
<ol>
<li>当前 session 和其他 session 均可以读取加了读锁的表</li>
<li>当前 session 不能读取其他表，并且不能修改加了读锁的表</li>
<li>其他 session 想要修改加了读锁的表，必须等待其读锁释放</li>
</ol>
<h5 id="2-1-2、写锁示例"><a href="#2-1-2、写锁示例" class="headerlink" title="2.1.2、写锁示例"></a>2.1.2、写锁示例</h5><blockquote>
<p><strong>写锁示例</strong></p>
</blockquote>
<ul>
<li>在 session 1 会话中，给 mylock 表加个写锁</li>
</ul>
<pre><code>mysql&gt; lock table mylock write;
Query OK, 0 rows affected (0.00 sec)</code></pre><ul>
<li>在 session1 会话中能不能读取 mylock 表：阔以</li>
<li>在 session1 会话中能不能读取 其他表：不阔以</li>
<li>在 session1 会话中能不能修改 mylock 表：当然可以，加写锁就是为了修改呀</li>
<li>在 session2 会话中能不能读取 mylock 表：不能</li>
<li>在 session2 会话中能不能读取 其他表：能</li>
</ul>
<p><strong>结论</strong></p>
<ol>
<li>当前 session 可以读取和修改加了写锁的表</li>
<li>当前 session 不能读取其他表</li>
<li>其他 session 想要读取加了写锁的表，必须等待其读锁释放</li>
</ol>
<blockquote>
<p><strong>案例结论</strong></p>
</blockquote>
<ol>
<li>MyISAM在执行查询语句（SELECT）前，会自动给涉及的所有表加<strong>读锁</strong>，在执行增删改操作前，会自动给涉及的表加<strong>写锁</strong>。</li>
<li>MySQL的表级锁有两种模式：<ul>
<li>表共享读锁（Table Read Lock）</li>
<li>表独占写锁（Table Write Lock）</li>
</ul>
</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5655870ace82d810473b8804a715db92.png" alt="image-20200805154049814"></p>
<p><strong>结论：</strong>结合上表，所以对MyISAM表进行操作，会有以下情况：</p>
<ol>
<li>对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</li>
<li>对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作</li>
<li>简而言之，<strong>就是读锁会阻塞写，但是不会堵塞读。而写锁则会把读和写都堵塞。</strong></li>
</ol>
<h4 id="2-2、表锁分析"><a href="#2-2、表锁分析" class="headerlink" title="2.2、表锁分析"></a>2.2、表锁分析</h4><blockquote>
<p><strong>表锁分析</strong></p>
</blockquote>
<ul>
<li>查看哪些表被锁了，0 表示未锁，1 表示被锁</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show open tables;</code></pre>
<p>【如何分析表锁定】可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定，通过 <code>show status like 'table%';</code> 命令查看</p>
<ol>
<li><strong>Table_locks_immediate：</strong>产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1；</li>
<li><strong>Table_locks_waited：</strong>出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在着较严重的表级锁争用情况；</li>
</ol>
<ul>
<li>此外，Myisam的读写锁调度是写优先，这也是myisam不适合做写为主表的引擎。因为写锁后，其他线程不能做任何操作，<strong>大量的更新会使查询很难得到锁</strong>，从而造成永远阻塞</li>
</ul>
<h3 id="3、行锁"><a href="#3、行锁" class="headerlink" title="3、行锁"></a>3、行锁</h3><blockquote>
<p><strong>行锁的特点</strong></p>
</blockquote>
<ol>
<li><strong>偏向InnoDB存储引擎</strong>，开销大，加锁慢；会出现死锁；<strong>锁定粒度最小，发生锁冲突的概率最低，并发度也最高</strong>。</li>
<li>InnoDB与MyISAM的最大不同有两点：<strong>一是支持事务（TRANSACTION）；二是采用了行级锁</strong></li>
</ol>
<h4 id="3-1、事务复习"><a href="#3-1、事务复习" class="headerlink" title="3.1、事务复习"></a>3.1、事务复习</h4><blockquote>
<p><strong>行锁支持事务，复习下老知识</strong></p>
</blockquote>
<p><strong>事务（Transation）及其ACID属性</strong></p>
<p>事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。</p>
<ol>
<li><strong>原子性</strong>（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</li>
<li><strong>一致性</strong>（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</li>
<li><strong>隔离性</strong>（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li>
<li><strong>持久性</strong>（Durability）：事务院成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li>
</ol>
<p><strong>并发事务处理带来的问题</strong></p>
<ol>
<li><strong>更新丢失</strong>（Lost Update）：<ul>
<li>当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题一一最后的更新覆盖了由其他事务所做的更新。</li>
<li>例如，两个程序员修改同一java文件。每程序员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改副本的编辑人员覆盖前一个程序员所做的更改。</li>
<li>如果在一个程序员完成并提交事务之前，另一个程序员不能访问同一文件，则可避免此问题。</li>
</ul>
</li>
<li><strong>脏读</strong>（Dirty Reads）：<ul>
<li>一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做”脏读”。</li>
<li>一句话：事务A读取到了事务B已修改但尚未提交的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取的数据无效，不符合一致性要求。</li>
</ul>
</li>
<li><strong>不可重复读</strong>（Non-Repeatable Reads）：<ul>
<li>一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了！这种现象就叫做“不可重复读”。</li>
<li>一句话：事务A读取到了事务B已经提交的修改数据，不符合隔离性</li>
</ul>
</li>
<li><strong>幻读</strong>（Phantom Reads）<ul>
<li>一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读一句话：事务A读取到了事务B体提交的新增数据，不符合隔离性。</li>
<li>多说一句：幻读和脏读有点类似，脏读是事务B里面修改了数据，幻读是事务B里面新增了数据。</li>
</ul>
</li>
</ol>
<p><strong>事物的隔离级别</strong></p>
<ol>
<li>脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。</li>
<li>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上“串行化”进行，这显然与“并发”是矛盾的。</li>
<li>同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。</li>
<li>查看当前数据库的事务隔离级别：<code>show variables like 'tx_isolation';</code> mysql 默认是可重复读</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/762c292ec819d23175d4974181676a2a.png" alt="image-20200805155415247"></p>
<h4 id="3-2、行锁案例"><a href="#3-2、行锁案例" class="headerlink" title="3.2、行锁案例"></a>3.2、行锁案例</h4><blockquote>
<p><strong>行锁案例分析</strong></p>
</blockquote>
<p><strong>创建表</strong></p>
<ul>
<li>建表 SQL</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_innodb_lock <span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">b</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'b2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'4000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'5000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'6000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'7000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'9000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'b1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> test_innodb_a_ind <span class="token keyword">ON</span> test_innodb_lock<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> test_innodb_lock_b_ind <span class="token keyword">ON</span> test_innodb_lock<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>操作同一行数据</strong></p>
</blockquote>
<ul>
<li>session1 开启事务，修改 test_innodb_lock 中的数据，但是不先提交</li>
<li>session1可以读到</li>
<li>session2读不到</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='4001' where a=4;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
</code></pre><ul>
<li>session2 开启事务，修改 test_innodb_lock 中同一行数据，将导致 session2 发生阻塞，一旦 session1 提交事务，session2 将执行更新操作</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='4002' where a=4;
# 在这儿阻塞着呢~~~

# 时间太长，会报超时错误哦
mysql&gt; update test_innodb_lock set b='4001' where a=4;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</code></pre><blockquote>
<p><strong>操作不同行数据</strong></p>
</blockquote>
<ul>
<li>session1 开启事务，修改 test_innodb_lock 中的数据</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='4001' where a=4;
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0</code></pre><ul>
<li>session2 开启事务，修改 test_innodb_lock 中不同行的数据</li>
<li>由于采用行锁，session2 和 session1 互不干涉，所以 session2 中的修改操作没有阻塞</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='9001' where a=9;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0</code></pre><blockquote>
<p><strong>无索引导致行锁升级为表锁</strong></p>
</blockquote>
<ul>
<li>session1 开启事务，修改 test_innodb_lock 中的数据，varchar 不用 ’ ’ ，导致系统自动转换类型，导致索引失效</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set a=44 where b=4000;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0</code></pre><ul>
<li>session2 开启事务，修改 test_innodb_lock 中不同行的数据</li>
<li>由于发生了自动类型转换，索引失效，导致行锁变为表锁</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='9001' where a=9;
# 在这儿阻塞着呢~~~</code></pre><h4 id="3-3、间隙锁"><a href="#3-3、间隙锁" class="headerlink" title="3.3、间隙锁"></a>3.3、间隙锁</h4><blockquote>
<p><strong>什么是间隙锁</strong></p>
</blockquote>
<ol>
<li>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP）”</li>
<li>InnoDB也会对这个“间隙”加锁，这种锁机制是所谓的间隙锁（Next-Key锁）</li>
</ol>
<p><strong>间隙锁的危害</strong></p>
<ol>
<li>因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。</li>
<li>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</li>
</ol>
<p><strong>间隙锁示例</strong></p>
<ul>
<li>test_innodb_lock 表中的数据</li>
</ul>
<pre><code>mysql&gt; select * from test_innodb_lock;
+------+------+
| a    | b    |
+------+------+
|    1 | b2   |
|    3 | 3    |
|    4 | 4000 |
|    5 | 5000 |
|    6 | 6000 |
|    7 | 7000 |
|    8 | 8000 |
|    9 | 9000 |
|    1 | b1   |
+------+------+
9 rows in set (0.00 sec)</code></pre><ul>
<li>session1 开启事务，执行修改 a &gt; 1 and a &lt; 6 的数据，这会导致 mysql 将 a = 2 的数据行锁住（虽然表中并没有这行数据）</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='Heygo' where a&gt;1 and a&lt;6;
Query OK, 3 rows affected (0.00 sec)
Rows matched: 3  Changed: 3  Warnings: 0</code></pre><ul>
<li>session2 开启事务，修改 test_innodb_lock 中不同行的数据，也会导致阻塞，直至 session1 提交事务</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; insert into test_innodb_lock values(2,'2000');
# 在这儿阻塞着呢~~~</code></pre><h4 id="3-4、手动行锁"><a href="#3-4、手动行锁" class="headerlink" title="3.4、手动行锁"></a>3.4、手动行锁</h4><blockquote>
<p><strong>如何锁定一行</strong></p>
</blockquote>
<ul>
<li><code>select xxx ... for update</code> 锁定某一行后，其它的操作会被阻塞，直到锁定行的会话提交</li>
<li>session1 开启事务，手动执行 for update 锁定指定行，待执行完指定操作时再将数据提交</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; select * from test_innodb_lock  where a=8 for update;
+------+------+
| a    | b    |
+------+------+
|    8 | 8000 |
+------+------+
1 row in set (0.00 sec)</code></pre><ul>
<li>session2 开启事务，修改 session1 中被锁定的行，会导致阻塞，直至 session1 提交事务</li>
</ul>
<pre><code>mysql&gt; set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update test_innodb_lock set b='XXX' where a=8;
# 在这儿阻塞着呢~~~</code></pre><h4 id="3-5、行锁分析"><a href="#3-5、行锁分析" class="headerlink" title="3.5、行锁分析"></a>3.5、行锁分析</h4><blockquote>
<p><strong>案例结论</strong></p>
</blockquote>
<ol>
<li>Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。</li>
<li><strong>当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势了</strong>。</li>
<li>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候（索引失效，导致行锁变表锁），可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</li>
</ol>
<blockquote>
<p><strong>行锁分析</strong></p>
</blockquote>
<p><strong>如何分析行锁定</strong></p>
<ul>
<li>通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况</li>
</ul>
<pre class=" language-mysql"><code class="language-mysql">show status like 'innodb_row_lock%';</code></pre>
<pre><code>mysql&gt; show status like 'innodb_row_lock%';
+-------------------------------+--------+
| Variable_name                 | Value  |
+-------------------------------+--------+
| Innodb_row_lock_current_waits | 0      |
| Innodb_row_lock_time          | 212969 |
| Innodb_row_lock_time_avg      | 42593  |
| Innodb_row_lock_time_max      | 51034  |
| Innodb_row_lock_waits         | 5      |
+-------------------------------+--------+
5 rows in set (0.00 sec)</code></pre><p><strong>对各个状态量的说明如下：</strong></p>
<ol>
<li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</li>
<li>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</li>
<li>Innodb_row_lock_time_avg：每次等待所花平均时间；</li>
<li>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</li>
<li>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</li>
</ol>
<p><strong>对于这5个状态变量，比较重要的主要是</strong></p>
<ol>
<li>Innodb_row_lock_time_avg（等待平均时长）</li>
<li>Innodb_row_lock_waits（等待总次数）</li>
<li>Innodb_row_lock_time（等待总时长）</li>
</ol>
<p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。</p>
<h4 id="3-6、行锁优化"><a href="#3-6、行锁优化" class="headerlink" title="3.6、行锁优化"></a>3.6、行锁优化</h4><blockquote>
<p><strong>优化建议</strong></p>
</blockquote>
<ol>
<li><p>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</p>
</li>
<li><p>合理设计索引，尽量缩小锁的范围</p>
</li>
<li><p>尽可能较少检索条件，避免间隙锁</p>
</li>
<li><p>尽量控制事务大小，减少锁定资源量和时间长度</p>
</li>
<li><p>尽可能低级别事务隔离</p>
</li>
</ol>
<h3 id="4、页锁"><a href="#4、页锁" class="headerlink" title="4、页锁"></a>4、页锁</h3><ol>
<li>开销和加锁时间界于表锁和行锁之间：会出现死锁；</li>
<li>锁定粒度界于表锁和行锁之间，并发度一般。</li>
<li>了解即可</li>
</ol>
<h2 id="第-6-章-主从复制"><a href="#第-6-章-主从复制" class="headerlink" title="第 6 章 主从复制"></a>第 6 章 主从复制</h2><h3 id="1、复制的基本原理"><a href="#1、复制的基本原理" class="headerlink" title="1、复制的基本原理"></a>1、复制的基本原理</h3><blockquote>
<p><strong>复制的基本原理</strong></p>
</blockquote>
<p><strong>slave会从master读取binlog来进行数据同步，主从复制的三步骤</strong></p>
<ol>
<li>master将改变记录到二进制日志（binary log）。这些记录过程叫做<strong>二进制日志事件</strong>（binary log events）</li>
<li>slave将master的binary log events拷贝到它的<strong>中继日志（relay log）</strong></li>
<li><strong>slave重做中继日志中的事件</strong>，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/img_convert/c21246f5720506676e51b872ab77b7ce.png" alt="image-20200805190201268"></p>
<h3 id="2、复制的基本原则"><a href="#2、复制的基本原则" class="headerlink" title="2、复制的基本原则"></a>2、复制的基本原则</h3><ol>
<li>每个slave只有一个master</li>
<li>每个slave只能有一个唯一的服务器ID</li>
<li>每个master可以有多个salve</li>
</ol>
<h3 id="3、复制最大问题"><a href="#3、复制最大问题" class="headerlink" title="3、复制最大问题"></a>3、复制最大问题</h3><p>因为发生多次 IO， 存在延时问题</p>
<h3 id="4、一主一从常见配置"><a href="#4、一主一从常见配置" class="headerlink" title="4、一主一从常见配置"></a>4、一主一从常见配置</h3><blockquote>
<p><strong>前提：mysql 版本一致，主从机在同一网段下</strong></p>
</blockquote>
<p><strong>ping 测试</strong></p>
<ul>
<li>Linux 中 ping Windows</li>
</ul>
<pre><code>[root@Heygo 桌面]# ping 10.206.207.131
PING 10.206.207.131 (10.206.207.131) 56(84) bytes of data.
64 bytes from 10.206.207.131: icmp_seq=1 ttl=128 time=1.27 ms
64 bytes from 10.206.207.131: icmp_seq=2 ttl=128 time=0.421 ms
64 bytes from 10.206.207.131: icmp_seq=3 ttl=128 time=1.12 ms
64 bytes from 10.206.207.131: icmp_seq=4 ttl=128 time=0.515 ms
^C
--- 10.206.207.131 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3719ms
rtt min/avg/max/mdev = 0.421/0.835/1.279/0.373 ms
[root@Heygo 桌面]# </code></pre><ul>
<li>Windows 中 ping Linux</li>
</ul>
<pre><code>C:\Users\Heygo&gt;ping 192.168.152.129

正在 Ping 192.168.152.129 具有 32 字节的数据:
来自 192.168.152.129 的回复: 字节=32 时间&lt;1ms TTL=64
来自 192.168.152.129 的回复: 字节=32 时间&lt;1ms TTL=64
来自 192.168.152.129 的回复: 字节=32 时间=1ms TTL=64
来自 192.168.152.129 的回复: 字节=32 时间&lt;1ms TTL=64

192.168.152.129 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 0ms，最长 = 1ms，平均 = 0ms</code></pre><blockquote>
<p><strong>主机修改 my.ini 配置文件（Windows）</strong></p>
</blockquote>
<p>主从都配置都在 [mysqld] 节点下，都是小写，以下是老师的配置文件</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6724f51a0ff16d8b1df9ab8d71190060.png" alt="image-20200812191912521"></p>
<p><strong>以下两条为必须配置</strong></p>
<ul>
<li>配置主机 id</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">server-id</span><span class="token attr-value"><span class="token punctuation">=</span>1</span></code></pre>
<ul>
<li>启用二进制日志</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">log-bin</span><span class="token attr-value"><span class="token punctuation">=</span>C:/Program Files (x86)/MySQL/MySQL Server 5.5/log-bin/mysqlbin</span>
1</code></pre>
<p><strong>以下为非必须配置</strong></p>
<ul>
<li>启动错误日志</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">log-err</span><span class="token attr-value"><span class="token punctuation">=</span>C:/Program Files (x86)/MySQL/MySQL Server 5.5/log-bin/mysqlerr</span></code></pre>
<ul>
<li>根目录</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">basedir</span><span class="token attr-value"><span class="token punctuation">=</span>"C:/Program Files (x86)/MySQL/MySQL Server 5.5/"</span></code></pre>
<ul>
<li>临时目录</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">tmpdir</span><span class="token attr-value"><span class="token punctuation">=</span>"C:/Program Files (x86)/MySQL/MySQL Server 5.5/"</span></code></pre>
<ul>
<li>数据目录</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">datadir</span><span class="token attr-value"><span class="token punctuation">=</span>"C:/Program Files (x86)/MySQL/MySQL Server 5.5/Data/"</span></code></pre>
<ul>
<li>主机，读写都可以</li>
</ul>
<pre class=" language-init"><code class="language-init">read-only=0</code></pre>
<ul>
<li>设置不要复制的数据库</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">binlog-ignore-db</span><span class="token attr-value"><span class="token punctuation">=</span>mysql</span></code></pre>
<ul>
<li>设置需要复制的数据</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">binlog-do-db</span><span class="token attr-value"><span class="token punctuation">=</span>需要复制的主数据库名字</span></code></pre>
<blockquote>
<p><strong>从机修改 my.cnf 配置文件（Linux）</strong></p>
</blockquote>
<ul>
<li>【必须】从服务器唯一ID</li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token constant">server-id</span><span class="token attr-value"><span class="token punctuation">=</span>2</span></code></pre>
<ul>
<li>【可选】启用二进制文件</li>
</ul>
<blockquote>
<p><strong>修改配置文件后的准备工作</strong></p>
</blockquote>
<p><strong>因修改过配置文件，主机+从机都重启 mysql 服务</strong></p>
<ul>
<li>Windows</li>
</ul>
<pre class=" language-bash"><code class="language-bash">net stop mysql
net start mysql</code></pre>
<ul>
<li>Linux</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> mysqld restart</code></pre>
<p><strong>主机从机都关闭防火墙</strong></p>
<ul>
<li>Windows 手动关闭防火墙</li>
<li>关闭虚拟机 linux 防火墙</li>
</ul>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> iptables stop</code></pre>
<blockquote>
<p><strong>在 Windows 主机上简历账户并授权 slave</strong></p>
</blockquote>
<ul>
<li>创建用户， 并赋予从机 <code>REPLICATION</code> 权限（从主机的数据库表中复制表）</li>
</ul>
<pre><code>GRANT REPLICATION SLAVE ON *.* TO '备份账号'@'从机器数据库 IP' IDENTIFIED BY '账号密码';</code></pre><pre><code>GRANT REPLICATION SLAVE ON *.* TO 'Heygo'@'192.168.152.129' IDENTIFIED BY '123456';</code></pre><ul>
<li>刷新权限信息</li>
</ul>
<pre class=" language-bash"><code class="language-bash">flush privileges<span class="token punctuation">;</span>

mysql<span class="token operator">></span> flush privileges<span class="token punctuation">;</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span></code></pre>
<ul>
<li>通过 <code>select * from mysql.user where user='Heygo'\G;</code> 命令可查看：从机只有 <code>Repl_slave_priv</code> 权限为 <code>Y</code>，其余权限均为 <code>N</code></li>
</ul>
<pre><code>mysql&gt; select * from mysql.user where user='Heygo'\G;
*************************** 1. row ***************************
                  Host: %
                  User: Heygo
              Password: *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9
           Select_priv: N
           Insert_priv: N
           Update_priv: N
           Delete_priv: N
           Create_priv: N
             Drop_priv: N
           Reload_priv: N
         Shutdown_priv: N
          Process_priv: N
             File_priv: N
            Grant_priv: N
       References_priv: N
            Index_priv: N
            Alter_priv: N
          Show_db_priv: N
            Super_priv: N
 Create_tmp_table_priv: N
      Lock_tables_priv: N
          Execute_priv: N
       Repl_slave_priv: Y
      Repl_client_priv: N
      Create_view_priv: N
        Show_view_priv: N
   Create_routine_priv: N
    Alter_routine_priv: N
      Create_user_priv: N
            Event_priv: N
          Trigger_priv: N
Create_tablespace_priv: N
              ssl_type:
            ssl_cipher:
           x509_issuer:
          x509_subject:
         max_questions: 0
           max_updates: 0
       max_connections: 0
  max_user_connections: 0
                plugin:
 authentication_string: NULL
1 row in set (0.00 sec)</code></pre><ul>
<li>查询 master 的状态，将 File 和 Position 记录下来，在启动 Slave 时需要用到这两个参数</li>
</ul>
<pre class=" language-bash"><code class="language-bash">show master status<span class="token punctuation">;</span></code></pre>
<pre><code>mysql&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      107 | mysql        |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.00 sec)</code></pre><blockquote>
<p><strong>在 Linux 从上验证是否能登陆主机的 MySQL</strong></p>
</blockquote>
<ul>
<li>在从机上执行 <code>mysql -h 10.206.207.131 -uHeygo -p</code> 命令，发现无法连接主机的 MySQL 数据库</li>
</ul>
<pre><code>[root@Heygo 桌面]# mysql -h 10.206.207.131 -uHeygo -p
Enter password: 
ERROR 1130 (HY000): Host 'windows10.microdone.cn' is not allowed to connect to this MySQL server</code></pre><ul>
<li>查阅资料发现：当你远程登录 MySQL 时，使用的账号要有特殊要求，如果要使用某个账号来远程登录，必须将账号的 host 属性值更改成 %。可以看到：我们在执行了 GRANT REPLICATION SLAVE ON <em>.</em> TO ‘Heygo’@’192.168.152.129’ IDENTIFIED BY ‘123456’; 命令之后，Heygo 账户的 host 属性为 192.168.152.129</li>
</ul>
<pre><code>mysql&gt; select user,host,plugin from user;
+-------+-----------------+--------+
| user  | host            | plugin |
+-------+-----------------+--------+
| root  | localhost       |        |
| root  | 192.168.152.129 |        |
| Heygo | 192.168.152.129 |        |
+-------+-----------------+--------+
3 rows in set (0.00 sec)</code></pre><ul>
<li>于是我先使用 <code>update user set host = '%' where user = 'Heygo';</code> 命令将 Heygo 账户的 <code>host</code> 字段设置为 <code>%</code>；然后使用 <code>flush privileges;</code> 命令刷新权限信息</li>
</ul>
<pre><code>mysql&gt; update user set host = '%' where user = 'Heygo';
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; select user,host,plugin from user;
+-------+-----------------+--------+
| user  | host            | plugin |
+-------+-----------------+--------+
| root  | localhost       |        |
| root  | 192.168.152.129 |        |
| Heygo | %               |        |
+-------+-----------------+--------+
3 rows in set (0.00 sec)</code></pre><ul>
<li>Linux 从机上使用 <code>mysql -h 10.206.207.131 -uHeygo -p</code> 命令能够成功连接上主机上的 MySQL 数据库。谜一样</li>
</ul>
<pre><code>[root@Heygo 桌面]# mysql -h 10.206.207.131 -uHeygo -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 33
Server version: 5.5.15-log MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</code></pre><blockquote>
<p><strong>在 Linux 从机上配置需要复制的主机</strong></p>
</blockquote>
<ul>
<li>从机进行认证</li>
</ul>
<pre><code>CHANGE MASTER TO 
MASTER_HOST='主机 IP',
MASTER_USER='创建用户名',
MASTER_PASSWORD='创建的密码',
MASTER_LOG_FILE='File 名字',
MASTER_LOG_POS=Position数字;</code></pre><pre><code>CHANGE MASTER TO 
MASTER_HOST='10.206.207.131',
MASTER_USER='Heygo',
MASTER_PASSWORD='123456',
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=107;</code></pre><ul>
<li>启动从服务器复制功能</li>
</ul>
<pre class=" language-bash"><code class="language-bash">start slave<span class="token punctuation">;</span></code></pre>
<ul>
<li>查看从机复制功能是否启动成功：使用 <code>show slave status\G;</code> 命令查看 <code>Slave_SQL_Running:Yes</code> 和 <code>Slave_IO_Running:Yes</code> 说明从机连接主机成功（第一次测试没有成功，这是隔了半年之后的测试，因此某些数据会有出入）</li>
</ul>
<pre><code>mysql&gt; show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.206.207.131
                  Master_User: Heygo
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000052
          Read_Master_Log_Pos: 4274
               Relay_Log_File: mysqld-relay-bin.000063
                Relay_Log_Pos: 2998
        Relay_Master_Log_File: mysql-bin.000052
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 4274
              Relay_Log_Space: 4749
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
                  Master_UUID: 
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
1 row in set (0.00 sec)</code></pre><ul>
<li>如何停止从服务复制功能</li>
</ul>
<pre class=" language-bash"><code class="language-bash">stop slave<span class="token punctuation">;</span></code></pre>
<h2 id="第-7-章-事务和ACID实现原理"><a href="#第-7-章-事务和ACID实现原理" class="headerlink" title="第 7 章 事务和ACID实现原理"></a>第 7 章 事务和ACID实现原理</h2><h3 id="1、什么是事务："><a href="#1、什么是事务：" class="headerlink" title="1、什么是事务："></a>1、什么是事务：</h3><p>数据库的事务是并发控制的基本单位，是指逻辑上的一组操作，要么全部执行，要么全部不执行。</p>
<h4 id="1、事务的特性："><a href="#1、事务的特性：" class="headerlink" title="1、事务的特性："></a>1、事务的特性：</h4><p>（1）原子性：事务是一个不可分割的工作单元，事务里的操作要么都成功，要么都失败，如果事务执行失败，则需要进行回滚。</p>
<p>（2）隔离性：事务的所操作的数据在提交之前，对其他事务的可见程度。</p>
<p>（3）持久性：一旦事务提交，它对数据库中数据的改变就是永久的。</p>
<p>（4）一致性：事务不能破坏数据的完整性和业务的一致性。例如在转账时，不管事务成功还是失败，双方钱的总额不变。</p>
<h3 id="2、事务ACID特性的实现原理："><a href="#2、事务ACID特性的实现原理：" class="headerlink" title="2、事务ACID特性的实现原理："></a>2、事务ACID特性的实现原理：</h3><h4 id="1、原子性："><a href="#1、原子性：" class="headerlink" title="1、原子性："></a><strong>1、原子性：</strong></h4><p>原子性是通过MySQL的回滚日志<code>undo log来</code>实现的：当事务对数据库进行修改时，InnoDB会生成对应的<code>undo log；</code>如果事务执行失败或调用了<code>rollback</code>，导致事务需要回滚，便可以利用<code>undo log</code>中的信息将数据回滚到修改之前的样子。</p>
<blockquote>
<p>undo log (回滚日志)：是采用段(segment)的方式来记录的，每个undo操作在记录的时候占用一个undo log segment。在数据更改操作时，记录了相对应的undo log的目的在于：</p>
<ul>
<li>保证数据的原子性，记录事务发生之前的一个版本，用于回滚；</li>
<li>通过mvcc + undo log实现Innodb事务可重复读和读已提交隔离级别。</li>
</ul>
</blockquote>
<h4 id="2、隔离性："><a href="#2、隔离性：" class="headerlink" title="2、隔离性："></a><strong>2、隔离性：</strong></h4><p>隔离性是事务所操作的数据在提交之前，对其他事务的可见程度。</p>
<p><strong>2.1、事务隔离级别：</strong></p>
<p>为保证在并发环境下读取数据的完整性和一致性，数据库提供了四种事务隔离级别，隔离级别越高，越能保证数据的完整性和一致性，但对高并发性能影响也越大，执行效率越低。（四种隔离级别从上往下依次升高）</p>
<blockquote>
<p>读未提交：允许事务在执行过程中，读取其他事务尚未提交的数据；</p>
<p>读已提交：允许事务在执行过程中读取其他事务已经提交的数据；</p>
<p>可重复读（默认级别）：在同一个事务内，任意时刻的查询结果都是一致的；</p>
<p>读序列化：所有事务逐个依次执行，每次读都需要获取表级共享锁，读写会相互阻塞。</p>
</blockquote>
<p><strong>2.2、如果不考虑事务的隔离性，在事务并发的环境下，可能存在问题有：</strong></p>
<p>（1）更新丢失：两个或多个事务操作相同的数据，然后基于选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题：最后的更新覆盖了其他事务所做的更新。</p>
<p>（2）脏读：指事务A正在访问数据，并且对数据进行了修改（事务未提交），这时，事务B也使用这个数据，后来事务A撤销回滚，并把修改后的数据恢复原值，B读到的数据就与数据库中的数据不一致，即B读到的数据是脏数据。</p>
<p>（3）不可重复读：在一个事务内，多次读取同一个数据，但是由于另一个事务在此期间对这个数据做了修改并提交，导致前后读取到的数据不一致；</p>
<p>（4）幻读：在一个事务中，先后两次进行读取相同的数据（一般是范围查询），但由于另一个事务新增或者删除了数据，导致前后两次结果不一致。</p>
<blockquote>
<p>① 不可重复读和幻读的区别：</p>
<p>不可重复读侧重于读取到其他事务修改的数据，幻读侧重于读取到其他事务新增或者删除的数据。</p>
<p>② 可以采用锁机制来解决不可重复读和幻读：</p>
<p>对于不可重复读，只需对操作的数据添加行级锁，防止操作的数据发生变化；而对于幻读，需要添加表级锁，将整张表锁定，防止新增或者删除数据。</p>
</blockquote>
<table>
<thead>
<tr>
<th>√：可能出现的情况 ×：不会出现该情况</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>读序列化</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td>可重复读</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>读已提交</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>读未提交</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
</tbody></table>
<p><strong>2.3、事务隔离性的实现原理：</strong></p>
<p>为了实现事务隔离，数据库延伸出了数据库锁，其中Innodb事务的隔离级别是由锁机制和MVVC(多版本并发控制)实现的：</p>
<p><strong>2.3.1、Mysql锁机制：</strong></p>
<p>MySQL锁机制的基本工作原理就是：事务在修改数据库之前，需要先获得相应的锁，获得锁的事务才可以修改数据；在该事务操作期间，这部分的数据是锁定，其他事务如果需要修改数据，需要等待当前事务提交或回滚后释放锁。</p>
<p>通过对InnoDB不同锁类型的特性分析，可以利用锁解决脏读、不可重复读、幻读：</p>
<blockquote>
<ul>
<li>排它锁解决脏读</li>
<li>共享锁解决不可重复读</li>
<li>临键锁解决幻读</li>
</ul>
</blockquote>
<p><strong>2.3.2、Multiversion concurrency control（MVCC 多版本并发控制）：</strong></p>
<p>InnoDB的MVCC是通过在每行记录后面保存两个隐藏的列来实现的，一个保存了行的事务ID（每次提交事务，事务ID会自增），一个保存了行的回滚段指针</p>
<p><img src="https://img-blog.csdnimg.cn/20201129161956864.png" alt="img"></p>
<p>每开始一个新的事务，都会自动递增产生一个新的事务ID。事务开始时刻会把该事务ID放到当前事务影响的行事务ID字段中，而 DB_ROLL_PTR 指向该行回滚段的指针，该行记录上的所有版本数据，都在undo log回滚日志中通过链表形式组织，所以该值实际指向undo log中该行的历史记录链表。</p>
<p>在并发访问数据库时，对正在事务中的数据做MVCC多版本的管理，以避免写操作阻塞读操作，并且可以通过比较版本解决幻读。</p>
<p>MVCC只在 可重复度 和 读已提交 两个隔离级别下才会工作，其中，MVCC实质就是通过保存数据在某个时间点的快照来实现的。 </p>
<blockquote>
<p><strong>快照读：</strong>Innodb快照读，数据的读取将由 cache(原本数据) + undo(事务修改前的数据) 两部分组成</p>
<p><strong>当前读：</strong>SQL读取的数据是最新版本。通过锁机制来保证读取的数据无法通过其他事务进行修改</p>
</blockquote>
<p>在可重复读的隔离级别下，MVCC具体操作：</p>
<blockquote>
<p>1）SELECT操作：InnoDB遵循以下两个规则：</p>
<p>只查找数据行的事务ID小于或等于当前事务ID的版本，这样可以确保事务读取的行，要么是在事务开始前已经存在的，要么是事务自身插入或者修改过的记录。<br>行的删除版本要未被定义，读取到事务开始之前状态的版本，这可以确保事务读取到的行，在事务开始之前未被删除。只有同时满足的两者的记录，才能返回作为查询结果。<br>（2）INSERT：InnoDB为新插入的每一行保存当前事务编号作为行版本号。</p>
<p>（3）DELETE：InnoDB为删除的每一行保存当前事务编号作为行删除标识。</p>
<p>（4）UPDATE：InnoDB为插入一行新记录，保存当前事务编号作为行版本号，同时保存当前事务编号到原来的行作为行删除标识。</p>
<p>保存这两个额外系统版本号，使大多数读操作都可以不用加锁。这样设计使得读数据操作很简单，性能很好，并且也能保证只会读取到符合标准的行，不足之处是每行记录都需要额外的存储空间，需要做更多的行检查工作，以及一些额外的维护工作。</p>
</blockquote>
<h4 id="3、持久性："><a href="#3、持久性：" class="headerlink" title="3、持久性："></a><strong>3、持久性：</strong></h4><p>持久性的实现关键在于redo log日志<code>，</code>在执行SQL时会保存已执行的SQL语句到一个指定的Log文件，当执行<code>recovery</code>时重新执行<code>redo log</code>记录的SQL操作。</p>
<p><strong>3.1、redo log日志：</strong></p>
<p>当向数据库写入数据时，执行过程会首先写入Buffer Pool，Buffer Pool中修改的数据会定期刷新到磁盘中（这一过程叫做刷盘），这整一过程称为redo log。redo log 分为：</p>
<p>Buffer Pool内存中的日志缓冲(redo log buffer)，该部分日志是易失性的；<br>磁盘上的重做日志文件(redo log file)，该部分日志是持久的。</p>
<h4 id="4、一致性："><a href="#4、一致性：" class="headerlink" title="4、一致性："></a><strong>4、一致性：</strong></h4><p>一致性指的是事务不能破坏数据的完整性和业务的一致性 ：</p>
<blockquote>
<ul>
<li>数据的完整性： 实体完整性、列完整性（如字段的类型、大小、长度要符合要求）、外键约束等</li>
<li>业务的一致性：例如在银行转账时，不管事务成功还是失败，双方钱的总额不变。</li>
</ul>
</blockquote>
<p>那是如何保证数据一致性的？其实数据一致性是通过事务的原子性、持久性和隔离性来保证的：</p>
<blockquote>
<p>原子性：语句要么全执行，要么全不执行，是事务最核心的特性，事务本身就是以原子性来定义的；主要基于undo log实现<br>持久性：保证事务提交后不会因为宕机等原因导致数据丢失；主要基于redo log实现<br>隔离性：保证事务执行尽可能不受其他事务影响；InnoDB默认的隔离级别是RR，RR的实现主要基于锁机制（包含next-key lock）、MVCC（包括数据的隐藏列、基于undo log的版本链、ReadView）</p>
</blockquote>
<h2 id="第-8-章-分区Partition"><a href="#第-8-章-分区Partition" class="headerlink" title="第 8 章 分区Partition"></a>第 8 章 分区Partition</h2><h3 id="一、分区："><a href="#一、分区：" class="headerlink" title="一、分区："></a>一、分区：</h3><p>分区就是将表的数据按照特定规则存放在不同的区域，也就是将表的数据文件分割成多个小块，在查询数据的时候，只要知道数据数据存储在哪些区域，然后直接在对应的区域进行查询，不需要对表数据进行全部的查询，提高查询的性能。同时，如果表数据特别大，一个磁盘磁盘放不下时，我们也可以将数据分配到不同的磁盘去，解决存储瓶颈的问题，利用多个磁盘，也能够提高磁盘的IO效率，提高数据库的性能。常见的分区类型有：Range分区、List分区、Hash分区、Key分区：</p>
<blockquote>
<p>（1）Range分区：按照连续的区间范围进行分区<br>（2）List分区：按照给定的集合中的值进行选择分区。<br>（3）Hash分区：基于用户定义的表达式的返回值进行分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL中有效的、产生非负整数值的任何表达式。<br>（4）Key分区：类似于按照HASH分区，区别在于Key分区只支持计算一列或多列，且key分区的哈希函数是由 MySQL 服务器提供。</p>
</blockquote>
<p><strong>1、表分区的优点：</strong></p>
<p>（1）可伸缩性：</p>
<blockquote>
<ul>
<li>将分区分在不同磁盘，可以解决单磁盘容量瓶颈问题，存储更多的数据，也能解决单磁盘的IO瓶颈问题。</li>
</ul>
</blockquote>
<p>（2）提升数据库的性能：</p>
<blockquote>
<ul>
<li>减少数据库检索时需要遍历的数据量，在查询时只需要在数据对应的分区进行查询。</li>
<li>避免Innodb的单个索引的互斥访问限制</li>
<li>对于聚合函数，例如sum()和count()，可以在每个分区进行并行处理，最终只需要统计所有分区得到的结果</li>
</ul>
</blockquote>
<p>（3）方便对数据进行运维管理：</p>
<blockquote>
<ul>
<li>方便管理，对于失去保存意义的数据，通过删除对应的分区，达到快速删除的作用。比如删除某一时间的历史数据，直接执行truncate，或者直接drop整个分区，这比detele删除效率更高；</li>
<li>在某些场景下，单个分区表的备份很恢复会更有效率。</li>
</ul>
</blockquote>
<p><strong>2、表分区的缺陷：</strong></p>
<p>（1）分区字段必须放主键或者唯一索引中；</p>
<p>（2）每个表最大分区数为1024；</p>
<p><strong>3、业务场景举例：</strong></p>
<p>（1）项目需要动态新建、删除分区。比如新闻表，按照时月份进行分区，同时为了防止新闻表过大，只保留最近6个月的分区，同时预建后面3个月的分区，这个删除、预建分区的过程就是分区表的动态管理。</p>
<p>（2）历史数据或不常访问的数据占很大部分，最新或热点数据占的比例不是很大，这时也可以进行表分区。</p>
<p><strong>4、MySQL分区类型：</strong></p>
<p>根据所使用的不同分区规则，可以分成几大分区类型： </p>
<table>
<thead>
<tr>
<th>序号</th>
<th>分区类型</th>
<th>说明</th>
<th>使用频率</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>RANGE 分区</td>
<td>按照连续的区间范围进行分区</td>
<td>较多</td>
</tr>
<tr>
<td>2</td>
<td>LIST 分区</td>
<td>按照给定的集合中的值进行选择分区</td>
<td>一般</td>
</tr>
<tr>
<td>3</td>
<td>HASH 分区</td>
<td>基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL中有效的、产生非负整数值的任何表达式。</td>
<td>较多</td>
</tr>
<tr>
<td>4</td>
<td>KEY 分区</td>
<td>类似于按照HASH分区，除了区别在于KEY分区只支持计算一列或多列，且KEY分区的哈希函数是由MySQL 服务器提供。</td>
<td>一般</td>
</tr>
</tbody></table>
<p><strong>（1）range分区：</strong></p>
<p>每个分区的值位于一个给定的连续区间内之内。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> RANGE <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">(</span>  

         <span class="token keyword">PARTITION</span> p0 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p1 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p2 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p3 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p4 <span class="token keyword">VALUES</span> LESS THAN MAXVALUE  

<span class="token punctuation">)</span><span class="token punctuation">;</span>  </code></pre>
<p><strong>（2）List分区：</strong></p>
<p>类似于按RANGE分区，区别在于LIST分区是基于列值匹配一个离散值集合中的某个值来进行选择。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> LIST <span class="token punctuation">(</span>province_id<span class="token punctuation">)</span> <span class="token punctuation">(</span>  

         <span class="token keyword">PARTITION</span> p0 <span class="token keyword">VALUES</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p1 <span class="token keyword">VALUES</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p2 <span class="token keyword">VALUES</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

         <span class="token keyword">PARTITION</span> p3 <span class="token keyword">VALUES</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span>  

 <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>（3）Hash分区：</p>
<p>基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL中有效的、产生非负整数值的任何表达式。<br>HASH分区主要用来确保数据在预先确定数目的分区中平均分布。在RANGE和LIST分区中，必须明确指定一个给定的列值或列值集合应该保存在哪个分区中。 </p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> foo_hash
<span class="token punctuation">(</span>empno <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>
empname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
deptno <span class="token keyword">int</span><span class="token punctuation">,</span>
birthdate <span class="token keyword">date</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
salary <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">hash</span><span class="token punctuation">(</span>year<span class="token punctuation">(</span>birthdate<span class="token punctuation">)</span><span class="token punctuation">)</span>
partitions <span class="token number">4</span><span class="token punctuation">;</span></code></pre>
<p>以上创建了4个分区。</p>
<p><strong>（4）Key分区：</strong></p>
<p>类似于按HASH分区，区别在于KEY分区只支持计算一列或多列，且MySQL服务器提供其自身的哈希函数。必须有一列或多列包含整数值。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> foo_key

<span class="token punctuation">(</span>empno <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>

empname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

deptno <span class="token keyword">int</span><span class="token punctuation">,</span>

birthdate <span class="token keyword">date</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>

salary <span class="token keyword">int</span>

<span class="token punctuation">)</span>

<span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">key</span><span class="token punctuation">(</span>birthdate<span class="token punctuation">)</span>

partitions <span class="token number">4</span><span class="token punctuation">;</span></code></pre>
<p><strong>（5）复合分区：</strong></p>
<p>子分区是针对 RANGE/LIST 类型的分区表中每个分区的再次分割。子分区可以是 HASH/KEY 等类型。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> RANGE <span class="token punctuation">(</span>uid<span class="token punctuation">)</span> SUBPARTITION <span class="token keyword">BY</span> <span class="token keyword">HASH</span> <span class="token punctuation">(</span>uid <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span> SUBPARTITIONS <span class="token number">2</span><span class="token punctuation">(</span>

     <span class="token keyword">PARTITION</span> p0 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">3000000</span><span class="token punctuation">)</span>

     <span class="token keyword">DATA</span> DIRECTORY <span class="token operator">=</span> <span class="token string">'/data0/data'</span>

     <span class="token keyword">INDEX</span> DIRECTORY <span class="token operator">=</span> <span class="token string">'/data1/idx'</span><span class="token punctuation">,</span>

     <span class="token keyword">PARTITION</span> p1 <span class="token keyword">VALUES</span> LESS THAN <span class="token punctuation">(</span><span class="token number">6000000</span><span class="token punctuation">)</span>

     <span class="token keyword">DATA</span> DIRECTORY <span class="token operator">=</span> <span class="token string">'/data2/data'</span>

     <span class="token keyword">INDEX</span> DIRECTORY <span class="token operator">=</span> <span class="token string">'/data3/idx'</span>

<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>以上例子，对 RANGE 分区再次进行子分区划分，子分区采用 HASH 类型。</p>
<h3 id="二、常见分区操作："><a href="#二、常见分区操作：" class="headerlink" title="二、常见分区操作："></a>二、常见分区操作：</h3><p><img src="https://img-blog.csdn.net/20161021204232167" alt="这里写图片描述"></p>
<h2 id="第-9-章-范式"><a href="#第-9-章-范式" class="headerlink" title="第 9 章 范式"></a>第 9 章 范式</h2><h3 id="1、1NF-第一范式-："><a href="#1、1NF-第一范式-：" class="headerlink" title="1、1NF(第一范式)："></a>1、1NF(第一范式)：</h3><p><code>第一范式，就是数据表的列不可再分</code>，数据库表中的每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性。</p>
<p>看下面数据表，对于选课列明显是可以再分的，所以它是违反第一范式的。</p>
<table>
<thead>
<tr>
<th align="left">学号</th>
<th align="left">姓名</th>
<th align="left">选课</th>
</tr>
</thead>
<tbody><tr>
<td align="left">10001</td>
<td align="left">张三</td>
<td align="left">数学，语文，英语</td>
</tr>
<tr>
<td align="left">10002</td>
<td align="left">李四</td>
<td align="left">语文，英语</td>
</tr>
<tr>
<td align="left">10003</td>
<td align="left">王五</td>
<td align="left">语文，英语，历史</td>
</tr>
</tbody></table>
<h3 id="2、2NF-第二范式-："><a href="#2、2NF-第二范式-：" class="headerlink" title="2、2NF(第二范式)："></a>2、2NF(第二范式)：</h3><p>第二范式必须先满足第一范式。另外包含两部分的内容：一是表必须有一个主键；二是表中非主键列必须完全依赖于主键，而不能只依赖于主键的一部分。</p>
<table>
<thead>
<tr>
<th>学号</th>
<th>课程</th>
<th>成绩</th>
<th>课程学分</th>
</tr>
</thead>
<tbody><tr>
<td>10001</td>
<td>数学</td>
<td>100</td>
<td>6</td>
</tr>
<tr>
<td>10001</td>
<td>语文</td>
<td>90</td>
<td>2</td>
</tr>
<tr>
<td>10001</td>
<td>英语</td>
<td>85</td>
<td>3</td>
</tr>
</tbody></table>
<p>表中主键为 （学号，课程），我们可以表示为 (学号，课程) -&gt; (成绩，课程学分)， 表示所有非主键列 (成绩，课程学分)都依赖于主键 (学号，课程)。 但是，表中还存在另外一个依赖：（课程）-&gt;(课程学分）。这样非主键列 ‘课程学分‘ 依赖于部分主键列 ’课程‘， 所以上表是不满足第二范式的。</p>
<p>我们把它拆成如下2张表：</p>
<p>学生选课表：</p>
<table>
<thead>
<tr>
<th>学号</th>
<th>课程</th>
<th>成绩</th>
</tr>
</thead>
<tbody><tr>
<td>10001</td>
<td>数学</td>
<td>100</td>
</tr>
<tr>
<td>10001</td>
<td>语文</td>
<td>90</td>
</tr>
<tr>
<td>10001</td>
<td>英语</td>
<td>85</td>
</tr>
</tbody></table>
<p>课程信息表：</p>
<table>
<thead>
<tr>
<th align="left">课程</th>
<th align="left">课程学分</th>
</tr>
</thead>
<tbody><tr>
<td align="left">数学</td>
<td align="left">6</td>
</tr>
<tr>
<td align="left">语文</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">英语</td>
<td align="left">2</td>
</tr>
</tbody></table>
<p>那么上面2个表，学生选课表主键为（学号，课程），课程信息表主键为（课程），表中所有非主键列都完全依赖主键。不仅符合第二范式，还符合第三范式。 </p>
<h3 id="3、3NF-第三范式-："><a href="#3、3NF-第三范式-：" class="headerlink" title="3、3NF(第三范式)："></a>3、3NF(第三范式)：</h3><p>定义：首先是满足 2NF，另外非主键列必须直接依赖于主键，表中的列不存在对非主键列的传递依赖。即不能存在：非主键列 A 依赖于非主键列 B，非主键列 B 依赖于主键的情况。</p>
<p>再看这样一个学生信息表：</p>
<table>
<thead>
<tr>
<th align="left">学号</th>
<th align="left">姓名</th>
<th align="left">性别</th>
<th align="left">班级</th>
<th align="left">班主任</th>
</tr>
</thead>
<tbody><tr>
<td align="left">10001</td>
<td align="left">张三</td>
<td align="left">男</td>
<td align="left">一班</td>
<td align="left">小王</td>
</tr>
<tr>
<td align="left">10002</td>
<td align="left">李四</td>
<td align="left">男</td>
<td align="left">一班</td>
<td align="left">小王</td>
</tr>
<tr>
<td align="left">10003</td>
<td align="left">王五</td>
<td align="left">男</td>
<td align="left">二班</td>
<td align="left">小李</td>
</tr>
</tbody></table>
<p>上表中，主键为：（学号），所有字段 （姓名，性别，班级，班主任）都依赖与主键（学号），不存在对主键的部分依赖。所以是满足第二范式。但是，表中存在一个传递依赖，(学号）-&gt;(班级）-&gt;（班主任）。也就是说，（班主任）这个非主键列依赖与另外一个非主键列 （班级）。所以不符号第三范式。</p>
<p>把这个表拆分成如下2个表：</p>
<p>学生信息表：</p>
<table>
<thead>
<tr>
<th align="left">学号</th>
<th align="left">姓名</th>
<th align="left">性别</th>
<th align="left">班级</th>
</tr>
</thead>
<tbody><tr>
<td align="left">10001</td>
<td align="left">张三</td>
<td align="left">男</td>
<td align="left">一班</td>
</tr>
<tr>
<td align="left">10002</td>
<td align="left">李四</td>
<td align="left">男</td>
<td align="left">一班</td>
</tr>
<tr>
<td align="left">10003</td>
<td align="left">王五</td>
<td align="left">男</td>
<td align="left">二班</td>
</tr>
</tbody></table>
<p>班级信息表：</p>
<table>
<thead>
<tr>
<th align="left">班级</th>
<th align="left">班主任</th>
</tr>
</thead>
<tbody><tr>
<td align="left">一班</td>
<td align="left">小王</td>
</tr>
<tr>
<td align="left">二班</td>
<td align="left">小李</td>
</tr>
</tbody></table>
<p>这样，对主键的传递依赖就消失了。上面的2个表都符合第3范式。</p>
<p>第二范式（2NF）和第三范式（3NF）的概念很容易混淆，区分它们的关键点在于，2NF：非主键列是否完全依赖于主键，还是依赖于主键的一部分；3NF：非主键列是直接依赖于主键，还是直接依赖于非主键列。</p>
<h3 id="4、BCNF-BC范式-："><a href="#4、BCNF-BC范式-：" class="headerlink" title="4、BCNF(BC范式)："></a>4、BCNF(BC范式)：</h3><p>定义：在第三范式的基础上，消除主属性对于码部分的传递依赖。</p>
<p>假设仓库管理关系表(仓库号，存储物品号，管理员号，数量)，满足一个管理员只在一个仓库工作；一个仓库可以存储多种物品，则存在如下关系：</p>
<p>(仓库号，存储物品号)——&gt;(管理员号，数量)</p>
<p>(管理员号，存储物品号)——&gt;(仓库号，数量)</p>
<p>所以，(仓库号，存储物品号)和(管理员号，存储物品号)都是仓库管理关系表的候选码，表中唯一非关键字段为数量，它是符合第三范式的。但是，由于存在如下决定关系：</p>
<p>(仓库号)——&gt;(管理员号)</p>
<p>(管理员号)——&gt;(仓库号)</p>
<p>即存在关键字段决定关键字段的情况，因此其不符合BCNF。把仓库管理关系表分解为两个关系表 仓库管理表(仓库号，管理员号) 和 仓库表(仓库号，存储物品号，数量)，这样这个数据库表是符合BCNF的，并消除了删除异常、插入异常和更新异常。</p>
<h3 id="5、4NF-第四范式-："><a href="#5、4NF-第四范式-：" class="headerlink" title="5、4NF(第四范式)："></a>5、4NF(第四范式)：</h3><p>设R是一个关系模型，D是R上的多值依赖集合。如果D中存在多值依赖X-&gt;Y时，X必是R的超键，那么称R是第四范式的模式。</p>
<p>例如，职工表(职工编号，职工孩子姓名，职工选修课程)，在这个表中，同一个职工可能会有多个职工孩子姓名，同样，同一个职工也可能会有多个职工选修课程，即这里存在着多值事实，不符合第四范式。如果要符合第四范式，只需要将上表分为两个表，使它们只有一个多值事实，例如职工表一(职工编号，职工孩子姓名)，职工表二(职工编号，职工选修课程)，两个表都只有一个多值事实，所以符合第四范式。</p>
<h2 id="第-10-章-分库分表"><a href="#第-10-章-分库分表" class="headerlink" title="第 10 章 分库分表"></a>第 10 章 分库分表</h2><h3 id="10-1-分库分表是什么"><a href="#10-1-分库分表是什么" class="headerlink" title="10.1 分库分表是什么"></a>10.1 分库分表是什么</h3><p>下边以电商系统中的例子来说明，下图是电商系统卖家模块的表结构：</p>
<p><img src="https://img-blog.csdnimg.cn/20190903073940867.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>通过以下SQL能够获取到商品相关的店铺信息、地理区域信息：</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token punctuation">[</span>地理区域名称<span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token punctuation">[</span>店铺名称<span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token punctuation">[</span>信誉<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>商品信息<span class="token punctuation">]</span> p 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>地理区域<span class="token punctuation">]</span> r <span class="token keyword">ON</span> p<span class="token punctuation">.</span><span class="token punctuation">[</span>产地<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token punctuation">[</span>地理区域编码<span class="token punctuation">]</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>店铺信息<span class="token punctuation">]</span> s <span class="token keyword">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token punctuation">[</span>所属店铺<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> ?</code></pre>
<p>随着公司业务快速发展，数据库中的数据量猛增，访问性能也变慢了，优化迫在眉睫。分析一下问题出现在哪儿呢？ 关系型数据库本身比较容易成为系统瓶颈，单机存储容量、连接数、处理能力都有限。当单表的数据量达到1000W或100G以后，由于查询维度较多，即使添加从库、优化索引，做很多操作时性能仍下降严重。</p>
<blockquote>
<p>方案1：</p>
</blockquote>
<p>通过提升服务器硬件能力来提高数据处理能力，比如增加存储容量 、CPU等，这种方案成本很高，并且如果瓶颈在MySQL本身那么提高硬件也是有很的。</p>
<blockquote>
<p>方案2：</p>
</blockquote>
<p>把数据分散在不同的数据库中，使得单一数据库的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的，如下图：将电商数据库拆分为若干独立的数据库，并且对于大表也拆分为若干小表，通过这种数据库拆分的方法来解决数据库的性能问题。</p>
<p><img src="https://img-blog.csdnimg.cn/2019090307403380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>分库分表就是为了解决由于数据量过大而导致数据库性能降低的问题，将原来独立的数据库拆分成若干数据库组成 ，将数据大表拆分成若干数据表组成，使得单一数据库、单一数据表的数据量变小，从而达到提升数据库性能的目的。</strong></p>
<h3 id="10-2-垂直分表"><a href="#10-2-垂直分表" class="headerlink" title="10.2 垂直分表"></a>10.2 垂直分表</h3><p>通常在商品列表中是不显示商品详情信息的，如下图：</p>
<p><img src="https://img-blog.csdnimg.cn/20190903074155957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>用户在浏览商品列表时，只有对某商品感兴趣时才会查看该商品的详细描述。因此，商品信息中商品描述字段访问频次较低，且该字段存储占用空间较大，访问单个数据IO时间较长；商品信息中商品名称、商品图片、商品价格等其他字段数据访问频次较高。</p>
<p>由于这两种数据的特性不一样，因此他考虑将商品信息表拆分如下：</p>
<p>将访问频次低的商品描述信息单独存放在一张表中，访问频次较高的商品基本信息单独放在一张表中。<br><img src="https://img-blog.csdnimg.cn/20190903074236479.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>商品列表可采用以下sql：</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token punctuation">[</span>地理区域名称<span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token punctuation">[</span>店铺名称<span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token punctuation">[</span>信誉<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>商品信息<span class="token punctuation">]</span> p 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>地理区域<span class="token punctuation">]</span> r <span class="token keyword">ON</span> p<span class="token punctuation">.</span><span class="token punctuation">[</span>产地<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token punctuation">[</span>地理区域编码<span class="token punctuation">]</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>店铺信息<span class="token punctuation">]</span> s <span class="token keyword">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token punctuation">[</span>所属店铺<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">LIMIT</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>需要获取商品描述时，再通过以下sql获取：</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>商品描述<span class="token punctuation">]</span> 
<span class="token keyword">WHERE</span> <span class="token punctuation">[</span>商品ID<span class="token punctuation">]</span> <span class="token operator">=</span> ?</code></pre>
<p><strong>垂直分表定义：将一个表按照字段分成多表，每个表存储其中一部分字段。</strong><br>它带来的提升是：</p>
<p>1.为了避免IO争抢并减少锁表的几率，查看详情的用户与商品信息浏览互不影响</p>
<p>2.充分发挥热门数据的操作效率，商品信息的操作的高效率不会被商品描述的低效率所拖累。</p>
<blockquote>
<p>为什么大字段IO效率低：第一是由于数据量本身大，需要更长的读取时间；第二是跨页，页是数据库存储单位，很多查找及定位操作都是以页为单位，单页内的数据行越多数据库整体性能越好，而大字段占用空间大，单页内存储行数少，因此IO效率较低。第三，数据库以行为单位将数据加载到内存中，这样表中字段长度较短且访问频率较高，内存能加载更多的数据，命中率更高，减少了磁盘IO，从而提升了数据库性能。</p>
</blockquote>
<p>一般来说，某业务实体中的各个数据项的访问频次是不一样的，部分数据项可能是占用存储空间比较大的BLOB或是TEXT。例如上例中的商品描述。所以，当表数据量很大时，可以将表按字段切开，将热门字段、冷门字段分开放置在不同库中，这些库可以放在不同的存储设备上，避免IO争抢。垂直切分带来的性能提升主要集中在热门数据的操作效率上，而且磁盘争用情况减少。</p>
<p>通常我们按以下原则进行垂直拆分:</p>
<ol>
<li>把不常用的字段单独放在一张表;</li>
<li>把text，blob等大字段拆分出来放在附表中;</li>
<li>经常组合查询的列放在一张表中;</li>
</ol>
<h3 id="10-3-垂直分库"><a href="#10-3-垂直分库" class="headerlink" title="10.3 垂直分库"></a>10.3 垂直分库</h3><p>通过垂直分表性能得到了一定程度的提升，但是还没有达到要求，并且磁盘空间也快不够了，因为数据还是始终限制在一台服务器，库内垂直分表只解决了单一表数据量过大的问题，但没有将表分布到不同的服务器上，因此每个表还是竞争同一个物理机的CPU、内存、网络IO、磁盘。</p>
<p>经过思考，把原有的SELLER_DB(卖家库)，分为了PRODUCT_DB(商品库)和STORE_DB(店铺库)，并把这两个库分散到不同服务器，如下图：<br><img src="https://img-blog.csdnimg.cn/20190903074403726.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>由于商品信息与商品描述业务耦合度较高，因此一起被存放在PRODUCT_DB(商品库)；而店铺信息相对独立，因此单独被存放在STORE_DB(店铺库)。</p>
<p><strong>垂直分库是指按照业务将表进行分类，分布到不同的数据库上面，每个库可以放在不同的服务器上，它的核心理念是专库专用。</strong></p>
<p>它带来的提升是：</p>
<ul>
<li>解决业务层面的耦合，业务清晰</li>
<li>能对不同业务的数据进行分级管理、维护、监控、扩展等</li>
<li>高并发场景下，垂直分库一定程度的提升IO、数据库连接数、降低单机硬件资源的瓶颈</li>
</ul>
<p>垂直分库通过将表按业务分类，然后分布在不同数据库，并且可以将这些数据库部署在不同服务器上，从而达到多个服务器共同分摊压力的效果，但是依然没有解决单表数据量过大的问题。</p>
<h3 id="10-4-水平分库"><a href="#10-4-水平分库" class="headerlink" title="10.4 水平分库"></a>10.4 水平分库</h3><p>经过垂直分库后，数据库性能问题得到一定程度的解决，但是随着业务量的增长，PRODUCT_DB(商品库)单库存储数据已经超出预估。粗略估计，目前有8w店铺，每个店铺平均150个不同规格的商品，再算上增长，那商品数量得往1500w+上预估，并且PRODUCT_DB(商品库)属于访问非常频繁的资源，单台服务器已经无法支撑。此时该如何优化？</p>
<p>再次分库？但是从业务角度分析，目前情况已经无法再次垂直分库。</p>
<p>尝试水平分库，将店铺ID为单数的和店铺ID为双数的商品信息分别放在两个库中。</p>
<p><img src="https://img-blog.csdnimg.cn/20190903074531453.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA2MjMzOQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>也就是说，要操作某条数据，先分析这条数据所属的店铺ID。如果店铺ID为双数，将此操作映射至RRODUCT_DB1(商品库1)；如果店铺ID为单数，将操作映射至RRODUCT_DB2(商品库2)。此操作要访问数据库名称的表达式为RRODUCT_DB[店铺ID%2 + 1] 。</p>
<p><strong>水平分库是把同一个表的数据按一定规则拆到不同的数据库中，每个库可以放在不同的服务器上。</strong></p>
<blockquote>
<p>垂直分库是把不同表拆到不同数据库中，它是对数据行的拆分，不影响表结构</p>
</blockquote>
<p>它带来的提升是：</p>
<ul>
<li>解决了单库大数据，高并发的性能瓶颈。</li>
<li>提高了系统的稳定性及可用性。</li>
</ul>
<blockquote>
<p>稳定性体现在IO冲突减少，锁定减少，可用性指某个库出问题，部分可用`</p>
</blockquote>
<p>当一个应用难以再细粒度的垂直切分，或切分后数据量行数巨大，存在单库读写、存储性能瓶颈，这时候就需要进行水平分库了，经过水平切分的优化，往往能解决单库存储量及性能瓶颈。但由于同一个表被分配在不同的数据库，需要额外进行数据操作的路由工作，因此大大提升了系统复杂度。</p>
<h3 id="10-5-水平分表"><a href="#10-5-水平分表" class="headerlink" title="10.5 水平分表"></a>10.5 水平分表</h3><p>按照水平分库的思路对他把PRODUCT_DB_X(商品库)内的表也可以进行水平拆分，其目的也是为解决单表数据量大的问题，如下图：</p>
<p>与水平分库的思路类似，不过这次操作的目标是表，商品信息及商品描述被分成了两套表。如果商品ID为双数，将此操作映射至商品信息1表；如果商品ID为单数，将操作映射至商品信息2表。此操作要访问表名称的表达式为商品信息[商品ID%2 + 1] 。</p>
<p><strong>水平分表是在同一个数据库内，把同一个表的数据按一定规则拆到多个表中。</strong></p>
<p>它带来的提升是：</p>
<ul>
<li>优化单一表数据量过大而产生的性能问题</li>
<li>避免IO争抢并减少锁表的几率</li>
</ul>
<p>库内的水平分表，解决了单一表数据量过大的问题，分出来的小表中只包含一部分数据，从而使得单个表的数据量变小，提高检索性能。</p>
<h3 id="10-6-总结"><a href="#10-6-总结" class="headerlink" title="10.6 总结"></a>10.6 总结</h3><p>垂直分表：可以把一个宽表的字段按访问频次、是否是大字段的原则拆分为多个表，这样既能使业务清晰，还能提升部分性能。拆分后，尽量从业务角度避免联查，否则性能方面将得不偿失。</p>
<p>垂直分库：可以把多个表按业务耦合松紧归类，分别存放在不同的库，这些库可以分布在不同服务器，从而使访问压力被多服务器负载，大大提升性能，同时能提高整体架构的业务清晰度，不同的业务库可根据自身情况定制优化方案。但是它需要解决跨库带来的所有复杂问题。</p>
<p>水平分库：可以把一个表的数据(按数据行)分到多个不同的库，每个库只有这个表的部分数据，这些库可以分布在不同服务器，从而使访问压力被多服务器负载，大大提升性能。它不仅需要解决跨库带来的所有复杂问题，还要解决数据路由的问题(数据路由问题后边介绍)。</p>
<p>水平分表：可以把一个表的数据(按数据行)分到多个同一个数据库的多张表中，每个表只有这个表的部分数据，这样做能小幅提升性能，它仅仅作为水平分库的一个补充优化。</p>
<p>一般来说，在系统设计阶段就应该根据业务耦合松紧来确定垂直分库，垂直分表方案，在数据量及访问压力不是特别大的情况，首先考虑缓存、读写分离、索引技术等方案。若数据量极大，且持续增长，再考虑水平分库水平分表方案。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://yuimm.github.io" rel="external nofollow noreferrer">Yuimm</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://yuimm.github.io/posts/mysql-you-hua.html">http://yuimm.github.io/posts/mysql-you-hua.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="http://yuimm.github.io" target="_blank">Yuimm</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL/">
                                    <span class="chip bg-color">MySQL</span>
                                </a>
                            
                                <a href="/tags/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                    <span class="chip bg-color">关系型数据库</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/images/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/images/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/images/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '6iXKjsdIStH3v7Ek0hew4bQT-gzGzoHsz',
        appKey: 'C7ktvIMbLBmrtOWnjHIDJcIQ',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/rabbitmq.html">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/java.jpg" class="responsive-img" alt="RabbitMQ">
                        
                        <span class="card-title">RabbitMQ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            RabbitMQ。-------------------------------------------------
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-04-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">
                                    分布式中间件
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">消息中间件</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/dui-xiang-shi-li-hua-nei-cun-bu-ju-yu-fang-wen-ding-wei.html">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/java.jpg" class="responsive-img" alt="对象实例化内存布局与访问定位">
                        
                        <span class="card-title">对象实例化内存布局与访问定位</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            jVM虚拟机。----------------------------------------------------
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JVM/" class="post-category">
                                    JVM
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JAVA/">
                        <span class="chip bg-color">JAVA</span>
                    </a>
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('100')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Yuimm<br />'
            + '文章作者: Yuimm<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="http://yuimm.github.io" target="_blank">Yuimm</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">451.9k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "3";
                    var startDate = "30";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Yuimm" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="https://gitee.com/Yuimm" class="tooltipped" target="_blank" data-tooltip="Gitee: https://gitee.com/Yuimm" data-position="top" data-delay="50">
        <i class="fab fa-git"></i>
    </a>



    <a href="mailto:974288521@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/qq.jpg" class="tooltipped" target="_blank" data-tooltip="QQ联系我: https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/qq.jpg" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_blog_picture/posts/wechat.jpg" class="tooltipped" target="_blank" data-tooltip="微信联系我: " data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
    <!--文字点击-->
    <!-- <script src="/js/click_show_text.js"></script> -->
    <!--鼠标点击烟花特效-->
   <!--  <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/firework.js"></script> -->


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/background/ribbon.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/Yuimm/yuimm_CDN@V1.0.1/source/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
